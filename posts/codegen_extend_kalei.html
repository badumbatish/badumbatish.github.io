<!DOCTYPE html><!--bnnedZqVymGuo8gu_zfnO--><html lang="en" class="px-4 py-4"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/7385e8d9d3c5518f-s.p.ttf" as="font" crossorigin="" type="font/ttf"/><link rel="stylesheet" href="/_next/static/css/590f857817ae3d9a.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/8a287c41de7a8698.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-b2488ded99eca76e.js"/><script src="/_next/static/chunks/4bd1b696-cf72ae8a39fa05aa.js" async=""></script><script src="/_next/static/chunks/964-05defa3e0b8af640.js" async=""></script><script src="/_next/static/chunks/main-app-98bd3314d8e089b7.js" async=""></script><script src="/_next/static/chunks/874-437a265a67d6cfee.js" async=""></script><script src="/_next/static/chunks/app/posts/%5Bid%5D/page-40c736743e813852.js" async=""></script><script src="/_next/static/chunks/app/layout-6c77c7f0e287af25.js" async=""></script><meta name="next-size-adjust" content=""/><title>[ONGOING] Extending LLVM&#x27;s Kaleidoscope: Code-gen edition</title><meta name="description" content="Jasmine extends her language with string, tuple, if-else codegen, closures and generics"/><link rel="icon" href="/_next/static/media/pfp6.723cdd8c.png"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__className_d4e0c8 flex flex-col min-h-screen"><div hidden=""><!--$--><!--/$--></div><a href="/"><div class="flex justify-center items-center py-4 "><h1 class="text-4xl font-bold">Jasmine Tang</h1></div></a><div class="flex-1"><div class="relative"><div class="py-12 flex flex-col items-center  justify-items-start mx-auto "><a class="flex justify-center text-4xl" href="/blog"><h2>My blog</h2></a><article class="p-8 prose pt-0.5 max-w-none w-full lg:w-1/2 md:w-4/6 sm:w-5/6 prose-sky mx-auto"><div class="flex justify-center text-2xl font-bold "><h2>[ONGOING] Extending LLVM&#x27;s Kaleidoscope: Code-gen edition</h2></div><div class="flex justify-start text-xl font-bold underline"><h4>8888-08-08</h4></div><div><nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#prologue">Prologue</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#introduction">Introduction</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#codegening">Codegening</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#allocation-of-the-stack-and-mem2reg">Alloca(tion of the stack) and mem2reg</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#variables">Variables</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#control-flow">Control flow</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#functions-and-extern-via-prototypeast">Functions and Extern (via PrototypeAST)</a><ol class="toc-level toc-level-3"><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#case-study-printf">Case study: printf</a></li></ol></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#arrays-and-bounds-checking-">Arrays and bounds checking :)</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#closures-and-2-different-ways-to-get-them-working">Closures and 2 different ways to get them working</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#todo-talk-about-the-general-structure">TODO: Talk about the general structure</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#generics">Generics</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#turning-on-optimizations">Turning on optimizations</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#epilogue">Epilogue</a><ol class="toc-level toc-level-3"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#remarks">Remarks</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#claude">Claude</a></li></ol></li></ol></li></ol></nav><h2 id="prologue"><a aria-hidden="true" tabindex="-1" href="#prologue"><span class="icon icon-link"></span></a>Prologue</h2>
<p>Hey everyone, how everyone's doing? I've graduated Berkeley and have been back at my parents' place for a while now,
getting
ready to start
Igalia :)
I'm still doing good hahhaa :)</p>
<p>I always thought getting back to OC after being far far away in Berkeley wonderland means that everything's gonna
change for me: I won't have to do homework anymore :) I'll go to bed early blabla bla; But here I am writing this
blog at 2 AM hahhaha. I realized that changing the environment doesn't necessarily change me personally; I'd need
to change myself on my own :) Being next to my family makes me really grateful, but now I'm starting to miss my
high school teacher as well as my nanny in Viet Nam. I really wanna go back soon :)</p>
<p>Anyways, let's talk business hahah :)
This article documents what I've learned about the basics of LLVM's code generation process, self-contained in
lowering from AST to LLVM-IR. This includes basic stack variables, addition, subtraction, etc etc to strings, structs
as well as garbage collection.</p>
<p>As is tradition, here are three songs for you by Zedd: <a href="https://youtu.be/HwtljkGZJnI?si=6kS1eXfN3DS7TokP" rel="nofollow" target="_blank">Papercut</a>,
<a href="https://youtu.be/ZqJiXLJs_Pg?si=P8as3-nXevZ3BfuA" rel="nofollow" target="_blank">Addicted To A Memory</a>, and
<a href="https://youtu.be/BjsjIkSb0cM?si=rNyI9JeS6N5r1NFc" rel="nofollow" target="_blank">Done With Love</a>. All
three songs showcase extremely well the emotional depth of a person in and out of love.</p>
<p>I hope you enjoy the songs (and the blog post as well!) :)</p>
<h2 id="introduction"><a aria-hidden="true" tabindex="-1" href="#introduction"><span class="icon icon-link"></span></a>Introduction</h2>
<p>Codegen in LLVM is an extremely well-thought-out process. For a simple stack-centric codegen
process, the framework
users
can abstract away SSA form; the <strong>alloca</strong> process together with mem2reg allows an
extremely fast assembly generation even for primitive stack allocations.</p>
<p>In this article, I'll report on the codegen process of sammine-lang, an extension on the kaleidoscope tutorial.
Besides code generation for scalar values, funcitons and control flow, the article also touches on code gen for
aggregated data types such as structs :) I hope everyone enjoys :)</p>
<p>The below picture demonstrates sammine's ability to generate code for fibonacci, a classic mathematical problem :)
[TODO: show that sammine can indeed code fibonacci and output assembly for it]</p>
<p>Aggregated datatype's also generated with sammine:
[TODO: show that sammine can indeed code record]</p>
<h2 id="codegening"><a aria-hidden="true" tabindex="-1" href="#codegening"><span class="icon icon-link"></span></a>Codegening</h2>
<h3 id="allocation-of-the-stack-and-mem2reg"><a aria-hidden="true" tabindex="-1" href="#allocation-of-the-stack-and-mem2reg"><span class="icon icon-link"></span></a>Alloca(tion of the stack) and mem2reg</h3>
<p>todo talk about allocation of the stack, first draws out an example of the global var in llvm ir</p>
<h3 id="variables"><a aria-hidden="true" tabindex="-1" href="#variables"><span class="icon icon-link"></span></a>Variables</h3>
<p>Variable codegen (i32, i64, double)
discuss three modes:</p>
<ul>
<li>creation: in var def and the map that keeps it, this done using alloca</li>
<li>modification: in binary op =, this stores to address of alloca</li>
<li>read: this loads from address of alloca.</li>
</ul>
<p>todo: talks about in relation to the walk and visitor pattern</p>
<h3 id="control-flow"><a aria-hidden="true" tabindex="-1" href="#control-flow"><span class="icon icon-link"></span></a>Control flow</h3>
<p>discuss how alloca makes this easier.</p>
<h3 id="functions-and-extern-via-prototypeast"><a aria-hidden="true" tabindex="-1" href="#functions-and-extern-via-prototypeast"><span class="icon icon-link"></span></a>Functions and Extern (via PrototypeAST)</h3>
<p>todo: talk about a caveat that we need to allocate "alloca" addresses at the start of the function.
todo: relate to how strong the visitor pattern is</p>
<h4 id="case-study-printf"><a aria-hidden="true" tabindex="-1" href="#case-study-printf"><span class="icon icon-link"></span></a>Case study: printf</h4>
<p>Back in Berk, I sometimes would play <a href="https://www.factorio.com/" rel="nofollow" target="_blank">Factorio</a> in my free time. The game is intuitive
and interesting. But for some
reasons, the game really stresses me out. "Wait a minute, I love problem-solving, don't I? But I feel so stressed
trying to build the factory with these new science packs and these new different energy types." Now, in this summer
of 2025, when I'm writing my own compiler, I suddenly realize the reason. I love problem sovling, but I was solving
the wrong problems. I wasn't interested in trying to build and maintain factories. Rather, compiler always seems to have
a softer spot in my heart. That and blog writing, hence I'm writing this :)</p>
<p>Ah, I still don't know what I'm rambling
about. I guess what I'm trying to say is in that in my experience, while I enjoy problem-solving in general, it also
matters what type of problems I'm solving. Factorio, leaning hard into resource management and logistics, just isn't
my forte, which is creative expression (writing), coding and abstraction (compiler engineer). Maybe front-end
and/or back-end
development
isn't what you love,
then you
should consider switching to compiler engineering, ahhahahha :P</p>
<p>Anyways, let's now talk about the
lowering of printing..</p>
<p>Right now, in sammine, I'm adopting a python-esque way of printing:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="plaintext" data-theme="github-dark-dimmed"><code data-language="plaintext" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span>print(x);  # x and y are variables in this case</span></span>
<span data-line=""><span>println(y);</span></span>
<span data-line=""><span>println(2.4 + 5.3); # printing should also support expressions</span></span><button type="button" title="Copy code" aria-label="Copy code" data="print(x);  # x and y are variables in this case
println(y);
println(2.4 + 5.3); # printing should also support expressions" class="rehype-pretty-copy" onclick="navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(&#x27;rehype-pretty-copied&#x27;);window.setTimeout(() => this.classList.remove(&#x27;rehype-pretty-copied&#x27;), 3000);"><span class="ready"></span><span class="success"></span></button><style>:root {--copy-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E");--success-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);& span {width: 100%;aspect-ratio: 1 / 1;}& .ready {background-image: var(--copy-icon);}& .success {display: none; background-image: var(--success-icon);}}&.rehype-pretty-copied {& .success {display: block;} & .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;& .ready { display: none; }& .success { display: block; }}</style></code></pre></figure>
<p>With int and double powered by alloca, how should we go around lowering this?</p>
<p>We know that in libc, the signature for printf() is bla bla bla hahaha</p>
<ul>
<li>print(2)</li>
<li>print("x")</li>
<li>println(2.4)</li>
</ul>
<p>What we'll do is, depending on the type via the AST, we'll access the</p>
<h3 id="arrays-and-bounds-checking-"><a aria-hidden="true" tabindex="-1" href="#arrays-and-bounds-checking-"><span class="icon icon-link"></span></a>Arrays and bounds checking :)</h3>
<h3 id="closures-and-2-different-ways-to-get-them-working"><a aria-hidden="true" tabindex="-1" href="#closures-and-2-different-ways-to-get-them-working"><span class="icon icon-link"></span></a>Closures and 2 different ways to get them working</h3>
<h2 id="todo-talk-about-the-general-structure"><a aria-hidden="true" tabindex="-1" href="#todo-talk-about-the-general-structure"><span class="icon icon-link"></span></a>TODO: Talk about the general structure</h2>
<p>sammine-lang Module Interface Files (.mni) and Name Mangling</p>
<p>The Problem</p>
<p>When compiling modules separately, the importing module needs to know what symbols a library exports — their names, parameter types, and return types. At link time, the linker needs a way to avoid
symbol collisions between modules that define functions with the same name.</p>
<p>The Mangling Scheme</p>
<p>sammine-lang uses a simple module<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>m</mi><mi>a</mi><mi>n</mi><mi>g</mi><mi>l</mi><mi>i</mi><mi>n</mi><mi>g</mi><mi>c</mi><mi>o</mi><mi>n</mi><mi>v</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi mathvariant="normal">.</mi><mi>A</mi><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mi>a</mi><mi>d</mi><mi>d</mi><mi>i</mi><mi>n</mi><mi>m</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>l</mi><mi>e</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi><mi>b</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>m</mi><mi>e</mi><mi>s</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">function mangling convention. A function add in module math becomes math</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">nman</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">in</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">co</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord">.</span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">na</span><span class="mord mathnormal">dd</span><span class="mord mathnormal">inm</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">t</span><span class="mord mathnormal">hb</span><span class="mord mathnormal">eco</span><span class="mord mathnormal">m</span><span class="mord mathnormal">es</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></span></span></span>add at the LLVM IR / object file level.</p>
<p>The $ separator was chosen because it's valid in LLVM symbol names but not a legal character in sammine identifiers, so collisions are impossible.</p>
<p>Interface Files (.mni)</p>
<p>When you compile a library module (any .mn file without a main), the compiler emits a .mni file alongside the .o. The .mni file is plain sammine source — a list of extern declarations using the
mangled names.</p>
<p>For example, given math.mn:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="plaintext" data-theme="github-dark-dimmed"><code data-language="plaintext" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span>let add(a: i32, b: i32) -> i32 {</span></span>
<span data-line=""><span>a + b</span></span>
<span data-line=""><span>}</span></span>
<span data-line=""> </span>
<span data-line=""><span>let multiply(a: i32, b: i32) -> i32 {</span></span>
<span data-line=""><span>a * b</span></span>
<span data-line=""><span>}</span></span><button type="button" title="Copy code" aria-label="Copy code" data="let add(a: i32, b: i32) -> i32 {
a + b
}

let multiply(a: i32, b: i32) -> i32 {
a * b
}" class="rehype-pretty-copy" onclick="navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(&#x27;rehype-pretty-copied&#x27;);window.setTimeout(() => this.classList.remove(&#x27;rehype-pretty-copied&#x27;), 3000);"><span class="ready"></span><span class="success"></span></button><style>:root {--copy-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E");--success-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);& span {width: 100%;aspect-ratio: 1 / 1;}& .ready {background-image: var(--copy-icon);}& .success {display: none; background-image: var(--success-icon);}}&.rehype-pretty-copied {& .success {display: block;} & .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;& .ready { display: none; }& .success { display: block; }}</style></code></pre></figure>
<p>The compiler produces math.mni:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="plaintext" data-theme="github-dark-dimmed"><code data-language="plaintext" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span>extern math$add(a : i32, b : i32) -> i32;</span></span>
<span data-line=""><span>extern math$multiply(a : i32, b : i32) -> i32;</span></span><button type="button" title="Copy code" aria-label="Copy code" data="extern math$add(a : i32, b : i32) -> i32;
extern math$multiply(a : i32, b : i32) -> i32;" class="rehype-pretty-copy" onclick="navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(&#x27;rehype-pretty-copied&#x27;);window.setTimeout(() => this.classList.remove(&#x27;rehype-pretty-copied&#x27;), 3000);"><span class="ready"></span><span class="success"></span></button><style>:root {--copy-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E");--success-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);& span {width: 100%;aspect-ratio: 1 / 1;}& .ready {background-image: var(--copy-icon);}& .success {display: none; background-image: var(--success-icon);}}&.rehype-pretty-copied {& .success {display: block;} & .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;& .ready { display: none; }& .success { display: block; }}</style></code></pre></figure>
<p>Two kinds of definitions appear in .mni files:</p>
<ol>
<li>let functions — always emitted with the mangled name module$func.</li>
<li>Exposed C externs (extern C) — also emitted with the mangled name. At the LLVM level, an IFunc (indirect function) maps the mangled name back to the real C symbol, so the linker resolves it at
load time.</li>
</ol>
<p>main is never mangled — it keeps its name regardless of module.</p>
<p>How Imports Consume .mni Files</p>
<p>When the importing module encounters import math as m;, the compiler:</p>
<ol>
<li>Locates math.mni — searches CWD, the source file's directory, then the stdlib directory.</li>
<li>Parses it as normal sammine source — the .mni is valid sammine (extern declarations), so it runs through the same Lexer → Parser pipeline.</li>
<li>Injects the extern declarations into the front of the importing module's AST, so they're visible during type checking and codegen.</li>
<li>Tracks math.o for linking — the corresponding object file is added to the link step.</li>
</ol>
<p>Alias Resolution at Parse Time</p>
<p>The parser maintains an alias_to_module map. When it sees import math as m;, it records {"m" → "math"}. Later, when it encounters a qualified call like m::add(3, 4):</p>
<ol>
<li>Looks up m in alias_to_module → finds "math".</li>
<li>Rewrites the identifier to math$add — the mangled name.</li>
<li>From this point on, the rest of the pipeline (type checker, codegen) sees math<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>d</mi><mi>d</mi><mo separator="true">,</mo><mi>w</mi><mi>h</mi><mi>i</mi><mi>c</mi><mi>h</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">add, which matches the extern math</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">dd</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">hi</span><span class="mord mathnormal">c</span><span class="mord mathnormal">hma</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">es</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">ee</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">nma</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></span></span></span>add(...) injected from the .mni file.</li>
</ol>
<p>If you write import math; (no alias), the module name itself becomes the alias, so math::add works the same way.</p>
<p>Codegen: Where Mangling Actually Happens</p>
<p>In FunctionCodegen.cpp, preorder_walk(PrototypeAST*) computes the LLVM symbol name:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="cpp" data-theme="github-dark-dimmed"><code data-language="cpp" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span style="color:#F69D50">std</span><span style="color:#ADBAC7">::string llvm_name </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> ast-</span><span style="color:#ADBAC7">></span><span style="color:#ADBAC7">functionName;</span></span>
<span data-line=""><span style="color:#F47067">if</span><span style="color:#ADBAC7"> </span><span style="color:#6cb6ff">(</span><span style="color:#F47067">!</span><span style="color:#ADBAC7">module_name.</span><span style="color:#DCBDFB">empty</span><span style="color:#6bc46d">(</span><span style="color:#6bc46d">)</span><span style="color:#ADBAC7"> </span><span style="color:#F47067">&#x26;&#x26;</span><span style="color:#ADBAC7"> ast-</span><span style="color:#ADBAC7">></span><span style="color:#ADBAC7">functionName </span><span style="color:#F47067">!=</span><span style="color:#96D0FF"> "main"</span><span style="color:#F47067"> &#x26;&#x26;</span><span style="color:#F47067"> !</span><span style="color:#ADBAC7">in_extern</span><span style="color:#6cb6ff">)</span></span>
<span data-line=""><span style="color:#ADBAC7">llvm_name </span><span style="color:#F47067">=</span><span style="color:#ADBAC7"> module_name </span><span style="color:#F47067">+</span><span style="color:#96D0FF"> "$"</span><span style="color:#F47067"> +</span><span style="color:#ADBAC7"> ast-</span><span style="color:#ADBAC7">></span><span style="color:#ADBAC7">functionName;</span></span><button type="button" title="Copy code" aria-label="Copy code" data="std::string llvm_name = ast->functionName;
if (!module_name.empty() &#x26;&#x26; ast->functionName != &#x22;main&#x22; &#x26;&#x26; !in_extern)
llvm_name = module_name + &#x22;$&#x22; + ast->functionName;" class="rehype-pretty-copy" onclick="navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(&#x27;rehype-pretty-copied&#x27;);window.setTimeout(() => this.classList.remove(&#x27;rehype-pretty-copied&#x27;), 3000);"><span class="ready"></span><span class="success"></span></button><style>:root {--copy-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E");--success-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);& span {width: 100%;aspect-ratio: 1 / 1;}& .ready {background-image: var(--copy-icon);}& .success {display: none; background-image: var(--success-icon);}}&.rehype-pretty-copied {& .success {display: block;} & .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;& .ready { display: none; }& .success { display: block; }}</style></code></pre></figure>
<p>The module_name is the file stem, passed to CgVisitor only when the file has no main (i.e., it's a library module). Executable modules get an empty module_name, so their functions aren't mangled.</p>
<p>For exposed C externs, the real C name is kept in the object file, and an LLVM IFunc redirects the mangled name to it:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="llvm" data-theme="github-dark-dimmed"><code data-language="llvm" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span style="color:#DCBDFB">@math$printf</span><span style="color:#ADBAC7"> = ifunc ..., ptr </span><span style="color:#DCBDFB">@resolve_math$printf</span></span>
<span data-line=""><span style="color:#F47067">define</span><span style="color:#F47067"> internal</span><span style="color:#ADBAC7"> ptr </span><span style="color:#DCBDFB">@resolve_math$printf</span><span style="color:#6cb6ff">(</span><span style="color:#6cb6ff">)</span><span style="color:#ADBAC7"> </span><span style="color:#6cb6ff">{</span><span style="color:#ADBAC7"> </span><span style="color:#F47067">ret</span><span style="color:#ADBAC7"> ptr </span><span style="color:#DCBDFB">@printf</span><span style="color:#ADBAC7"> </span><span style="color:#6cb6ff">}</span></span><button type="button" title="Copy code" aria-label="Copy code" data="@math$printf = ifunc ..., ptr @resolve_math$printf
define internal ptr @resolve_math$printf() { ret ptr @printf }" class="rehype-pretty-copy" onclick="navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(&#x27;rehype-pretty-copied&#x27;);window.setTimeout(() => this.classList.remove(&#x27;rehype-pretty-copied&#x27;), 3000);"><span class="ready"></span><span class="success"></span></button><style>:root {--copy-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E");--success-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);& span {width: 100%;aspect-ratio: 1 / 1;}& .ready {background-image: var(--copy-icon);}& .success {display: none; background-image: var(--success-icon);}}&.rehype-pretty-copied {& .success {display: block;} & .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;& .ready { display: none; }& .success { display: block; }}</style></code></pre></figure>
<p>End-to-End Example</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="bash" data-theme="github-dark-dimmed"><code data-language="bash" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span style="color:#768390"># Compile the library → produces math.o and math.mni</span></span>
<span data-line=""><span style="color:#F69D50">sammine</span><span style="color:#6CB6FF"> -f</span><span style="color:#96D0FF"> math.mn</span></span>
<span data-line=""> </span>
<span data-line=""><span style="color:#768390"># Compile the executable → reads math.mni, links math.o</span></span>
<span data-line=""><span style="color:#F69D50">sammine</span><span style="color:#6CB6FF"> -f</span><span style="color:#96D0FF"> main.mn</span></span><button type="button" title="Copy code" aria-label="Copy code" data="# Compile the library → produces math.o and math.mni
sammine -f math.mn

# Compile the executable → reads math.mni, links math.o
sammine -f main.mn" class="rehype-pretty-copy" onclick="navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(&#x27;rehype-pretty-copied&#x27;);window.setTimeout(() => this.classList.remove(&#x27;rehype-pretty-copied&#x27;), 3000);"><span class="ready"></span><span class="success"></span></button><style>:root {--copy-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E");--success-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);& span {width: 100%;aspect-ratio: 1 / 1;}& .ready {background-image: var(--copy-icon);}& .success {display: none; background-image: var(--success-icon);}}&.rehype-pretty-copied {& .success {display: block;} & .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;& .ready { display: none; }& .success { display: block; }}</style></code></pre></figure>
<p>main.mn:</p>
<figure data-rehype-pretty-code-figure=""><pre tabindex="0" data-language="plaintext" data-theme="github-dark-dimmed"><code data-language="plaintext" data-theme="github-dark-dimmed" style="display: grid;"><span data-line=""><span>import math as m;</span></span>
<span data-line=""><span>import std;</span></span>
<span data-line=""> </span>
<span data-line=""><span>let main() -> i32 {</span></span>
<span data-line=""><span>std::printf("%d\n", m::add(3, 4));</span></span>
<span data-line=""><span>return 0;</span></span>
<span data-line=""><span>}</span></span><button type="button" title="Copy code" aria-label="Copy code" data="import math as m;
import std;

let main() -> i32 {
std::printf(&#x22;%d\n&#x22;, m::add(3, 4));
return 0;
}" class="rehype-pretty-copy" onclick="navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(&#x27;rehype-pretty-copied&#x27;);window.setTimeout(() => this.classList.remove(&#x27;rehype-pretty-copied&#x27;), 3000);"><span class="ready"></span><span class="success"></span></button><style>:root {--copy-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E");--success-icon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);& span {width: 100%;aspect-ratio: 1 / 1;}& .ready {background-image: var(--copy-icon);}& .success {display: none; background-image: var(--success-icon);}}&.rehype-pretty-copied {& .success {display: block;} & .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;& .ready { display: none; }& .success { display: block; }}</style></code></pre></figure>
<p>The flow: m::add(3, 4) → parser rewrites to math<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>a</mi><mi>d</mi><mi>d</mi><mo stretchy="false">(</mo><mn>3</mn><mo separator="true">,</mo><mn>4</mn><mo stretchy="false">)</mo><mo>→</mo><mi>m</mi><mi>a</mi><mi>t</mi><mi>c</mi><mi>h</mi><mi>e</mi><mi>s</mi><mi>e</mi><mi>x</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>m</mi><mi>a</mi><mi>t</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">add(3, 4) → matches extern math</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal">dd</span><span class="mopen">(</span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">4</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">ma</span><span class="mord mathnormal">t</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord mathnormal">ese</span><span class="mord mathnormal">x</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal">nma</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span></span></span></span>add(...) from .mni → codegen emits a call to @math$add → linker resolves it from math.o.</p>
<hr>
<h3 id="generics"><a aria-hidden="true" tabindex="-1" href="#generics"><span class="icon icon-link"></span></a>Generics</h3>
<p>Initially I was unsure on where to put this part but I guess I can mention generics in both sections.</p>
<p>In shortness, when we generate code in the codegen phase, there won't be any generics anymore; the generics would've been dissolve
away by the type checker. For a generic of type T in function f, as in the following code, the typechecker sets the boolean of is_generic() to true
. Then when the type checker sees a call expr of f with a concrete type like i32, it literally creates another AST clone
of the function f, called f.i32 (this is called monomorphization).</p>
<p>When the codegen stage comes in, for a function ast, if its generic (via the boolean is_generic), then it won't generate code
for it. But if it's monomorphized (non-generic), then it goes ahead and generate the code for it normally :)</p>
<p>I'll have to reserve talking about the type checking aspect of generics here since the topic of the article is about
codegen :) But if you'd like to support me in pumping out articles faster, maybe you can <a href="https://ko-fi.com/badumbatish" rel="nofollow" target="_blank">buy me a redbull</a>? :)</p>
<h3 id="turning-on-optimizations"><a aria-hidden="true" tabindex="-1" href="#turning-on-optimizations"><span class="icon icon-link"></span></a>Turning on optimizations</h3>
<h1 id="epilogue"><a aria-hidden="true" tabindex="-1" href="#epilogue"><span class="icon icon-link"></span></a>Epilogue</h1>
<h2 id="remarks"><a aria-hidden="true" tabindex="-1" href="#remarks"><span class="icon icon-link"></span></a>Remarks</h2>
<p>The article, as you can tell, is directed towards new grads and/or beginners in LLVM. If you've benefited from the article
or if you'd like to support my writing these blogs, please consider <a href="">getting me a red bull</a> :)</p>
<p>I also want to extend my thanks to all the developers that helped contributed to the
Kaleidoscope. Without them, the journey to generate code, as well as the creation of this article, would be
ten-fold harder. I realize that we all stands on the shoulder of the previous generations and of giants and I would like to pay my tribute to them.</p>
<h2 id="claude"><a aria-hidden="true" tabindex="-1" href="#claude"><span class="icon icon-link"></span></a>Claude</h2>
<p>You'll realize that in this edition of extending kalei, a lot of work's been done. This is due to no small parts to Claude, allowing
me to loo</p></div></article></div></div><!--$--><!--/$--></div><div class="bottom-4 right-4 fixed flex flex-col gap-2"><button class="shadow-md"><div class="inline text-xl font-bold border-black border-2 rounded p-2 bg-white">⇣⇣</div></button></div><footer class="footer self-center justify-center gap-2 pt-4 items-center italic "><p>Built by Jasmine with NextJS, TailwindCSS, and a tonnn of loveee :)</p></footer><script src="/_next/static/chunks/webpack-b2488ded99eca76e.js" id="_R_" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[6874,[\"874\",\"static/chunks/874-437a265a67d6cfee.js\",\"880\",\"static/chunks/app/posts/%5Bid%5D/page-40c736743e813852.js\"],\"\"]\n3:I[7555,[],\"\"]\n4:I[1295,[],\"\"]\n5:I[7921,[\"874\",\"static/chunks/874-437a265a67d6cfee.js\",\"177\",\"static/chunks/app/layout-6c77c7f0e287af25.js\"],\"default\"]\n7:I[9665,[],\"OutletBoundary\"]\n9:I[4911,[],\"AsyncMetadataOutlet\"]\nb:I[9665,[],\"ViewportBoundary\"]\nd:I[9665,[],\"MetadataBoundary\"]\ne:\"$Sreact.suspense\"\n10:I[8393,[],\"\"]\n:HL[\"/_next/static/media/7385e8d9d3c5518f-s.p.ttf\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/ttf\"}]\n:HL[\"/_next/static/css/590f857817ae3d9a.css\",\"style\"]\n:HL[\"/_next/static/css/8a287c41de7a8698.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"bnnedZqVymGuo8gu-zfnO\",\"p\":\"\",\"c\":[\"\",\"posts\",\"codegen_extend_kalei\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"codegen_extend_kalei\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/590f857817ae3d9a.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"px-4 py-4\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_d4e0c8 flex flex-col min-h-screen\",\"children\":[[\"$\",\"$L2\",null,{\"href\":\"/\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex justify-center items-center py-4 \",\"children\":[\"$\",\"h1\",null,{\"className\":\"text-4xl font-bold\",\"children\":\"Jasmine Tang\"}]}]}],[\"$\",\"div\",null,{\"className\":\"flex-1\",\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],[]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"$L5\",null,{}],[\"$\",\"footer\",null,{\"className\":\"footer self-center justify-center gap-2 pt-4 items-center italic \",\"children\":[\"$\",\"p\",null,{\"children\":\"Built by Jasmine with NextJS, TailwindCSS, and a tonnn of loveee :)\"}]}]]}]}]]}],{\"children\":[\"posts\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"id\",\"codegen_extend_kalei\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L6\",[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/8a287c41de7a8698.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L7\",null,{\"children\":[\"$L8\",[\"$\",\"$L9\",null,{\"promise\":\"$@a\"}]]}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]],[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"div\",null,{\"hidden\":true,\"children\":[\"$\",\"$e\",null,{\"fallback\":null,\"children\":\"$Lf\"}]}]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$10\",[]],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"meta\",\"1\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n8:null\n"])</script><script>self.__next_f.push([1,"13:I[8175,[],\"IconMark\"]\n11:T9dac,"])</script><script>self.__next_f.push([1,"\u003cnav class=\"toc\"\u003e\u003col class=\"toc-level toc-level-1\"\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#prologue\"\u003ePrologue\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#introduction\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#codegening\"\u003eCodegening\u003c/a\u003e\u003col class=\"toc-level toc-level-2\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#allocation-of-the-stack-and-mem2reg\"\u003eAlloca(tion of the stack) and mem2reg\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#variables\"\u003eVariables\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#control-flow\"\u003eControl flow\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#functions-and-extern-via-prototypeast\"\u003eFunctions and Extern (via PrototypeAST)\u003c/a\u003e\u003col class=\"toc-level toc-level-3\"\u003e\u003cli class=\"toc-item toc-item-h4\"\u003e\u003ca class=\"toc-link toc-link-h4\" href=\"#case-study-printf\"\u003eCase study: printf\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#arrays-and-bounds-checking-\"\u003eArrays and bounds checking :)\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#closures-and-2-different-ways-to-get-them-working\"\u003eClosures and 2 different ways to get them working\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#todo-talk-about-the-general-structure\"\u003eTODO: Talk about the general structure\u003c/a\u003e\u003col class=\"toc-level toc-level-2\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#generics\"\u003eGenerics\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#turning-on-optimizations\"\u003eTurning on optimizations\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h1\"\u003e\u003ca class=\"toc-link toc-link-h1\" href=\"#epilogue\"\u003eEpilogue\u003c/a\u003e\u003col class=\"toc-level toc-level-3\"\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#remarks\"\u003eRemarks\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#claude\"\u003eClaude\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/nav\u003e\u003ch2 id=\"prologue\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#prologue\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003ePrologue\u003c/h2\u003e\n\u003cp\u003eHey everyone, how everyone's doing? I've graduated Berkeley and have been back at my parents' place for a while now,\ngetting\nready to start\nIgalia :)\nI'm still doing good hahhaa :)\u003c/p\u003e\n\u003cp\u003eI always thought getting back to OC after being far far away in Berkeley wonderland means that everything's gonna\nchange for me: I won't have to do homework anymore :) I'll go to bed early blabla bla; But here I am writing this\nblog at 2 AM hahhaha. I realized that changing the environment doesn't necessarily change me personally; I'd need\nto change myself on my own :) Being next to my family makes me really grateful, but now I'm starting to miss my\nhigh school teacher as well as my nanny in Viet Nam. I really wanna go back soon :)\u003c/p\u003e\n\u003cp\u003eAnyways, let's talk business hahah :)\nThis article documents what I've learned about the basics of LLVM's code generation process, self-contained in\nlowering from AST to LLVM-IR. This includes basic stack variables, addition, subtraction, etc etc to strings, structs\nas well as garbage collection.\u003c/p\u003e\n\u003cp\u003eAs is tradition, here are three songs for you by Zedd: \u003ca href=\"https://youtu.be/HwtljkGZJnI?si=6kS1eXfN3DS7TokP\" rel=\"nofollow\" target=\"_blank\"\u003ePapercut\u003c/a\u003e,\n\u003ca href=\"https://youtu.be/ZqJiXLJs_Pg?si=P8as3-nXevZ3BfuA\" rel=\"nofollow\" target=\"_blank\"\u003eAddicted To A Memory\u003c/a\u003e, and\n\u003ca href=\"https://youtu.be/BjsjIkSb0cM?si=rNyI9JeS6N5r1NFc\" rel=\"nofollow\" target=\"_blank\"\u003eDone With Love\u003c/a\u003e. All\nthree songs showcase extremely well the emotional depth of a person in and out of love.\u003c/p\u003e\n\u003cp\u003eI hope you enjoy the songs (and the blog post as well!) :)\u003c/p\u003e\n\u003ch2 id=\"introduction\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#introduction\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eCodegen in LLVM is an extremely well-thought-out process. For a simple stack-centric codegen\nprocess, the framework\nusers\ncan abstract away SSA form; the \u003cstrong\u003ealloca\u003c/strong\u003e process together with mem2reg allows an\nextremely fast assembly generation even for primitive stack allocations.\u003c/p\u003e\n\u003cp\u003eIn this article, I'll report on the codegen process of sammine-lang, an extension on the kaleidoscope tutorial.\nBesides code generation for scalar values, funcitons and control flow, the article also touches on code gen for\naggregated data types such as structs :) I hope everyone enjoys :)\u003c/p\u003e\n\u003cp\u003eThe below picture demonstrates sammine's ability to generate code for fibonacci, a classic mathematical problem :)\n[TODO: show that sammine can indeed code fibonacci and output assembly for it]\u003c/p\u003e\n\u003cp\u003eAggregated datatype's also generated with sammine:\n[TODO: show that sammine can indeed code record]\u003c/p\u003e\n\u003ch2 id=\"codegening\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#codegening\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eCodegening\u003c/h2\u003e\n\u003ch3 id=\"allocation-of-the-stack-and-mem2reg\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#allocation-of-the-stack-and-mem2reg\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eAlloca(tion of the stack) and mem2reg\u003c/h3\u003e\n\u003cp\u003etodo talk about allocation of the stack, first draws out an example of the global var in llvm ir\u003c/p\u003e\n\u003ch3 id=\"variables\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#variables\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eVariables\u003c/h3\u003e\n\u003cp\u003eVariable codegen (i32, i64, double)\ndiscuss three modes:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ecreation: in var def and the map that keeps it, this done using alloca\u003c/li\u003e\n\u003cli\u003emodification: in binary op =, this stores to address of alloca\u003c/li\u003e\n\u003cli\u003eread: this loads from address of alloca.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003etodo: talks about in relation to the walk and visitor pattern\u003c/p\u003e\n\u003ch3 id=\"control-flow\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#control-flow\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eControl flow\u003c/h3\u003e\n\u003cp\u003ediscuss how alloca makes this easier.\u003c/p\u003e\n\u003ch3 id=\"functions-and-extern-via-prototypeast\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#functions-and-extern-via-prototypeast\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eFunctions and Extern (via PrototypeAST)\u003c/h3\u003e\n\u003cp\u003etodo: talk about a caveat that we need to allocate \"alloca\" addresses at the start of the function.\ntodo: relate to how strong the visitor pattern is\u003c/p\u003e\n\u003ch4 id=\"case-study-printf\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#case-study-printf\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eCase study: printf\u003c/h4\u003e\n\u003cp\u003eBack in Berk, I sometimes would play \u003ca href=\"https://www.factorio.com/\" rel=\"nofollow\" target=\"_blank\"\u003eFactorio\u003c/a\u003e in my free time. The game is intuitive\nand interesting. But for some\nreasons, the game really stresses me out. \"Wait a minute, I love problem-solving, don't I? But I feel so stressed\ntrying to build the factory with these new science packs and these new different energy types.\" Now, in this summer\nof 2025, when I'm writing my own compiler, I suddenly realize the reason. I love problem sovling, but I was solving\nthe wrong problems. I wasn't interested in trying to build and maintain factories. Rather, compiler always seems to have\na softer spot in my heart. That and blog writing, hence I'm writing this :)\u003c/p\u003e\n\u003cp\u003eAh, I still don't know what I'm rambling\nabout. I guess what I'm trying to say is in that in my experience, while I enjoy problem-solving in general, it also\nmatters what type of problems I'm solving. Factorio, leaning hard into resource management and logistics, just isn't\nmy forte, which is creative expression (writing), coding and abstraction (compiler engineer). Maybe front-end\nand/or back-end\ndevelopment\nisn't what you love,\nthen you\nshould consider switching to compiler engineering, ahhahahha :P\u003c/p\u003e\n\u003cp\u003eAnyways, let's now talk about the\nlowering of printing..\u003c/p\u003e\n\u003cp\u003eRight now, in sammine, I'm adopting a python-esque way of printing:\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"\u003e\u003ccode data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan\u003eprint(x);  # x and y are variables in this case\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003eprintln(y);\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003eprintln(2.4 + 5.3); # printing should also support expressions\u003c/span\u003e\u003c/span\u003e\u003cbutton type=\"button\" title=\"Copy code\" aria-label=\"Copy code\" data=\"print(x);  # x and y are variables in this case\nprintln(y);\nprintln(2.4 + 5.3); # printing should also support expressions\" class=\"rehype-pretty-copy\" onclick=\"navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(\u0026#x27;rehype-pretty-copied\u0026#x27;);window.setTimeout(() =\u003e this.classList.remove(\u0026#x27;rehype-pretty-copied\u0026#x27;), 3000);\"\u003e\u003cspan class=\"ready\"\u003e\u003c/span\u003e\u003cspan class=\"success\"\u003e\u003c/span\u003e\u003c/button\u003e\u003cstyle\u003e:root {--copy-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E\");--success-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E\");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);\u0026 span {width: 100%;aspect-ratio: 1 / 1;}\u0026 .ready {background-image: var(--copy-icon);}\u0026 .success {display: none; background-image: var(--success-icon);}}\u0026.rehype-pretty-copied {\u0026 .success {display: block;} \u0026 .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;\u0026 .ready { display: none; }\u0026 .success { display: block; }}\u003c/style\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eWith int and double powered by alloca, how should we go around lowering this?\u003c/p\u003e\n\u003cp\u003eWe know that in libc, the signature for printf() is bla bla bla hahaha\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eprint(2)\u003c/li\u003e\n\u003cli\u003eprint(\"x\")\u003c/li\u003e\n\u003cli\u003eprintln(2.4)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWhat we'll do is, depending on the type via the AST, we'll access the\u003c/p\u003e\n\u003ch3 id=\"arrays-and-bounds-checking-\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#arrays-and-bounds-checking-\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eArrays and bounds checking :)\u003c/h3\u003e\n\u003ch3 id=\"closures-and-2-different-ways-to-get-them-working\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#closures-and-2-different-ways-to-get-them-working\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eClosures and 2 different ways to get them working\u003c/h3\u003e\n\u003ch2 id=\"todo-talk-about-the-general-structure\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#todo-talk-about-the-general-structure\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eTODO: Talk about the general structure\u003c/h2\u003e\n\u003cp\u003esammine-lang Module Interface Files (.mni) and Name Mangling\u003c/p\u003e\n\u003cp\u003eThe Problem\u003c/p\u003e\n\u003cp\u003eWhen compiling modules separately, the importing module needs to know what symbols a library exports — their names, parameter types, and return types. At link time, the linker needs a way to avoid\nsymbol collisions between modules that define functions with the same name.\u003c/p\u003e\n\u003cp\u003eThe Mangling Scheme\u003c/p\u003e\n\u003cp\u003esammine-lang uses a simple module\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003ef\u003c/mi\u003e\u003cmi\u003eu\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003eg\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003eg\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003ev\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi mathvariant=\"normal\"\u003e.\u003c/mi\u003e\u003cmi\u003eA\u003c/mi\u003e\u003cmi\u003ef\u003c/mi\u003e\u003cmi\u003eu\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003eu\u003c/mi\u003e\u003cmi\u003el\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003cmi\u003eb\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003eo\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003es\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003efunction mangling convention. A function add in module math becomes math\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\"\u003ef\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eu\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003en\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ec\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eo\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003enman\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.03588em;\"\u003eg\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ein\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.03588em;\"\u003eg\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eco\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003en\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.03588em;\"\u003ev\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ee\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003en\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eo\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003en\u003c/span\u003e\u003cspan class=\"mord\"\u003e.\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eA\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.10764em;\"\u003ef\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eu\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003en\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ec\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ei\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eo\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ena\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003edd\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003einm\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eo\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ed\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eu\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.01968em;\"\u003el\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ee\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ema\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ehb\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eeco\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003em\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ees\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ema\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eh\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003eadd at the LLVM IR / object file level.\u003c/p\u003e\n\u003cp\u003eThe $ separator was chosen because it's valid in LLVM symbol names but not a legal character in sammine identifiers, so collisions are impossible.\u003c/p\u003e\n\u003cp\u003eInterface Files (.mni)\u003c/p\u003e\n\u003cp\u003eWhen you compile a library module (any .mn file without a main), the compiler emits a .mni file alongside the .o. The .mni file is plain sammine source — a list of extern declarations using the\nmangled names.\u003c/p\u003e\n\u003cp\u003eFor example, given math.mn:\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"\u003e\u003ccode data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan\u003elet add(a: i32, b: i32) -\u003e i32 {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003ea + b\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003elet multiply(a: i32, b: i32) -\u003e i32 {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003ea * b\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbutton type=\"button\" title=\"Copy code\" aria-label=\"Copy code\" data=\"let add(a: i32, b: i32) -\u003e i32 {\na + b\n}\n\nlet multiply(a: i32, b: i32) -\u003e i32 {\na * b\n}\" class=\"rehype-pretty-copy\" onclick=\"navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(\u0026#x27;rehype-pretty-copied\u0026#x27;);window.setTimeout(() =\u003e this.classList.remove(\u0026#x27;rehype-pretty-copied\u0026#x27;), 3000);\"\u003e\u003cspan class=\"ready\"\u003e\u003c/span\u003e\u003cspan class=\"success\"\u003e\u003c/span\u003e\u003c/button\u003e\u003cstyle\u003e:root {--copy-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E\");--success-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E\");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);\u0026 span {width: 100%;aspect-ratio: 1 / 1;}\u0026 .ready {background-image: var(--copy-icon);}\u0026 .success {display: none; background-image: var(--success-icon);}}\u0026.rehype-pretty-copied {\u0026 .success {display: block;} \u0026 .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;\u0026 .ready { display: none; }\u0026 .success { display: block; }}\u003c/style\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eThe compiler produces math.mni:\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"\u003e\u003ccode data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan\u003eextern math$add(a : i32, b : i32) -\u003e i32;\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003eextern math$multiply(a : i32, b : i32) -\u003e i32;\u003c/span\u003e\u003c/span\u003e\u003cbutton type=\"button\" title=\"Copy code\" aria-label=\"Copy code\" data=\"extern math$add(a : i32, b : i32) -\u003e i32;\nextern math$multiply(a : i32, b : i32) -\u003e i32;\" class=\"rehype-pretty-copy\" onclick=\"navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(\u0026#x27;rehype-pretty-copied\u0026#x27;);window.setTimeout(() =\u003e this.classList.remove(\u0026#x27;rehype-pretty-copied\u0026#x27;), 3000);\"\u003e\u003cspan class=\"ready\"\u003e\u003c/span\u003e\u003cspan class=\"success\"\u003e\u003c/span\u003e\u003c/button\u003e\u003cstyle\u003e:root {--copy-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E\");--success-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E\");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);\u0026 span {width: 100%;aspect-ratio: 1 / 1;}\u0026 .ready {background-image: var(--copy-icon);}\u0026 .success {display: none; background-image: var(--success-icon);}}\u0026.rehype-pretty-copied {\u0026 .success {display: block;} \u0026 .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;\u0026 .ready { display: none; }\u0026 .success { display: block; }}\u003c/style\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eTwo kinds of definitions appear in .mni files:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003elet functions — always emitted with the mangled name module$func.\u003c/li\u003e\n\u003cli\u003eExposed C externs (extern C) — also emitted with the mangled name. At the LLVM level, an IFunc (indirect function) maps the mangled name back to the real C symbol, so the linker resolves it at\nload time.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003emain is never mangled — it keeps its name regardless of module.\u003c/p\u003e\n\u003cp\u003eHow Imports Consume .mni Files\u003c/p\u003e\n\u003cp\u003eWhen the importing module encounters import math as m;, the compiler:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eLocates math.mni — searches CWD, the source file's directory, then the stdlib directory.\u003c/li\u003e\n\u003cli\u003eParses it as normal sammine source — the .mni is valid sammine (extern declarations), so it runs through the same Lexer → Parser pipeline.\u003c/li\u003e\n\u003cli\u003eInjects the extern declarations into the front of the importing module's AST, so they're visible during type checking and codegen.\u003c/li\u003e\n\u003cli\u003eTracks math.o for linking — the corresponding object file is added to the link step.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAlias Resolution at Parse Time\u003c/p\u003e\n\u003cp\u003eThe parser maintains an alias_to_module map. When it sees import math as m;, it records {\"m\" → \"math\"}. Later, when it encounters a qualified call like m::add(3, 4):\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eLooks up m in alias_to_module → finds \"math\".\u003c/li\u003e\n\u003cli\u003eRewrites the identifier to math$add — the mangled name.\u003c/li\u003e\n\u003cli\u003eFrom this point on, the rest of the pipeline (type checker, codegen) sees math\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmi\u003ew\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003cmi\u003ei\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003es\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003ex\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003er\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eadd, which matches the extern math\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.8889em;vertical-align:-0.1944em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003edd\u003c/span\u003e\u003cspan class=\"mpunct\"\u003e,\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.1667em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.02691em;\"\u003ew\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ehi\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ec\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ehma\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ec\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eh\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ees\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eh\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eee\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ex\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\"\u003eer\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003enma\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eh\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003eadd(...) injected from the .mni file.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eIf you write import math; (no alias), the module name itself becomes the alias, so math::add works the same way.\u003c/p\u003e\n\u003cp\u003eCodegen: Where Mangling Actually Happens\u003c/p\u003e\n\u003cp\u003eIn FunctionCodegen.cpp, preorder_walk(PrototypeAST*) computes the LLVM symbol name:\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre tabindex=\"0\" data-language=\"cpp\" data-theme=\"github-dark-dimmed\"\u003e\u003ccode data-language=\"cpp\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#F69D50\"\u003estd\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e::string llvm_name \u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e ast-\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003efunctionName;\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#F47067\"\u003eif\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color:#6cb6ff\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003emodule_name.\u003c/span\u003e\u003cspan style=\"color:#DCBDFB\"\u003eempty\u003c/span\u003e\u003cspan style=\"color:#6bc46d\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#6bc46d\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e ast-\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003efunctionName \u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e!=\u003c/span\u003e\u003cspan style=\"color:#96D0FF\"\u003e \"main\"\u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e \u0026#x26;\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e !\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003ein_extern\u003c/span\u003e\u003cspan style=\"color:#6cb6ff\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#ADBAC7\"\u003ellvm_name \u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e module_name \u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#96D0FF\"\u003e \"$\"\u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e +\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e ast-\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003efunctionName;\u003c/span\u003e\u003c/span\u003e\u003cbutton type=\"button\" title=\"Copy code\" aria-label=\"Copy code\" data=\"std::string llvm_name = ast-\u003efunctionName;\nif (!module_name.empty() \u0026#x26;\u0026#x26; ast-\u003efunctionName != \u0026#x22;main\u0026#x22; \u0026#x26;\u0026#x26; !in_extern)\nllvm_name = module_name + \u0026#x22;$\u0026#x22; + ast-\u003efunctionName;\" class=\"rehype-pretty-copy\" onclick=\"navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(\u0026#x27;rehype-pretty-copied\u0026#x27;);window.setTimeout(() =\u003e this.classList.remove(\u0026#x27;rehype-pretty-copied\u0026#x27;), 3000);\"\u003e\u003cspan class=\"ready\"\u003e\u003c/span\u003e\u003cspan class=\"success\"\u003e\u003c/span\u003e\u003c/button\u003e\u003cstyle\u003e:root {--copy-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E\");--success-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E\");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);\u0026 span {width: 100%;aspect-ratio: 1 / 1;}\u0026 .ready {background-image: var(--copy-icon);}\u0026 .success {display: none; background-image: var(--success-icon);}}\u0026.rehype-pretty-copied {\u0026 .success {display: block;} \u0026 .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;\u0026 .ready { display: none; }\u0026 .success { display: block; }}\u003c/style\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eThe module_name is the file stem, passed to CgVisitor only when the file has no main (i.e., it's a library module). Executable modules get an empty module_name, so their functions aren't mangled.\u003c/p\u003e\n\u003cp\u003eFor exposed C externs, the real C name is kept in the object file, and an LLVM IFunc redirects the mangled name to it:\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre tabindex=\"0\" data-language=\"llvm\" data-theme=\"github-dark-dimmed\"\u003e\u003ccode data-language=\"llvm\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#DCBDFB\"\u003e@math$printf\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e = ifunc ..., ptr \u003c/span\u003e\u003cspan style=\"color:#DCBDFB\"\u003e@resolve_math$printf\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#F47067\"\u003edefine\u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003e internal\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e ptr \u003c/span\u003e\u003cspan style=\"color:#DCBDFB\"\u003e@resolve_math$printf\u003c/span\u003e\u003cspan style=\"color:#6cb6ff\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#6cb6ff\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color:#6cb6ff\"\u003e{\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color:#F47067\"\u003eret\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e ptr \u003c/span\u003e\u003cspan style=\"color:#DCBDFB\"\u003e@printf\u003c/span\u003e\u003cspan style=\"color:#ADBAC7\"\u003e \u003c/span\u003e\u003cspan style=\"color:#6cb6ff\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbutton type=\"button\" title=\"Copy code\" aria-label=\"Copy code\" data=\"@math$printf = ifunc ..., ptr @resolve_math$printf\ndefine internal ptr @resolve_math$printf() { ret ptr @printf }\" class=\"rehype-pretty-copy\" onclick=\"navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(\u0026#x27;rehype-pretty-copied\u0026#x27;);window.setTimeout(() =\u003e this.classList.remove(\u0026#x27;rehype-pretty-copied\u0026#x27;), 3000);\"\u003e\u003cspan class=\"ready\"\u003e\u003c/span\u003e\u003cspan class=\"success\"\u003e\u003c/span\u003e\u003c/button\u003e\u003cstyle\u003e:root {--copy-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E\");--success-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E\");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);\u0026 span {width: 100%;aspect-ratio: 1 / 1;}\u0026 .ready {background-image: var(--copy-icon);}\u0026 .success {display: none; background-image: var(--success-icon);}}\u0026.rehype-pretty-copied {\u0026 .success {display: block;} \u0026 .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;\u0026 .ready { display: none; }\u0026 .success { display: block; }}\u003c/style\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eEnd-to-End Example\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre tabindex=\"0\" data-language=\"bash\" data-theme=\"github-dark-dimmed\"\u003e\u003ccode data-language=\"bash\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#768390\"\u003e# Compile the library → produces math.o and math.mni\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#F69D50\"\u003esammine\u003c/span\u003e\u003cspan style=\"color:#6CB6FF\"\u003e -f\u003c/span\u003e\u003cspan style=\"color:#96D0FF\"\u003e math.mn\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#768390\"\u003e# Compile the executable → reads math.mni, links math.o\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan style=\"color:#F69D50\"\u003esammine\u003c/span\u003e\u003cspan style=\"color:#6CB6FF\"\u003e -f\u003c/span\u003e\u003cspan style=\"color:#96D0FF\"\u003e main.mn\u003c/span\u003e\u003c/span\u003e\u003cbutton type=\"button\" title=\"Copy code\" aria-label=\"Copy code\" data=\"# Compile the library → produces math.o and math.mni\nsammine -f math.mn\n\n# Compile the executable → reads math.mni, links math.o\nsammine -f main.mn\" class=\"rehype-pretty-copy\" onclick=\"navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(\u0026#x27;rehype-pretty-copied\u0026#x27;);window.setTimeout(() =\u003e this.classList.remove(\u0026#x27;rehype-pretty-copied\u0026#x27;), 3000);\"\u003e\u003cspan class=\"ready\"\u003e\u003c/span\u003e\u003cspan class=\"success\"\u003e\u003c/span\u003e\u003c/button\u003e\u003cstyle\u003e:root {--copy-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E\");--success-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E\");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);\u0026 span {width: 100%;aspect-ratio: 1 / 1;}\u0026 .ready {background-image: var(--copy-icon);}\u0026 .success {display: none; background-image: var(--success-icon);}}\u0026.rehype-pretty-copied {\u0026 .success {display: block;} \u0026 .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;\u0026 .ready { display: none; }\u0026 .success { display: block; }}\u003c/style\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003emain.mn:\u003c/p\u003e\n\u003cfigure data-rehype-pretty-code-figure=\"\"\u003e\u003cpre tabindex=\"0\" data-language=\"plaintext\" data-theme=\"github-dark-dimmed\"\u003e\u003ccode data-language=\"plaintext\" data-theme=\"github-dark-dimmed\" style=\"display: grid;\"\u003e\u003cspan data-line=\"\"\u003e\u003cspan\u003eimport math as m;\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003eimport std;\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e \u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003elet main() -\u003e i32 {\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003estd::printf(\"%d\\n\", m::add(3, 4));\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003ereturn 0;\u003c/span\u003e\u003c/span\u003e\n\u003cspan data-line=\"\"\u003e\u003cspan\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbutton type=\"button\" title=\"Copy code\" aria-label=\"Copy code\" data=\"import math as m;\nimport std;\n\nlet main() -\u003e i32 {\nstd::printf(\u0026#x22;%d\\n\u0026#x22;, m::add(3, 4));\nreturn 0;\n}\" class=\"rehype-pretty-copy\" onclick=\"navigator.clipboard.writeText(this.attributes.data.value);this.classList.add(\u0026#x27;rehype-pretty-copied\u0026#x27;);window.setTimeout(() =\u003e this.classList.remove(\u0026#x27;rehype-pretty-copied\u0026#x27;), 3000);\"\u003e\u003cspan class=\"ready\"\u003e\u003c/span\u003e\u003cspan class=\"success\"\u003e\u003c/span\u003e\u003c/button\u003e\u003cstyle\u003e:root {--copy-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23adadad' d='M16.187 9.5H12.25a1.75 1.75 0 0 0-1.75 1.75v28.5c0 .967.784 1.75 1.75 1.75h23.5a1.75 1.75 0 0 0 1.75-1.75v-28.5a1.75 1.75 0 0 0-1.75-1.75h-3.937a4.25 4.25 0 0 1-4.063 3h-7.5a4.25 4.25 0 0 1-4.063-3M31.813 7h3.937A4.25 4.25 0 0 1 40 11.25v28.5A4.25 4.25 0 0 1 35.75 44h-23.5A4.25 4.25 0 0 1 8 39.75v-28.5A4.25 4.25 0 0 1 12.25 7h3.937a4.25 4.25 0 0 1 4.063-3h7.5a4.25 4.25 0 0 1 4.063 3M18.5 8.25c0 .966.784 1.75 1.75 1.75h7.5a1.75 1.75 0 1 0 0-3.5h-7.5a1.75 1.75 0 0 0-1.75 1.75'/%3E%3C/svg%3E\");--success-icon: url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%2366ff85' d='M9 16.17L5.53 12.7a.996.996 0 1 0-1.41 1.41l4.18 4.18c.39.39 1.02.39 1.41 0L20.29 7.71a.996.996 0 1 0-1.41-1.41z'/%3E%3C/svg%3E\");}pre:has(code) {position: relative;}pre button.rehype-pretty-copy {right: 1px;padding: 0;width: 24px;height: 24px;display: flex;margin-top: 2px;margin-right: 8px;position: absolute;border-radius: 25%;backdrop-filter: blur(3px);\u0026 span {width: 100%;aspect-ratio: 1 / 1;}\u0026 .ready {background-image: var(--copy-icon);}\u0026 .success {display: none; background-image: var(--success-icon);}}\u0026.rehype-pretty-copied {\u0026 .success {display: block;} \u0026 .ready {display: none;}}pre button.rehype-pretty-copy.rehype-pretty-copied {opacity: 1;\u0026 .ready { display: none; }\u0026 .success { display: block; }}\u003c/style\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/figure\u003e\n\u003cp\u003eThe flow: m::add(3, 4) → parser rewrites to math\u003cspan class=\"katex\"\u003e\u003cspan class=\"katex-mathml\"\u003e\u003cmath xmlns=\"http://www.w3.org/1998/Math/MathML\"\u003e\u003csemantics\u003e\u003cmrow\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmi\u003ed\u003c/mi\u003e\u003cmo stretchy=\"false\"\u003e(\u003c/mo\u003e\u003cmn\u003e3\u003c/mn\u003e\u003cmo separator=\"true\"\u003e,\u003c/mo\u003e\u003cmn\u003e4\u003c/mn\u003e\u003cmo stretchy=\"false\"\u003e)\u003c/mo\u003e\u003cmo\u003e→\u003c/mo\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ec\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003es\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003ex\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003ee\u003c/mi\u003e\u003cmi\u003er\u003c/mi\u003e\u003cmi\u003en\u003c/mi\u003e\u003cmi\u003em\u003c/mi\u003e\u003cmi\u003ea\u003c/mi\u003e\u003cmi\u003et\u003c/mi\u003e\u003cmi\u003eh\u003c/mi\u003e\u003c/mrow\u003e\u003cannotation encoding=\"application/x-tex\"\u003eadd(3, 4) → matches extern math\u003c/annotation\u003e\u003c/semantics\u003e\u003c/math\u003e\u003c/span\u003e\u003cspan class=\"katex-html\" aria-hidden=\"true\"\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ea\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003edd\u003c/span\u003e\u003cspan class=\"mopen\"\u003e(\u003c/span\u003e\u003cspan class=\"mord\"\u003e3\u003c/span\u003e\u003cspan class=\"mpunct\"\u003e,\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.1667em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord\"\u003e4\u003c/span\u003e\u003cspan class=\"mclose\"\u003e)\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003cspan class=\"mrel\"\u003e→\u003c/span\u003e\u003cspan class=\"mspace\" style=\"margin-right:0.2778em;\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"base\"\u003e\u003cspan class=\"strut\" style=\"height:0.6944em;\"\u003e\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ema\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ec\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eh\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eese\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003ex\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\" style=\"margin-right:0.02778em;\"\u003eer\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003enma\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003et\u003c/span\u003e\u003cspan class=\"mord mathnormal\"\u003eh\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003eadd(...) from .mni → codegen emits a call to @math$add → linker resolves it from math.o.\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"generics\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#generics\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eGenerics\u003c/h3\u003e\n\u003cp\u003eInitially I was unsure on where to put this part but I guess I can mention generics in both sections.\u003c/p\u003e\n\u003cp\u003eIn shortness, when we generate code in the codegen phase, there won't be any generics anymore; the generics would've been dissolve\naway by the type checker. For a generic of type T in function f, as in the following code, the typechecker sets the boolean of is_generic() to true\n. Then when the type checker sees a call expr of f with a concrete type like i32, it literally creates another AST clone\nof the function f, called f.i32 (this is called monomorphization).\u003c/p\u003e\n\u003cp\u003eWhen the codegen stage comes in, for a function ast, if its generic (via the boolean is_generic), then it won't generate code\nfor it. But if it's monomorphized (non-generic), then it goes ahead and generate the code for it normally :)\u003c/p\u003e\n\u003cp\u003eI'll have to reserve talking about the type checking aspect of generics here since the topic of the article is about\ncodegen :) But if you'd like to support me in pumping out articles faster, maybe you can \u003ca href=\"https://ko-fi.com/badumbatish\" rel=\"nofollow\" target=\"_blank\"\u003ebuy me a redbull\u003c/a\u003e? :)\u003c/p\u003e\n\u003ch3 id=\"turning-on-optimizations\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#turning-on-optimizations\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eTurning on optimizations\u003c/h3\u003e\n\u003ch1 id=\"epilogue\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#epilogue\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eEpilogue\u003c/h1\u003e\n\u003ch2 id=\"remarks\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#remarks\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eRemarks\u003c/h2\u003e\n\u003cp\u003eThe article, as you can tell, is directed towards new grads and/or beginners in LLVM. If you've benefited from the article\nor if you'd like to support my writing these blogs, please consider \u003ca href=\"\"\u003egetting me a red bull\u003c/a\u003e :)\u003c/p\u003e\n\u003cp\u003eI also want to extend my thanks to all the developers that helped contributed to the\nKaleidoscope. Without them, the journey to generate code, as well as the creation of this article, would be\nten-fold harder. I realize that we all stands on the shoulder of the previous generations and of giants and I would like to pay my tribute to them.\u003c/p\u003e\n\u003ch2 id=\"claude\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#claude\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eClaude\u003c/h2\u003e\n\u003cp\u003eYou'll realize that in this edition of extending kalei, a lot of work's been done. This is due to no small parts to Claude, allowing\nme to loo\u003c/p\u003e"])</script><script>self.__next_f.push([1,"6:[\"$\",\"div\",null,{\"className\":\"relative\",\"children\":[[\"$\",\"div\",null,{\"className\":\"py-12 flex flex-col items-center  justify-items-start mx-auto \",\"children\":[[\"$\",\"$L2\",null,{\"href\":\"/blog\",\"className\":\"flex justify-center text-4xl\",\"children\":[\"$\",\"h2\",null,{\"children\":\"My blog\"}]}],[\"$\",\"article\",null,{\"className\":\"p-8 prose pt-0.5 max-w-none w-full lg:w-1/2 md:w-4/6 sm:w-5/6 prose-sky mx-auto\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex justify-center text-2xl font-bold \",\"children\":[\"$\",\"h2\",null,{\"children\":\"[ONGOING] Extending LLVM's Kaleidoscope: Code-gen edition\"}]}],[\"$\",\"div\",null,{\"className\":\"flex justify-start text-xl font-bold underline\",\"children\":[\"$\",\"h4\",null,{\"children\":\"8888-08-08\"}]}],[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$11\"}}]]}]]}],\"$L12\"]}]\n"])</script><script>self.__next_f.push([1,"a:{\"metadata\":[[\"$\",\"title\",\"0\",{\"children\":\"[ONGOING] Extending LLVM's Kaleidoscope: Code-gen edition\"}],[\"$\",\"meta\",\"1\",{\"name\":\"description\",\"content\":\"Jasmine extends her language with string, tuple, if-else codegen, closures and generics\"}],[\"$\",\"link\",\"2\",{\"rel\":\"icon\",\"href\":\"/_next/static/media/pfp6.723cdd8c.png\"}],[\"$\",\"$L13\",\"3\",{}]],\"error\":null,\"digest\":\"$undefined\"}\nf:\"$a:metadata\"\n"])</script><script>self.__next_f.push([1,"14:I[6249,[\"874\",\"static/chunks/874-437a265a67d6cfee.js\",\"880\",\"static/chunks/app/posts/%5Bid%5D/page-40c736743e813852.js\"],\"default\"]\n12:[\"$\",\"$L14\",null,{\"articleSelector\":\"article\"}]\n"])</script></body></html>