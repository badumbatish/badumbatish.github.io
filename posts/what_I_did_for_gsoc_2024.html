<!DOCTYPE html><html lang="en" class="px-4 py-4"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/7385e8d9d3c5518f-s.p.ttf" as="font" crossorigin="" type="font/ttf"/><link rel="stylesheet" href="/_next/static/css/4c262d18fc086fff.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-024c71c063ddb8d8.js"/><script src="/_next/static/chunks/4bd1b696-cc921fdf64582ac2.js" async=""></script><script src="/_next/static/chunks/517-f9c47ac1c3159d98.js" async=""></script><script src="/_next/static/chunks/main-app-64657d68b3fa7103.js" async=""></script><script src="/_next/static/chunks/173-ad05a37061268ac6.js" async=""></script><script src="/_next/static/chunks/565-d3001cb0b7ac580c.js" async=""></script><script src="/_next/static/chunks/app/layout-5c184bc8512acba2.js" async=""></script><meta name="next-size-adjust" content=""/><title>What I did for GSoc 2024</title><meta name="description" content="Built with NextJS, TailwindCSS, and a tonnn of loveee :)"/><link rel="icon" href="/_next/static/media/pfp3.5cd65164.png"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__className_d4e0c8 flex flex-col min-h-screen"><a href="/"><div class="flex justify-center items-center py-4 "><h1 class="text-4xl font-bold">Jasmine Tang</h1></div></a><div class="flex-1"><article class="p-8 prose  max-w-none w-full lg:w-1/2 md:w-4/6 sm:w-5/6 prose-sky mx-auto"><div class="flex justify-center text-2xl font-bold "><h2>What I did for GSoc 2024</h2></div><div class="flex justify-start text-xl font-bold underline"><h4>2024-08-22</h4></div><div><nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#introduction">Introduction</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#main-contribution-aspects">Main contribution aspects</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#issues-and-prs">Issues and PRs</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#issues">Issues</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#prs">PRs</a></li><li class="toc-item toc-item-h1"><a class="toc-link toc-link-h1" href="#gccrs-inline-assembly">GCCRS Inline Assembly</a><ol class="toc-level toc-level-3"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#purpose">Purpose</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#syntax">Syntax</a><ol class="toc-level toc-level-4"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#grammar">Grammar</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#syntax-example">Syntax example</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#overall-architecture">Overall architecture</a><ol class="toc-level toc-level-4"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#definition">Definition</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#architecture">Architecture</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#related-files">Related files</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#architecture-visualization">Architecture visualization</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#ast">AST</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#parser">Parser</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#ast-to-hir">AST to HIR</a><ol class="toc-level toc-level-4"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#hir-creation">HIR Creation</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#unsafe-gating">Unsafe gating</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#type-checking">Type checking</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#resolution">Resolution</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#tree-generic">TREE (GENERIC)</a><ol class="toc-level toc-level-4"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#overall">Overall</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#anatomy">Anatomy</a><ol class="toc-level toc-level-5"><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#tree_list">TREE_LIST</a></li><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#string_cst">STRING_CST</a></li><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#asm_expr">ASM_EXPR</a></li></ol></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#tree-usage">TREE USAGE</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#results">Results</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#end-words">End words</a></li></ol></li></ol></li></ol></nav><p>Hi everyone, this article is a requirement for my GSoc Final Submission, linking directly to the submission.</p>
<p>This article will include the summary of my contribution, where you can find all my filed issues and PRs.</p>
<p><strong>Edit</strong>:</p>
<p>I would love to be informed of new-grad opportunities for Summer 2025. If you know of a compiler related job posting, please feel free to contact me at either:</p>
<ul>
<li><a href="mailto:tanghocle456@gmail.com">tanghocle456@gmail.com</a> (for job posting)</li>
<li><a href="mailto:jjasmine@berkeley.edu">jjasmine@berkeley.edu</a> (for job posting)</li>
<li><a href="https://x.com/thisisjjasmine">https://x.com/thisisjjasmine</a> (social media)</li>
</ul>
<h2 id="introduction"><a aria-hidden="true" tabindex="-1" href="#introduction"><span class="icon icon-link"></span></a>Introduction</h2>
<p>This summer I worked on the <a href="https://github.com/Rust-GCC/gccrs">gccrs</a> project, a GCC Front-end for Rust.</p>
<p>gccrs is a project to implement the Rust programming languages from scratch in the GCC codebase in order for rust to be able to be compiled to a wider amount of targets. It currently targets the version 1.49 of Rust and is supported by Open Source Security and Embecosm.</p>
<p>By doing this, it helps with a couple things:</p>
<ul>
<li>Targets architecture not available with rustc due to the use of LLVM. (SuperH for example, which powers the Dreamcast!)</li>
<li>Benefit from the existing GCC ecosystem.</li>
<li>Help with acceptance of Rust in the Linux kernel</li>
<li>Help with acceptance of Rust in other fields, where having multiple compilers helps.</li>
<li>Enable building Rust on targets with very old C++ compilers! (Targets with at least GCC version 4.8 (which released March 22, 2013) can build Rust)</li>
</ul>
<h2 id="main-contribution-aspects"><a aria-hidden="true" tabindex="-1" href="#main-contribution-aspects"><span class="icon icon-link"></span></a>Main contribution aspects</h2>
<p>Overall, I contributed in 3 main aspects:</p>
<ul>
<li>
<p><strong>My main project</strong> - Inline Assembly in rust: I programmed the parser, set up the code infrastructure for TREE IR generation in the backend, along with AST, HIR lowering and typechecking.</p>
</li>
<li>
<p><strong>CI/CD</strong>: I helped maintain and improve the CI/CD pipeline. This includes resolving dependency issues in GitHub Actions, adding support for 32 bit CI and glibc compliance CI.
I also created a docker-compose dev environment for MacOS-based contributors, with all libraries and dependency installed; this helps us bypass MacOS's annoying build and link issues.</p>
</li>
<li>
<p><strong>Code maintainance/Bug Fixes/Code Review</strong>: I maintained the code base via issues filed by my mentor and other contributors. I also helped fix some minor bugs in IR lowering and typechecking. I also help review some new, simple PRs for contributors.</p>
</li>
</ul>
<h2 id="issues-and-prs"><a aria-hidden="true" tabindex="-1" href="#issues-and-prs"><span class="icon icon-link"></span></a>Issues and PRs</h2>
<p>Below is all the issues, PRs and commits I've made to the <a href="https://github.com/Rust-GCC/gccrs">gccrs</a> repository, up to Aug 22 2024, after producing this I ended up closing some resolved issues that has been silently addressed in some PRs.</p>
<p>The tables are produced via <code>gh</code> cli tool and some <code>I use nvim btw</code> love :)</p>
<h3 id="issues"><a aria-hidden="true" tabindex="-1" href="#issues"><span class="icon icon-link"></span></a>Issues</h3>
<p>Here's a formatted version of all my issues, up to Aug 22 2024, procured via <code>gh issue list -A badumbatish --state all</code>:</p>
































































































<table><thead><tr><th>Issue Number</th><th>Issue Status</th><th>Issue Title</th><th>Labels</th><th>Filed Date</th></tr></thead><tbody><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3102">3102</a></td><td><strong>OPEN</strong></td><td>Set up the rest of HIR pipeline in InlineAsm</td><td></td><td>2024-07-27T03:20:50Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3099">3099</a></td><td><strong>OPEN</strong></td><td>parse_expr not stopping on =></td><td></td><td>2024-07-25T19:41:07Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3072">3072</a></td><td><strong>OPEN</strong></td><td>asm parser lacking <code>label</code> parse functionality</td><td></td><td>2024-07-01T08:54:12Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3069">3069</a></td><td><strong>OPEN</strong></td><td>Make asm parser stores parse result</td><td></td><td>2024-06-25T16:12:44Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3062">3062</a></td><td><strong>CLOSED</strong></td><td>Add ExprType::InlineAsm variant to ExprType enum</td><td></td><td>2024-06-24T13:23:55Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3061">3061</a></td><td><strong>OPEN</strong></td><td>Typechecking of asm! failed in <code>let _</code></td><td>bug</td><td>2024-06-24T13:24:07Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3057">3057</a></td><td><strong>OPEN</strong></td><td>asm! macro failed to exhaustively parse all of options(), clobber_abis(), and register operands</td><td>bug, expansion</td><td>2024-06-18T13:32:24Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3052">3052</a></td><td><strong>OPEN</strong></td><td>Fully incorporate tl::expected into InlineAsm parsing</td><td></td><td>2024-06-14T09:54:17Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3051">3051</a></td><td><strong>CLOSED</strong></td><td>Remove unnecessary #include from rust-expr.h</td><td>good-first-pr, cleanup</td><td>2024-07-11T09:23:53Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3050">3050</a></td><td><strong>CLOSED</strong></td><td>Safe guard InlineAsm-related structs</td><td></td><td>2024-07-03T09:58:52Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/3048">3048</a></td><td><strong>OPEN</strong></td><td>Handle outer attributes properly for inline assembly</td><td></td><td>2024-06-14T09:55:37Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/issues/2937">2937</a></td><td><strong>CLOSED</strong></td><td>Docker image and container for Mac</td><td></td><td>2024-05-10T14:53:25Z</td></tr></tbody></table>
<p>The closed/filed rate is 4/8, which is not high. Through out writing the parser and the backend infra, I realized that there are these little issues that's just easier to just fix and not necessary filed. There is also issues that are discussed via <a href="https://gist.github.com/badumbatish/9823719ef359a58b131220d9d79d2aec">hackmd notes</a> between me and my mentor that are not necessarily filed via GitHub.</p>
<h3 id="prs"><a aria-hidden="true" tabindex="-1" href="#prs"><span class="icon icon-link"></span></a>PRs</h3>
<p>Here's a formatted version of all my pull requests, up to Aug 22 2024, procured via <code>gh pr list -A badumbatish --state all</code>:</p>



























































































































































<table><thead><tr><th>PR Number</th><th>PR Status</th><th>PR Title</th><th>Filed Date</th></tr></thead><tbody><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3133">3133</a></td><td><strong>MERGED</strong></td><td>Fix the disorder struct and class in inline asm</td><td>2024-08-20T07:41:34Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3119">3119</a></td><td><strong>OPEN</strong></td><td>Add running cicd 32bit</td><td>2024-08-04T19:47:37Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3109">3109</a></td><td><strong>MERGED</strong></td><td>Inline asm resolve expr</td><td>2024-07-31T03:41:32Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3103">3103</a></td><td><strong>MERGED</strong></td><td>Inline asm hir pipeline</td><td>2024-07-27T08:22:57Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3098">3098</a></td><td><strong>MERGED</strong></td><td>Fix the parser's operand and flags storage</td><td>2024-07-25T16:38:11Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3093">3093</a></td><td><strong>MERGED</strong></td><td>Change assertion of asm operand constructor</td><td>2024-07-21T22:46:28Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3090">3090</a></td><td><strong>MERGED</strong></td><td>Added options for ParseMode</td><td>2024-07-20T07:48:51Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3081">3081</a></td><td><strong>MERGED</strong></td><td>Pin node16 by allowing old version</td><td>2024-07-10T02:32:08Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3074">3074</a></td><td><strong>MERGED</strong></td><td>Safe-guard InlineAsm structs</td><td>2024-07-01T00:43:59Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3073">3073</a></td><td><strong>MERGED</strong></td><td>Store parse result of parse_format_string(s)</td><td>2024-07-01T00:24:42Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3063">3063</a></td><td><strong>MERGED</strong></td><td>Added ExprType::InlineAsm</td><td>2024-06-23T18:06:02Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3060">3060</a></td><td><strong>DRAFT</strong></td><td>Asm generic il codegen</td><td>2024-06-23T14:11:44Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3059">3059</a></td><td><strong>MERGED</strong></td><td>Add test case for using asm! outside of unsafe </td><td>2024-06-22T06:40:27Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3053">3053</a></td><td><strong>MERGED</strong></td><td>incorporate tl::expected into InlineAsm parsing</td><td>2024-06-14T06:08:01Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3011">3011</a></td><td><strong>MERGED</strong></td><td>Remove cstddef header from rust-fmt</td><td>2024-05-19T03:03:05Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/3002">3002</a></td><td><strong>MERGED</strong></td><td>Make gccrs recognize negative_impls</td><td>2024-05-15T22:06:45Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/2982">2982</a></td><td><strong>MERGED</strong></td><td>Inline asm</td><td>2024-05-08T19:41:27Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/2981">2981</a></td><td><strong>OPEN</strong></td><td>Cleanup macro invoc</td><td>2024-05-08T17:47:46Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/2980">2980</a></td><td><strong>MERGED</strong></td><td>Fix all tests in execute to be \r\n</td><td>2024-05-08T06:47:12Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/2941">2941</a></td><td><strong>MERGED</strong></td><td>Add an alternative solution on MacOS</td><td>2024-04-05T03:10:57Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/2911">2911</a></td><td><strong>MERGED</strong></td><td>Store visibility properly in ExternalTypeItem: Fixes #2897</td><td>2024-03-09T22:46:59Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/2895">2895</a></td><td><strong>MERGED</strong></td><td>Add error emitting when we can't resolve id expr</td><td>2024-03-01T10:40:34Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/2874">2874</a></td><td><strong>MERGED</strong></td><td>First stab at issue 2855 by splitting the two maps</td><td>2024-02-25T21:13:02Z</td></tr><tr><td><a href="https://github.com/Rust-GCC/gccrs/pull/2871">2871</a></td><td><strong>MERGED</strong></td><td>Fix FixMe in changing return type of builtin_macro_from_string() from BuiltinMacro to tl::optional/<div></div></td><td>2024-02-23T21:22:58Z</td></tr></tbody></table>
<p>The merged/filed rate is 22/25. Half of the PRs are easy to fix / fixable within a short amount of time (Code maintanence aspect). The other half is medium in difficulty, related to my summer project (Project aspect).</p>
<h1 id="gccrs-inline-assembly"><a aria-hidden="true" tabindex="-1" href="#gccrs-inline-assembly"><span class="icon icon-link"></span></a>GCCRS Inline Assembly</h1>
<p>Alright, let's try to understand what I did this summer in greater detail.</p>
<p>This write up will try to avoid lower level, implementation-based details but will let you walk away knowing what I, <a href="https://badumbatish.github.io/">badumbatish</a> did this summer :)</p>
<p>Although I won't post much code, I'll still provide links to my PRs for interested readers. Inspirations  includes contributors from the rust codebase and gccrs codebase. More specifically, <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_builtin_macros/src/asm.rs">asm.rs</a> from rustc, Arthur, Pierre-Emmanuel and Mahad from gccrs.</p>
<h2 id="purpose"><a aria-hidden="true" tabindex="-1" href="#purpose"><span class="icon icon-link"></span></a>Purpose</h2>
<p>Assembly are often used by programmers as a precise instrument in case that compiler's high level constructs are too coarse for the programmers' intent. With the advent of inline  assembly, you can do this without having to create a seperate assembly file, maintaining the stackframe, register invariants, juggling different platforms and different calling conventions by yourself, etc...</p>
<p>The purpose of my project is to provide support for inline assembly in gccrs. With respect to Rust's memory safety guarantees as well as the context of assembly languages usages in today's modern era, the project aims to alleviate the complexity from the programmmers while providing precautions and safeguards with unsafe blocks requirements and higher level constructs such as register operands, compared to raw hardware registers.</p>
<h2 id="syntax"><a aria-hidden="true" tabindex="-1" href="#syntax"><span class="icon icon-link"></span></a>Syntax</h2>
<p>In this section we'll take a look at the syntax of inline assembly, as well as dissecting some examples.</p>
<h3 id="grammar"><a aria-hidden="true" tabindex="-1" href="#grammar"><span class="icon icon-link"></span></a>Grammar</h3>
<p>The syntax for inline assembly is quite simple. This is taken from the <a href="https://doc.rust-lang.org/reference/inline-assembly.html">Rust Reference website</a> :</p>
<pre><code>format_string := STRING_LITERAL / RAW_STRING_LITERAL
dir_spec := "in" / "out" / "lateout" / "inout" / "inlateout"
reg_spec := &#x3C;register class> / "\"" &#x3C;explicit register> "\""
operand_expr := expr / "_" / expr "=>" expr / expr "=>" "_"
reg_operand := [ident "="] dir_spec "(" reg_spec ")" operand_expr
clobber_abi := "clobber_abi(" &#x3C;abi> *("," &#x3C;abi>) [","] ")"
option := "pure" / "nomem" / "readonly" / "preserves_flags" / "noreturn" / "nostack" / "att_syntax" / "raw"
options := "options(" option *("," option) [","] ")"
operand := reg_operand / clobber_abi / options
asm := "asm!(" format_string *("," format_string) *("," operand) [","] ")"
global_asm := "global_asm!(" format_string *("," format_string) *("," operand) [","] ")"
</code></pre>
<p>The topmost level, or the start of the parse rule is either <code>asm</code> or <code>global_asm</code>.</p>
<p>The inline assembly code is represented by <code>format_string</code>. The other aspect is <code>operand</code>, which includes <code>reg_operand</code>, <code>clobber_abi</code>, and <code>options</code>.</p>
<p>More information about different types of operand can be referred to from <a href="https://doc.rust-lang.org/reference/inline-assembly.html">the reference</a>.</p>
<p>Keep in mind that the way we see this division of the grammar is how we'll construct our AST subsequently, our parser.</p>
<h3 id="syntax-example"><a aria-hidden="true" tabindex="-1" href="#syntax-example"><span class="icon icon-link"></span></a>Syntax example</h3>
<p>Let's look at some inline assembly examples pulled from the <a href="https://doc.rust-lang.org/rust-by-example/unsafe/asm.html">Rust by example website</a>.</p>
<ul>
<li>This is the simplest form, only including a no-op instruction</li>
</ul>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">use</span><span style="color:#E5C890"> std</span><span style="color:#81C8BE">::</span><span style="color:#E5C890">arch</span><span style="color:#81C8BE">::</span><span style="color:#C6D0F5">asm</span><span style="color:#949CBB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">unsafe</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">    asm!</span><span style="color:#949CBB">(</span><span style="color:#A6D189">"nop"</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<ul>
<li>Of course, more complex (non-simple) form of inline assembly requires some extra functionality:</li>
</ul>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">use</span><span style="color:#E5C890"> std</span><span style="color:#81C8BE">::</span><span style="color:#E5C890">arch</span><span style="color:#81C8BE">::</span><span style="color:#C6D0F5">asm</span><span style="color:#949CBB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">let</span><span style="color:#C6D0F5"> x</span><span style="color:#81C8BE">:</span><span style="color:#CA9EE6"> u64</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">unsafe</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">    asm!</span><span style="color:#949CBB">(</span><span style="color:#A6D189">"mov </span><span style="color:#949CBB">{}</span><span style="color:#A6D189">, 5"</span><span style="color:#949CBB">,</span><span style="color:#8CAAEE;font-style:italic"> out</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">reg</span><span style="color:#949CBB">)</span><span style="color:#C6D0F5"> x</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#949CBB">}</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">assert_eq!</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">x</span><span style="color:#949CBB">,</span><span style="color:#EF9F76"> 5</span><span style="color:#949CBB">);</span></span></code></pre>
<p>This requires the operand functionality, more specifically the reg_operand category. In simple terms, the <code>{}</code> in the format string (template string) (designated by the double quote symbol) refers to the variable x. The out(reg) asks the compiler to substitute the  by the register used to store x and to assume the inline assembly will only write to this register and not expect any particular initial value. On the ARM platform architecture, in the raw assembly, the <code>{}</code> in the formatted string would be replaced with a  register allocated to <code>x</code>, such as the <code>x0</code> register.</p>
<p>An as a demonstrate, in the following code, <code>move {}, 5</code> is transformed into <code>mov x0, 5</code></p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">    .cfi_def_cfa_offset </span><span style="color:#EF9F76">32</span></span>
<span class="line"><span style="color:#C6D0F5">    .cfi_offset </span><span style="color:#EF9F76">29</span><span style="color:#C6D0F5">, -</span><span style="color:#EF9F76">32</span></span>
<span class="line"><span style="color:#C6D0F5">    .cfi_offset </span><span style="color:#EF9F76">30</span><span style="color:#C6D0F5">, -</span><span style="color:#EF9F76">24</span></span>
<span class="line"><span style="color:#C6D0F5">    ...</span></span>
<span class="line"><span style="color:#C6D0F5">#APP</span></span>
<span class="line"><span style="color:#C6D0F5">// </span><span style="color:#EF9F76">6</span><span style="color:#C6D0F5"> "asm_mov.rs" </span><span style="color:#EF9F76">1</span></span>
<span class="line"><span style="color:#CA9EE6">    mov</span><span style="color:#C6D0F5"> x0, </span><span style="color:#EF9F76">5</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C6D0F5">// </span><span style="color:#EF9F76">0</span><span style="color:#C6D0F5"> "" </span><span style="color:#EF9F76">2</span></span>
<span class="line"><span style="color:#C6D0F5">#NO_APP</span></span>
<span class="line"><span style="color:#C6D0F5">    ...</span></span></code></pre>
<h2 id="overall-architecture"><a aria-hidden="true" tabindex="-1" href="#overall-architecture"><span class="icon icon-link"></span></a>Overall architecture</h2>
<p>In this section we provide common compiler norms, discuss the overall architecture of the project as well as some of the most relevant files to the project.</p>
<p>The end of this section provides a high level graph for readers to visualize the architecture.</p>
<h3 id="definition"><a aria-hidden="true" tabindex="-1" href="#definition"><span class="icon icon-link"></span></a>Definition</h3>
<p>Before giving an overview of the architecture of the project, it's necessary to give context to common compiler norms:</p>
<ul>
<li>Type checking: The process of ensuring that variables and expressions have types that align with the expected types (explicitly or implicitly) defined in the code, preventing type errors.</li>
<li>Name resolution: The process of matching names (such as variables, functions, and types) in the code with their corresponding declarations to ensure correct scoping and accessibility.</li>
<li>Unsafe gating: The mechanism that restricts certain operations (e.g., raw pointer casting, inline assembly) to unsafe blocks, indicating that the programmer takes responsibility for upholding safety guarantees.</li>
<li>AST: Stands for Abstract syntax tree and is used to represent a program or a code snippet. Usually in a compiler, this data structure is the product of a parser. The compiler can then lower this data structure into a different data structure called HIR, which will be defined in the next sentence.</li>
<li>HIR: High Level Intermediate Representation. After AST, the compiler lowers the AST into a different representation. In gccrs, this is where different validations such as type checking, name resolution and unsafe gating happens. The compiler then lower this IR into what's known as GENERIC IL</li>
<li>TREE (GENERIC IL): GENERIC Intermediate Language. gcc's language-independent way of representing different constructs in trees.</li>
<li>GIMPLE: (From gcc:) is a three-address representation derived from GENERIC by breaking down GENERIC expressions into tuples of no more than 3 operands (with some exceptions like function calls).</li>
<li>GCC Backend: where gcc starts to generate archiecture-dependent code.</li>
</ul>
<h3 id="architecture"><a aria-hidden="true" tabindex="-1" href="#architecture"><span class="icon icon-link"></span></a>Architecture</h3>
<p>I haven't talked about how we should handle this. Obviously the plan is to have the compiler recognize the syntax so a parser is required, but what happens after that?</p>
<p>Well, like our cousin (or sibling?) rustc, the gccrs compiler itself has the AST, and then HIR. After that, gccrs converts its HIR into gcc's TREE (GENERIC IL) format. At this stage, gcc handles the conversion from inline assembly tree to gimple and then eventually raw architecture-dependent assembly code via gcc's backend.</p>
<p>We need to also set up other stuff such as inline assembly validation, type checking, name resolution, etc etc. This will be mention in passing as it is relevant to Rust's safety feature.</p>
<h3 id="related-files"><a aria-hidden="true" tabindex="-1" href="#related-files"><span class="icon icon-link"></span></a>Related files</h3>
<p>The related files for this issue includes</p>
<ul>
<li><code>gcc/rust/expand/rust-macrobuiltins-asm.h/cc</code>: Where the parsing of an <code>asm!()</code> happens.</li>
<li><code>gcc/rust/ast/rust-expr.h</code>: Where the ast of an inline asm is defined.</li>
<li><code>gcc/rust/hir/tree/rust-hir-expr.h</code>: Where the HIR (high level ir) of an inline asm is defined.</li>
<li><code>gcc/rust/backend/rust-compile-asm.h/cc</code>: where the backend of inline asm starts processing.</li>
</ul>
<h3 id="architecture-visualization"><a aria-hidden="true" tabindex="-1" href="#architecture-visualization"><span class="icon icon-link"></span></a>Architecture visualization</h3>
<p>The picture below depicts the project's pipeline.
<img src="/blogs/mermaid_gsoc_arch1.svg" alt="mermaid_gsoc_arch"></p>
<h2 id="ast"><a aria-hidden="true" tabindex="-1" href="#ast"><span class="icon icon-link"></span></a>AST</h2>
<p>The AST follows the structure that the syntax provides.</p>
<p>At the end of PR <a href="https://github.com/Rust-GCC/gccrs/pull/3060">3060</a>, it takes its structure from <a href="https://github.com/rust-lang/rust/blob/master/compiler/rustc_builtin_macros/src/asm.rs">asm.rs</a>. It inherits from the ExprWithoutBlock, which inherits from Expr, indicating that an asm! call is an expr.</p>
<p>Here, I give the high level structure of the AST related to inline assembly. In the gccrs codebase, the AST are represented with classes and structs.</p>
<ul>
<li>InlineAsm: this class inherits from ExprWithoutBlock, and contains containers for templated strings, operands, named arguments, register arguments, clobber abi, and options.</li>
<li>TupleTemplateStr: stands for a templated string where we store a location as well as the internet string</li>
<li>InlineAsmOperand: represents an operand in inline assembly, which can be a register operand (class InlineAsmRegOrRegClass) or some non-register operands such as a Sym or a Label.</li>
</ul>
<p>By having a close mapping between the three things: Syntax, AST, and parsing, we lower our mental capacity in implementing them, maintaining a clear mental model if ever in need of debugging.</p>
<h2 id="parser"><a aria-hidden="true" tabindex="-1" href="#parser"><span class="icon icon-link"></span></a>Parser</h2>
<p>Nice, now let's talk about the parser :)</p>
<p>We'll be writing a simple recursive descent parser as described by our syntax section.</p>
<p>As referenced above in the syntax section, the parser consists of 4 levels, 0 to 3, maintaining a clear and simple mapping between the parser and the syntax:</p>
<ul>
<li>The first level (0), shows the entrance of the parser.</li>
<li>The second level (1) describes the main loop of the parser, where we repeatedly parse all the formatted strings first, then operands then perform AST validation.</li>
<li>The third and fourth level goes into the subcategory of each aspect of the second level and so on: parsing formatted strings means repeatedly parsing <em>a</em> formatted string and parsing options means repeatedly parsing <em>an</em> option, etc etc.</li>
</ul>
<p>The diagram below shows the totality of the parser architecture, where the two greenish block in level 0 represents the starting point and the ending point of the parser.
<img src="https://hackmd.io/_uploads/r1tIddrhR.svg" alt="Untitled diagram-2024-09-04-060350"></p>
<p>Interested readers can look into the master branch, in the file <code>gcc/rust/expand/rust-macro-builtins-asm.h/cc</code> for the implementation detail of the parser.</p>
<h2 id="ast-to-hir"><a aria-hidden="true" tabindex="-1" href="#ast-to-hir"><span class="icon icon-link"></span></a>AST to HIR</h2>
<p>After we have gotten our AST, the next step is lowering it into HIR.</p>
<p>Since the inline assembly ASTs doesn't undergo much change in structure from AST to HIR, the HIRs representation inherits almost everything from the ASTs structure.</p>
<p>Despite similarity in structure, the HIR lowering is a necessary step in the pipeline where we get to inherit all of gccrs' necessary name resolution, unsafe gating and type checking.</p>
<h3 id="hir-creation"><a aria-hidden="true" tabindex="-1" href="#hir-creation"><span class="icon icon-link"></span></a>HIR Creation</h3>
<p>There must be an automatic way to do this. After all, the call <code>asm!</code> will appear everywhere, maybe in a block, maybe in another AST; how do we make sure that we can reach it and lower it correctly?</p>
<p>The answer is the visitor pattern, here are <a href="https://en.wikipedia.org/wiki/Visitor_pattern">some</a> of <a href="https://refactoring.guru/design-patterns/visitor">the</a> references to <a href="https://www.youtube.com/watch?v=dQw4w9WgXcQ">look into</a> if you're new to this pattern.</p>
<p>In short: The visitor pattern separate algorithms from the objects which they operate on.</p>
<p>In my opinion, this is where the visitor pattern shines the brightest: you only have to worry about your part. Let's get into the nitty gritty.</p>
<p>In the gccrs codebase, more specifically, the visitor class responsible for lowering AST to HIR is of the name <code>ASTLowering*</code>.</p>
<p>The most general AST lowering class is <code>ASTLoweringBase</code> where all other AST lowering class inherits from to overload as needed.</p>
<p>Since our AST inherits from ExprWithoutBlock, which is a type of Expr, we implement our lowering from <code>ASTLoweringExpr</code>. The following code block highlights the fact that we need to lower all of AST::Expr in our AST::InlineAsm, primarily in our AST::InlineAsmOperand; I show the pattern for the first two lowering of AST::InlineAsmOperand, as well as the method to create the HIR::InlineAsm.</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">HIR</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsmOperand</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">translate_operand_in</span><span style="color:#949CBB"> (</span><span style="color:#CA9EE6">const</span><span style="color:#E5C890"> AST</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsmOperand </span><span style="color:#81C8BE">&#x26;</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#CA9EE6">  auto</span><span style="color:#C6D0F5"> in_value </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> operand</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_in</span><span style="color:#949CBB"> ();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  struct</span><span style="color:#E5C890;font-style:italic"> HIR</span><span style="color:#C6D0F5">::</span><span style="color:#E5C890">InlineAsmOperand</span><span style="color:#949CBB">::</span><span style="color:#E5C890;font-style:italic">In</span><span style="color:#C6D0F5"> in (</span></span>
<span class="line"><span style="color:#C6D0F5">    in_value.reg</span><span style="color:#949CBB">,</span></span>
<span class="line"><span style="color:#C6D0F5">    std::</span><span style="color:#E5C890;font-style:italic">unique_ptr</span><span style="color:#949CBB">&#x3C;</span><span style="color:#E5C890;font-style:italic">Expr</span><span style="color:#949CBB">></span><span style="color:#C6D0F5"> (ASTLoweringExpr::</span><span style="color:#E5C890;font-style:italic">translate</span><span style="color:#C6D0F5"> (*in_value.expr.get ())))</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">  return</span><span style="color:#C6D0F5"> in</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C890">HIR</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsmOperand</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">translate_operand_out</span><span style="color:#949CBB"> (</span><span style="color:#CA9EE6">const</span><span style="color:#E5C890"> AST</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsmOperand </span><span style="color:#81C8BE">&#x26;</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#CA9EE6">  auto</span><span style="color:#C6D0F5"> out_value </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> operand</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_out</span><span style="color:#949CBB"> ();</span></span>
<span class="line"><span style="color:#CA9EE6">  struct</span><span style="color:#E5C890;font-style:italic"> HIR</span><span style="color:#C6D0F5">::</span><span style="color:#E5C890">InlineAsmOperand</span><span style="color:#949CBB">::</span><span style="color:#E5C890;font-style:italic">Out</span><span style="color:#C6D0F5"> out (out_value.reg</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> out_value.late</span><span style="color:#949CBB">,</span></span>
<span class="line"><span style="color:#C6D0F5">					 std::</span><span style="color:#E5C890;font-style:italic">unique_ptr</span><span style="color:#949CBB">&#x3C;</span><span style="color:#E5C890;font-style:italic">Expr</span><span style="color:#949CBB">></span><span style="color:#C6D0F5"> (</span></span>
<span class="line"><span style="color:#C6D0F5">					   ASTLoweringExpr::</span><span style="color:#E5C890;font-style:italic">translate</span><span style="color:#C6D0F5"> (</span></span>
<span class="line"><span style="color:#C6D0F5">					     *out_value.expr.get ())))</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">  return</span><span style="color:#C6D0F5"> out</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">}</span></span>
<span class="line"><span style="color:#737994;font-style:italic">// [...]</span></span>
<span class="line"><span style="color:#737994;font-style:italic">// We omit translate_operand_inout, translate_operand_split_in_out,</span></span>
<span class="line"><span style="color:#737994;font-style:italic">// translate_operand_const, translate_operand_sym,</span></span>
<span class="line"><span style="color:#737994;font-style:italic">// translate_operand_label for clarity</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">from_operand</span><span style="color:#949CBB"> (</span><span style="color:#CA9EE6">const</span><span style="color:#E5C890"> AST</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsmOperand </span><span style="color:#81C8BE">&#x26;</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#CA9EE6">  using</span><span style="color:#E5C890;font-style:italic"> RegisterType</span><span style="color:#81C8BE"> =</span><span style="color:#E5C890"> AST</span><span style="color:#949CBB">::</span><span style="color:#E5C890">InlineAsmOperand</span><span style="color:#949CBB">::</span><span style="color:#E5C890;font-style:italic">RegisterType</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">  auto</span><span style="color:#C6D0F5"> type </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> operand</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_register_type</span><span style="color:#949CBB"> ();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  switch</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">type</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">    {</span></span>
<span class="line"><span style="color:#CA9EE6">    case</span><span style="color:#E5C890"> RegisterType</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">In</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#CA9EE6">      return</span><span style="color:#8CAAEE;font-style:italic"> translate_operand_in</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">    case</span><span style="color:#E5C890"> RegisterType</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Out</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#CA9EE6">      return</span><span style="color:#8CAAEE;font-style:italic"> translate_operand_out</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">    case</span><span style="color:#E5C890"> RegisterType</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InOut</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#CA9EE6">      return</span><span style="color:#8CAAEE;font-style:italic"> translate_operand_inout</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">    case</span><span style="color:#E5C890"> RegisterType</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">SplitInOut</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#CA9EE6">      return</span><span style="color:#8CAAEE;font-style:italic"> translate_operand_split_in_out</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">    case</span><span style="color:#E5C890"> RegisterType</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Const</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#CA9EE6">      return</span><span style="color:#8CAAEE;font-style:italic"> translate_operand_const</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">    case</span><span style="color:#E5C890"> RegisterType</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Sym</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#CA9EE6">      return</span><span style="color:#8CAAEE;font-style:italic"> translate_operand_sym</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">    case</span><span style="color:#E5C890"> RegisterType</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Label</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#CA9EE6">      return</span><span style="color:#8CAAEE;font-style:italic"> translate_operand_label</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">    default</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">      rust_unreachable</span><span style="color:#949CBB"> ();</span></span>
<span class="line"><span style="color:#949CBB">    }</span></span>
<span class="line"><span style="color:#949CBB">}</span></span>
<span class="line"><span style="color:#CA9EE6">void</span></span>
<span class="line"><span style="color:#C6D0F5">ASTLoweringExpr</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">visit</span><span style="color:#949CBB"> (</span><span style="color:#E5C890">AST</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsm </span><span style="color:#81C8BE">&#x26;</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#CA9EE6">  auto</span><span style="color:#C6D0F5"> crate_num </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> mappings</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_current_crate</span><span style="color:#949CBB"> ();</span></span>
<span class="line"><span style="color:#E5C890">  Analysis</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">NodeMapping </span><span style="color:#8CAAEE;font-style:italic">mapping</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">crate_num</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_node_id</span><span style="color:#949CBB"> (),</span></span>
<span class="line"><span style="color:#C6D0F5">				 mappings</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_next_hir_id</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">crate_num</span><span style="color:#949CBB">),</span></span>
<span class="line"><span style="color:#C6D0F5">				 mappings</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_next_localdef_id</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">crate_num</span><span style="color:#949CBB">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E5C890">  std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">vector</span><span style="color:#81C8BE">&#x3C;</span><span style="color:#E5C890">HIR</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsmOperand</span><span style="color:#81C8BE">></span><span style="color:#C6D0F5"> hir_operands</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">  const</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">vector</span><span style="color:#81C8BE">&#x3C;</span><span style="color:#E5C890">AST</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsmOperand</span><span style="color:#81C8BE">></span><span style="color:#81C8BE"> &#x26;</span><span style="color:#C6D0F5">ast_operands </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_operands</span><span style="color:#949CBB"> ();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  for</span><span style="color:#949CBB"> (</span><span style="color:#CA9EE6">auto</span><span style="color:#81C8BE"> &#x26;</span><span style="color:#C6D0F5">operand </span><span style="color:#949CBB">:</span><span style="color:#C6D0F5"> ast_operands</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#C6D0F5">      hir_operands</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">push_back</span><span style="color:#949CBB"> (</span><span style="color:#8CAAEE;font-style:italic">from_operand</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">operand</span><span style="color:#949CBB">));</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C6D0F5">  translated</span></span>
<span class="line"><span style="color:#81C8BE">    =</span><span style="color:#CA9EE6;font-weight:bold"> new</span><span style="color:#E5C890"> HIR</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">InlineAsm</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_locus</span><span style="color:#949CBB"> (),</span><span style="color:#C6D0F5"> expr</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">is_global_asm</span><span style="color:#949CBB">,</span></span>
<span class="line"><span style="color:#C6D0F5">			  expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_template_</span><span style="color:#949CBB"> (),</span><span style="color:#C6D0F5"> expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_template_strs</span><span style="color:#949CBB"> (),</span></span>
<span class="line"><span style="color:#C6D0F5">			  hir_operands</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_clobber_abi</span><span style="color:#949CBB"> (),</span></span>
<span class="line"><span style="color:#C6D0F5">			  expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_options</span><span style="color:#949CBB"> (),</span><span style="color:#C6D0F5"> mapping</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#949CBB">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre>
<h3 id="unsafe-gating"><a aria-hidden="true" tabindex="-1" href="#unsafe-gating"><span class="icon icon-link"></span></a>Unsafe gating</h3>
<p>Since <code>asm!</code> is platform dependent and is inherently unsafe, i.e "you would get a <a href="https://en.wikipedia.org/wiki/Segmentation_fault">segmentation fault</a> with no probable stacktrace whatsoever", rust requires asm! to be in an unsafe block.</p>
<p>In the gccrs codebase, this <code>unsafe gating</code> is handled via <code>gcc/rust/checks/rust-unsafe-checker.h/cc</code>, again, employing the <a href="https://stackoverflow.com/questions/6762256/how-does-double-dispatch-work-in-visitor-pattern">double dispatch</a> functionality of the visitor pattern.</p>
<p>In our implementation, the unsafe checker maintains a stack of contexts named <code>unsafe_context</code> with a convenient boolean function <code>is_in_context</code>. At the time of our visit, we check if it is an unsafe context or not.</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">void</span></span>
<span class="line"><span style="color:#C6D0F5">UnsafeChecker</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">visit</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">InlineAsm </span><span style="color:#81C8BE">&#x26;</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#CA9EE6">  if</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">unsafe_context</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">is_in_context</span><span style="color:#949CBB"> ())</span></span>
<span class="line"><span style="color:#CA9EE6">    return</span><span style="color:#949CBB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  rust_error_at</span><span style="color:#949CBB"> (</span></span>
<span class="line"><span style="color:#C6D0F5">    expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_locus</span><span style="color:#949CBB"> (),</span><span style="color:#E5C890"> ErrorCode</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">E0133</span><span style="color:#949CBB">,</span></span>
<span class="line"><span style="color:#A6D189">    "use of inline assembly is unsafe and requires unsafe function or block"</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<blockquote>
<p>But Jas, why we wouldn't want the UnsafeChecker to just maintain a boolean <code>is_unsafe</code>, and once UnsafeChecker visit an unsafe block, we set the boolean <code>is_unsafe</code> to true and consequently false after the UnsafeChecker finishes visiting?</p>
</blockquote>
<p>This won't work if we are traversing an AST where we have nested unsafe block, thus a <code>template &#x3C;typename T> class StackedContexts</code> is needed. Let's examine an example where a single boolean failed and why we would need to use a stack.</p>
<p>In this example, there is only 1 unsafe context; the boolean implementation satisfies the unsafe requirement.</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">let a = 15;</span></span>
<span class="line"><span style="color:#C6D0F5">unsafe { // we set the boolean to true</span></span>
<span class="line"><span style="color:#C6D0F5">      // Now unsafe operations are allowed!</span></span>
<span class="line"><span style="color:#C6D0F5">      let b = *(&#x26;a as *const i32);</span></span>
<span class="line"><span style="color:#C6D0F5">      let c = std::mem::transmute&#x3C;i32, f32>(b);</span></span>
<span class="line"><span style="color:#C6D0F5">} // we set it to false</span></span>
<span class="line"><span style="color:#C6D0F5">// Yay me!!!</span></span></code></pre>
<p>But in the following case, where we have nested unsafe context, the boolean fails to recognize that we are still "unsafe"; thus needing a stack.</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#949CBB">+</span><span style="color:#A6D189">unsafe { // wraps the above unsafe context inside another unsafe context</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C6D0F5">    let a = 15;</span></span>
<span class="line"><span style="color:#C6D0F5">    unsafe { // we set the boolean to true</span></span>
<span class="line"><span style="color:#C6D0F5">         let b = *(&#x26;a as *const i32);</span></span>
<span class="line"><span style="color:#C6D0F5">         let c = std::mem::transmute&#x3C;i32, f32>(b);</span></span>
<span class="line"><span style="color:#C6D0F5">    } // we set it to false</span></span>
<span class="line"><span style="color:#C6D0F5">    // Yay me!!!</span></span>
<span class="line"><span style="color:#949CBB">+</span><span style="color:#A6D189"> }</span></span>
<span class="line"><span style="color:#949CBB">+</span><span style="color:#A6D189"> // Now unsafe operations are forbidden again, but the boolean is false</span></span>
<span class="line"><span style="color:#949CBB">+</span><span style="color:#A6D189"> let f = std::mem::transmute&#x3C;i32, f32>(15); // Uh-oh!</span></span></code></pre>
<p>Before every visit to an unsafe context, the unsafe checker inserts a context into the stack and after every visit, it pops that context out. A check to see if we are still unsafe checks if the stack is empty.
Readers interested in implementation details can check <code>gcc/rust/checks/errors/rust-unsafe-checker.h/cc</code> and <code>gcc/rust/util/rust-stacked-contexts.h</code></p>
<h3 id="type-checking"><a aria-hidden="true" tabindex="-1" href="#type-checking"><span class="icon icon-link"></span></a>Type checking</h3>
<p>From the rust compiler dev references:</p>
<blockquote>
<p>"The only ones that are of particular interest to rustc are NORETURN which makes asm! return ! instead of ()".</p>
</blockquote>
<p>We minimally represent this situation with the following implementation in <code>gcc/rust/typecheck/rust-hir-typecheck-expr.h/cc</code></p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">void</span></span>
<span class="line"><span style="color:#C6D0F5">TypeCheckExpr</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">visit</span><span style="color:#949CBB"> (</span><span style="color:#E5C890">HIR</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsm </span><span style="color:#81C8BE">&#x26;</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#737994;font-style:italic">  // We recursively typechecks its operands.</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  typecheck_inline_asm_operand</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  if</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">options</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">count</span><span style="color:#949CBB"> (</span><span style="color:#E5C890">AST</span><span style="color:#949CBB">::</span><span style="color:#E5C890">InlineAsmOption</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">NORETURN</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> ==</span><span style="color:#EF9F76"> 1</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#C6D0F5">    infered </span><span style="color:#81C8BE">=</span><span style="color:#CA9EE6;font-weight:bold"> new</span><span style="color:#E5C890"> TyTy</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">NeverType</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_mappings</span><span style="color:#949CBB"> ().</span><span style="color:#8CAAEE;font-style:italic">get_hirid</span><span style="color:#949CBB"> ());</span></span>
<span class="line"><span style="color:#CA9EE6">  else</span></span>
<span class="line"><span style="color:#C6D0F5">    infered</span></span>
<span class="line"><span style="color:#81C8BE">      =</span><span style="color:#E5C890"> TyTy</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">TupleType</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">get_unit_type</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_mappings</span><span style="color:#949CBB"> ().</span><span style="color:#8CAAEE;font-style:italic">get_hirid</span><span style="color:#949CBB"> ());</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>I omit the part where we also recursive typecheck and infer each expr in each operand for the next part</p>
<h3 id="resolution"><a aria-hidden="true" tabindex="-1" href="#resolution"><span class="icon icon-link"></span></a>Resolution</h3>
<p>Given an example that is part of <a href="https://github.com/Rust-GCC/gccrs/pull/3060/files#diff-693188f770da1bcaab140cfa09a7df64b510f5b17f21d9dc7627fc401776086a">inline_asm_mov_x86_rs</a> test case, where we refers to _x as a potential output:</p>
<pre><code>let mut _x: i32 = 0;
unsafe {
    asm!(
        "mov $5, {}",
        out(reg) _x
    );
}
</code></pre>
<p>We need a way to somehow link the <code>_x</code> that we refers inside the asm!, inside the unsafe block to the <code>_x</code> outside of the unsafe block.</p>
<p>The part that handles this is called name resolution. The <a href="https://rustc-dev-guide.rust-lang.org/name-resolution.html#:~:text=The%20name%20resolution%20in%20Rust,other%20via%20the%20ResolverAstLoweringExt%20trait.">Rust Compiler Dev Reference</a> goes into much details for this part.</p>
<p>Here I provide some implementation details for gccrs.</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#737994;font-style:italic">// Perform type checking on expr. Also runs type unification algorithm.</span></span>
<span class="line"><span style="color:#737994;font-style:italic">// Returns the unified type of expr</span></span>
<span class="line"><span style="color:#E5C890">TyTy</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">BaseType </span><span style="color:#81C8BE">*</span></span>
<span class="line"><span style="color:#C6D0F5">TypeCheckExpr</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">Resolve</span><span style="color:#949CBB"> (</span><span style="color:#E5C890">HIR</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Expr </span><span style="color:#81C8BE">*</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#C6D0F5">  TypeCheckExpr resolver</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#C6D0F5">  expr</span><span style="color:#949CBB">-></span><span style="color:#8CAAEE;font-style:italic">accept_vis</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">resolver</span><span style="color:#949CBB">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  if</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">resolver</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">infered </span><span style="color:#81C8BE">==</span><span style="color:#E78284"> nullptr</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#CA9EE6">    return</span><span style="color:#CA9EE6;font-weight:bold"> new</span><span style="color:#E5C890"> TyTy</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">ErrorType</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">-></span><span style="color:#8CAAEE;font-style:italic">get_mappings</span><span style="color:#949CBB"> ().</span><span style="color:#8CAAEE;font-style:italic">get_hirid</span><span style="color:#949CBB"> ());</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  auto</span><span style="color:#C6D0F5"> ref </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> expr</span><span style="color:#949CBB">-></span><span style="color:#8CAAEE;font-style:italic">get_mappings</span><span style="color:#949CBB"> ().</span><span style="color:#8CAAEE;font-style:italic">get_hirid</span><span style="color:#949CBB"> ();</span></span>
<span class="line"><span style="color:#C6D0F5">  resolver</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">infered</span><span style="color:#949CBB">-></span><span style="color:#8CAAEE;font-style:italic">set_ref</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">ref</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#C6D0F5">  resolver</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">context</span><span style="color:#949CBB">-></span><span style="color:#8CAAEE;font-style:italic">insert_type</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">-></span><span style="color:#8CAAEE;font-style:italic">get_mappings</span><span style="color:#949CBB"> (),</span><span style="color:#C6D0F5"> resolver</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">infered</span><span style="color:#949CBB">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  return</span><span style="color:#C6D0F5"> resolver</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">infered</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<h2 id="tree-generic"><a aria-hidden="true" tabindex="-1" href="#tree-generic"><span class="icon icon-link"></span></a>TREE (GENERIC)</h2>
<p>After we have finished setting up the AST and the HIR, we'll set up the TREE (GENERIC IR) infrastructure for our asm! node and after that, this IR will be lowered by gcc itself (GIMPLE IR), relieving us from duty.</p>
<p>The most central data structure used in the IR is <code>tree</code>, thus the name. From now, we'll refer to TREE IR as GENERIC IR.</p>
<p>The knowledge I learned about GENERIC is through this documentation <a href="https://gcc.gnu.org/onlinedocs/gccint/GENERIC.html">https://gcc.gnu.org/onlinedocs/gccint/GENERIC.html</a></p>
<h3 id="overall"><a aria-hidden="true" tabindex="-1" href="#overall"><span class="icon icon-link"></span></a>Overall</h3>
<p>Let's look at the definition and explore the tree code structures</p>
<p>From the GCC GENERIC:</p>
<blockquote>
<p>The purpose of GENERIC is simply to provide a language-independent way of representing an entire function in trees... If you can express it with the codes in gcc/tree.def, its GENERIC.</p>
</blockquote>
<p>Needless to say, we are to obtain a working knowledge of trees and tree codes :)</p>
<p>In the tree.def file, the tree codes are defined with the following structure:</p>
<pre><code>DEFTREECODE (name, string_name, class, operand_count)
</code></pre>
<p>where:</p>
<ul>
<li>name: The symbolic name of the tree node.</li>
<li>string_name: The human-readable string representing the node.</li>
<li>class: A classification for the nodes to follow a specific structure/functionality.</li>
<li>operand_count: The number of fields it takes to make the tree of this type.</li>
</ul>
<p>Let's give an example of some of the tree codes we're sure to use:</p>

























<table><thead><tr><th>Tree code definition</th><th>definition location in tree.def</th><th>Usage in our backend</th></tr></thead><tbody><tr><td>DEFTREECOE(TREE_LIST, "tree_list", tcc_exceptional, 0)</td><td>Line 54</td><td>Construction of operands</td></tr><tr><td>DEFTREECODE(STRING_CST, "string_cst", tcc_constant, 0)</td><td>Line 310</td><td>Construction of templated assembly code</td></tr><tr><td>DEFTREECODE(ASM_EXPR, "asm_expr", tcc_statement, 5)</td><td>Line 1008</td><td>Construction of inline assembly node</td></tr></tbody></table>
<h3 id="anatomy"><a aria-hidden="true" tabindex="-1" href="#anatomy"><span class="icon icon-link"></span></a>Anatomy</h3>
<p>I'll give a detailed look of the ones that are needed for the project.</p>
<h4 id="tree_list"><a aria-hidden="true" tabindex="-1" href="#tree_list"><span class="icon icon-link"></span></a>TREE_LIST</h4>
<p>TREE_LIST is ... just a list of trees... It has a TREE_VALUE, TREE_PURPOSE and TREE_CHAIN.</p>
<p>For the first two values, TREE_VALUE holds the element while TREE_PURPOSE gives a directive to later stages on what to do with this TREE_VALUE. In our tree usage section, we'll see that a tree list of register operands contains a TREE_VALUE of variables and a TREE_PURPOSE of register type, denoting if it's input or output register operands.</p>
<p>The TREE_CHAIN node points to the next element in the tree list, which is also a TREE_LIST.</p>
<p>In <a href="https://github.com/Rust-GCC/gccrs/blob/master/gcc/tree.cc">gcc/tree.cc</a>, a way to construct a tree list is</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#737994;font-style:italic">/* Return a newly created TREE_LIST node whose</span></span>
<span class="line"><span style="color:#737994;font-style:italic">   purpose and value fields are PARM and VALUE.  */</span></span>
<span class="line"><span style="color:#C6D0F5">tree</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">build_tree_list</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">tree parm</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> tree value MEM_STAT_DECL</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#C6D0F5">  tree t </span><span style="color:#81C8BE">=</span><span style="color:#8CAAEE;font-style:italic"> make_node</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">TREE_LIST PASS_MEM_STAT</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  TREE_PURPOSE</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">t</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> =</span><span style="color:#C6D0F5"> parm</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  TREE_VALUE</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">t</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> =</span><span style="color:#C6D0F5"> value</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">  return</span><span style="color:#C6D0F5"> t</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>A trend you'll see is that these underlying wrapper methods that construct our trees is that they'll start with a <code>tree t = make node(...)</code> or something that allocates memory for a tree, and then some  more <code>UPPER_CASE_SETTER_GETTER_METHOD(t) = ...</code> that follows.</p>
<h4 id="string_cst"><a aria-hidden="true" tabindex="-1" href="#string_cst"><span class="icon icon-link"></span></a>STRING_CST</h4>
<p>The STRING_CST is a tree constant of string. We'll use this type of TREE in a lot of places. For example, TREE_PURPOSE in the above TREE_LIST often uses some form of STRING_CST as a directive for later stages. We can also use it as a way to encode our unprocessed/templated inline assembly code as STRING_CST.</p>
<p>Sometimes, our strings can also be represented not by a STRING_CST but by ARRAY of type CHAR, and this is also acceptable. An example of this is in <code>cc</code> for the inline assembly code.</p>
<p>A call to construct STRING_CST: <code>build_string</code>, takes two parameters: a length of cstr, including the NULL delimiter and the cstr itself.</p>
<h4 id="asm_expr"><a aria-hidden="true" tabindex="-1" href="#asm_expr"><span class="icon icon-link"></span></a>ASM_EXPR</h4>
<p>An ASM_EXPR has 5 parameters it needs passing.</p>
<ul>
<li>An ASM_STRING of treecode STRING_CST</li>
<li>An ASM_OUTPUTS of treecode TREE_LIST</li>
<li>An ASM_INPUTS of treecode TREE_LIST</li>
<li>An ASM_CLOBBERS</li>
<li>An ASM_LABELS</li>
</ul>
<p>I omit the last two treecodes simply because the project hasn't had the capacity to explore the clobber and label functionality.</p>
<h3 id="tree-usage"><a aria-hidden="true" tabindex="-1" href="#tree-usage"><span class="icon icon-link"></span></a>TREE USAGE</h3>
<p>In constructing the tree representation of our inline assembly, we combine the existing infrastructure as well as our knowledge of tree codes.</p>
<p>More specifically, we rely on existing tree generation of our variables and raw c strings. We build ourselves a list of input and output registers to make up the ASM_EXPR tree.</p>
<p>The process of building our ASM_EXPR is as follow:</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">tree</span></span>
<span class="line"><span style="color:#C6D0F5">CompileAsm</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">tree_codegen_asm</span><span style="color:#949CBB"> (</span><span style="color:#E5C890">HIR</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsm </span><span style="color:#81C8BE">&#x26;</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#CA9EE6">  auto</span><span style="color:#C6D0F5"> asm_expr</span></span>
<span class="line"><span style="color:#81C8BE">    =</span><span style="color:#8CAAEE;font-style:italic"> asm_build_stmt</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">get_locus</span><span style="color:#949CBB"> (),</span><span style="color:#C6D0F5"> {</span><span style="color:#8CAAEE;font-style:italic">asm_construct_string_tree</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">),</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">					  asm_construct_outputs</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">),</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">					  asm_construct_inputs</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">),</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">					  asm_construct_clobber_tree</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">),</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">					  asm_construct_label_tree</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">)</span><span style="color:#C6D0F5">}</span><span style="color:#949CBB">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  ASM_INPUT_P</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">asm_expr</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> =</span><span style="color:#C6D0F5"> expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">is_simple_asm</span><span style="color:#949CBB"> ();</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  ASM_VOLATILE_P</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">asm_expr</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> =</span><span style="color:#EF9F76"> false</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  ASM_INLINE_P</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">asm_expr</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> =</span><span style="color:#C6D0F5"> expr</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">is_inline_asm</span><span style="color:#949CBB"> ();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  return</span><span style="color:#C6D0F5"> asm_expr</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C6D0F5">tree</span></span>
<span class="line"><span style="color:#C6D0F5">CompileAsm</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">asm_build_stmt</span><span style="color:#949CBB"> (</span></span>
<span class="line"><span style="color:#E5C890;font-style:italic">  location_t</span><span style="color:#C6D0F5"> loc</span><span style="color:#949CBB">,</span></span>
<span class="line"><span style="color:#CA9EE6">  const</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">array</span><span style="color:#81C8BE">&#x3C;</span><span style="color:#C6D0F5">tree</span><span style="color:#949CBB">,</span><span style="color:#E5C890"> CompileAsm</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">ASM_TREE_ARRAY_LENGTH</span><span style="color:#81C8BE">></span><span style="color:#81C8BE"> &#x26;</span><span style="color:#C6D0F5">trees</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#737994;font-style:italic">  // Prototype functiion for building an ASM_EXPR tree.</span></span>
<span class="line"><span style="color:#C6D0F5">  tree ret</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">  bool</span><span style="color:#C6D0F5"> side_effects</span><span style="color:#949CBB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C6D0F5">  ret </span><span style="color:#81C8BE">=</span><span style="color:#8CAAEE;font-style:italic"> make_node</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">ASM_EXPR</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  TREE_TYPE</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">ret</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> =</span><span style="color:#C6D0F5"> void_type_node</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  SET_EXPR_LOCATION</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">ret</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> loc</span><span style="color:#949CBB">);</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#C6D0F5">  side_effects </span><span style="color:#81C8BE">=</span><span style="color:#EF9F76"> false</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">  for</span><span style="color:#949CBB"> (</span><span style="color:#CA9EE6">size_t</span><span style="color:#C6D0F5"> i </span><span style="color:#81C8BE">=</span><span style="color:#EF9F76"> 0</span><span style="color:#949CBB">;</span><span style="color:#C6D0F5"> i </span><span style="color:#81C8BE">&#x3C;</span><span style="color:#C6D0F5"> trees</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">size</span><span style="color:#949CBB"> ();</span><span style="color:#C6D0F5"> i</span><span style="color:#81C8BE">++</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">    {</span></span>
<span class="line"><span style="color:#C6D0F5">      tree t </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> trees</span><span style="color:#949CBB">[</span><span style="color:#C6D0F5">i</span><span style="color:#949CBB">];</span></span>
<span class="line"><span style="color:#CA9EE6">      if</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">t </span><span style="color:#81C8BE">&#x26;&#x26;</span><span style="color:#81C8BE"> !</span><span style="color:#8CAAEE;font-style:italic">TYPE_P</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">t</span><span style="color:#949CBB">))</span></span>
<span class="line"><span style="color:#C6D0F5">	side_effects </span><span style="color:#81C8BE">|=</span><span style="color:#8CAAEE;font-style:italic"> TREE_SIDE_EFFECTS</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">t</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">      TREE_OPERAND</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">ret</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> i</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> =</span><span style="color:#C6D0F5"> t</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">  TREE_SIDE_EFFECTS</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">ret</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> |=</span><span style="color:#C6D0F5"> side_effects</span><span style="color:#949CBB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  return</span><span style="color:#C6D0F5"> ret</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>In the end, we add the tree to a list of statements in the following fashion:</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">void</span></span>
<span class="line"><span style="color:#C6D0F5">CompileExpr</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">visit</span><span style="color:#949CBB"> (</span><span style="color:#E5C890">HIR</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">InlineAsm </span><span style="color:#81C8BE">&#x26;</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#C6D0F5">  CompileAsm </span><span style="color:#8CAAEE;font-style:italic">asm_codegen</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">ctx</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#C6D0F5">  ctx</span><span style="color:#949CBB">-></span><span style="color:#8CAAEE;font-style:italic">add_statement</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">asm_codegen</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">tree_codegen_asm</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">expr</span><span style="color:#949CBB">));</span></span>
<span class="line"></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>Readers interested in the implementation details can refer to
<code>gcc/rust/backend/rust-compile-asm.h/cc</code> and <code>gcc/rust/backend/rust-compile-expr.h/cc</code></p>
<h2 id="results"><a aria-hidden="true" tabindex="-1" href="#results"><span class="icon icon-link"></span></a>Results</h2>
<p>Yayyy, we've finally relieved ourselves of code generation responsibilities, leaving the rest to GIMPLE, RTL, and gcc backend. The gccrs compiler can now generate correct instructions using the in and out register operands.</p>
<p>Below shows a few test cases that gccrs can now pass:</p>
<pre><code>/* { dg-do run { target arm*-*-* } } */
/* { dg-output "5\r*\n9\r*\n" }*/

#![feature(rustc_attrs)]
#[rustc_builtin_macro]
macro_rules! asm {
    () => {};
}

extern "C" {
    fn printf(s: *const i8, ...);
}

fn main() -> i32 {
    let mut x: i32 = 0;
    let mut _y: i32 = 9;

    unsafe {
        asm!(
            "mov {}, 5",
            out(reg) x
        );
        printf("%d\n\0" as *const str as *const i8, x);
    };

    unsafe {
        asm!(
            "mov {}, {}",
            in(reg) _y,
            out(reg) x
        );
        printf("%d\n\0" as *const str as *const i8, x);
    }

    0
}
</code></pre>
<h2 id="end-words"><a aria-hidden="true" tabindex="-1" href="#end-words"><span class="icon icon-link"></span></a>End words</h2>
<p>Participating in Google Summer of Code for gccrs  (and get paid for it hehe) has been my most gratifying and meaningful experience in software development. I am mentored by Arthur Cohen and Pierre-Emmanuel "PEP" Patry; Arthur helped me with the direction of the project and code reviews while Pierre-Emmanuel provided me with code infrastructure navigation and PR code-reviews, both of which are much needed.</p>
<p>The main struggles for me in this internship is three fold:</p>
<ul>
<li>Around designing the code infrastructure to support inline assembly.</li>
<li>Around constructing new AST/HIR/ Tree IR via inheritance.</li>
<li>In general, navigating around documentation and codebase.</li>
</ul>
<p>There wasn't much in terms of inline assembly related work before the summer of my internship in gccrs. This means that I need also to decide how to
create and structure my code in a way that fits into the codebase itself. At that moment, there was just this fear of not knowing what to do, not knowing what to code.
The concept is akin to create something out of thin air: you made up a class and named it AST, inherited this class from another AST and trust that the visitor
pattern will come to save you once you have also created your made-up parser to produce this made-up AST; and the pattern continues on.
That's the thing I love about software engineering in general and compiler more specifically.</p>
<p>Documentation, I've learned, is a some-what of dire thing in the compiler world. I'm now, in retrospect, extra grateful for Arthur when he wrote
up a whole docs detailing each step for me when I attempted a hard PR. Thank you Arthur moah moah moah I love you.</p>
<p>I am taking a graduate course in compiler right now (Compiler optimization) (beaten to a pulp) and will try to get into another graduate compiler class next semester (Implementation of PL) and work in the industry in 2025.</p>
<p>I would love to be informed of new opportunities. If you know of a compiler related job posting, please feel free to contact me at either:</p>
<ul>
<li><a href="mailto:tanghocle456@gmail.com">tanghocle456@gmail.com</a> (for job posting)</li>
<li><a href="mailto:jjasmine@berkeley.edu">jjasmine@berkeley.edu</a> (for job posting)</li>
<li><a href="https://x.com/thisisjjasmine">https://x.com/thisisjjasmine</a> (social media)</li>
</ul>
<p>Thank you for reading :)</p></div></article></div><button class="bottom-4 right-4 fixed"><div class="inline text-2xl font-bold border-black border-2 rounded  p-0 m-0 h-100 w-100"></div></button><footer class="footer self-center justify-center gap-2 pt-4 items-center italic "><p>I&#x27;m looking for new grad compiler work, please email at jjasmine@berkeley.edu</p><p>Built by Jasmine with NextJS, TailwindCSS, and a tonnn of loveee :)</p></footer><script src="/_next/static/chunks/webpack-024c71c063ddb8d8.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[8173,[\"173\",\"static/chunks/173-ad05a37061268ac6.js\",\"565\",\"static/chunks/565-d3001cb0b7ac580c.js\",\"177\",\"static/chunks/app/layout-5c184bc8512acba2.js\"],\"\"]\n3:I[5244,[],\"\"]\n4:I[3866,[],\"\"]\n5:I[1168,[\"173\",\"static/chunks/173-ad05a37061268ac6.js\",\"565\",\"static/chunks/565-d3001cb0b7ac580c.js\",\"177\",\"static/chunks/app/layout-5c184bc8512acba2.js\"],\"default\"]\n7:I[6213,[],\"OutletBoundary\"]\n9:I[6213,[],\"MetadataBoundary\"]\nb:I[6213,[],\"ViewportBoundary\"]\nd:I[4835,[],\"\"]\n:HL[\"/_next/static/media/7385e8d9d3c5518f-s.p.ttf\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/ttf\"}]\n:HL[\"/_next/static/css/4c262d18fc086fff.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"ed-cn5hQCt5_ozp7QkPPn\",\"p\":\"\",\"c\":[\"\",\"posts\",\"what_I_did_for_gsoc_2024\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"what_I_did_for_gsoc_2024\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/4c262d18fc086fff.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"px-4 py-4\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_d4e0c8 flex flex-col min-h-screen\",\"children\":[[\"$\",\"$L2\",null,{\"href\":\"/\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex justify-center items-center py-4 \",\"children\":[\"$\",\"h1\",null,{\"className\":\"text-4xl font-bold\",\"children\":\"Jasmine Tang\"}]}]}],[\"$\",\"div\",null,{\"className\":\"flex-1\",\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"$L5\",null,{}],[\"$\",\"footer\",null,{\"className\":\"footer self-center justify-center gap-2 pt-4 items-center italic \",\"children\":[[\"$\",\"p\",null,{\"children\":\"I'm looking for new grad compiler work, please email at jjasmine@berkeley.edu\"}],[\"$\",\"p\",null,{\"children\":\"Built by Jasmine with NextJS, TailwindCSS, and a tonnn of loveee :)\"}]]}]]}]}]]}],{\"children\":[\"posts\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"id\",\"what_I_did_for_gsoc_2024\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L6\",null,[\"$\",\"$L7\",null,{\"children\":\"$L8\"}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"xYJaJ5Byd1ZG2l1CaIg5m\",{\"children\":[[\"$\",\"$L9\",null,{\"children\":\"$La\"}],[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"e:T1533f,"])</script><script>self.__next_f.push([1,"\u003cnav class=\"toc\"\u003e\u003col class=\"toc-level toc-level-1\"\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#introduction\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#main-contribution-aspects\"\u003eMain contribution aspects\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#issues-and-prs\"\u003eIssues and PRs\u003c/a\u003e\u003col class=\"toc-level toc-level-2\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#issues\"\u003eIssues\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#prs\"\u003ePRs\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h1\"\u003e\u003ca class=\"toc-link toc-link-h1\" href=\"#gccrs-inline-assembly\"\u003eGCCRS Inline Assembly\u003c/a\u003e\u003col class=\"toc-level toc-level-3\"\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#purpose\"\u003ePurpose\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#syntax\"\u003eSyntax\u003c/a\u003e\u003col class=\"toc-level toc-level-4\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#grammar\"\u003eGrammar\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#syntax-example\"\u003eSyntax example\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#overall-architecture\"\u003eOverall architecture\u003c/a\u003e\u003col class=\"toc-level toc-level-4\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#definition\"\u003eDefinition\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#architecture\"\u003eArchitecture\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#related-files\"\u003eRelated files\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#architecture-visualization\"\u003eArchitecture visualization\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#ast\"\u003eAST\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#parser\"\u003eParser\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#ast-to-hir\"\u003eAST to HIR\u003c/a\u003e\u003col class=\"toc-level toc-level-4\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#hir-creation\"\u003eHIR Creation\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#unsafe-gating\"\u003eUnsafe gating\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#type-checking\"\u003eType checking\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#resolution\"\u003eResolution\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#tree-generic\"\u003eTREE (GENERIC)\u003c/a\u003e\u003col class=\"toc-level toc-level-4\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#overall\"\u003eOverall\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#anatomy\"\u003eAnatomy\u003c/a\u003e\u003col class=\"toc-level toc-level-5\"\u003e\u003cli class=\"toc-item toc-item-h4\"\u003e\u003ca class=\"toc-link toc-link-h4\" href=\"#tree_list\"\u003eTREE_LIST\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h4\"\u003e\u003ca class=\"toc-link toc-link-h4\" href=\"#string_cst\"\u003eSTRING_CST\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h4\"\u003e\u003ca class=\"toc-link toc-link-h4\" href=\"#asm_expr\"\u003eASM_EXPR\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#tree-usage\"\u003eTREE USAGE\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#results\"\u003eResults\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#end-words\"\u003eEnd words\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/nav\u003e\u003cp\u003eHi everyone, this article is a requirement for my GSoc Final Submission, linking directly to the submission.\u003c/p\u003e\n\u003cp\u003eThis article will include the summary of my contribution, where you can find all my filed issues and PRs.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eEdit\u003c/strong\u003e:\u003c/p\u003e\n\u003cp\u003eI would love to be informed of new-grad opportunities for Summer 2025. If you know of a compiler related job posting, please feel free to contact me at either:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"mailto:tanghocle456@gmail.com\"\u003etanghocle456@gmail.com\u003c/a\u003e (for job posting)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"mailto:jjasmine@berkeley.edu\"\u003ejjasmine@berkeley.edu\u003c/a\u003e (for job posting)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://x.com/thisisjjasmine\"\u003ehttps://x.com/thisisjjasmine\u003c/a\u003e (social media)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"introduction\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#introduction\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eThis summer I worked on the \u003ca href=\"https://github.com/Rust-GCC/gccrs\"\u003egccrs\u003c/a\u003e project, a GCC Front-end for Rust.\u003c/p\u003e\n\u003cp\u003egccrs is a project to implement the Rust programming languages from scratch in the GCC codebase in order for rust to be able to be compiled to a wider amount of targets. It currently targets the version 1.49 of Rust and is supported by Open Source Security and Embecosm.\u003c/p\u003e\n\u003cp\u003eBy doing this, it helps with a couple things:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eTargets architecture not available with rustc due to the use of LLVM. (SuperH for example, which powers the Dreamcast!)\u003c/li\u003e\n\u003cli\u003eBenefit from the existing GCC ecosystem.\u003c/li\u003e\n\u003cli\u003eHelp with acceptance of Rust in the Linux kernel\u003c/li\u003e\n\u003cli\u003eHelp with acceptance of Rust in other fields, where having multiple compilers helps.\u003c/li\u003e\n\u003cli\u003eEnable building Rust on targets with very old C++ compilers! (Targets with at least GCC version 4.8 (which released March 22, 2013) can build Rust)\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"main-contribution-aspects\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#main-contribution-aspects\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eMain contribution aspects\u003c/h2\u003e\n\u003cp\u003eOverall, I contributed in 3 main aspects:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eMy main project\u003c/strong\u003e - Inline Assembly in rust: I programmed the parser, set up the code infrastructure for TREE IR generation in the backend, along with AST, HIR lowering and typechecking.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eCI/CD\u003c/strong\u003e: I helped maintain and improve the CI/CD pipeline. This includes resolving dependency issues in GitHub Actions, adding support for 32 bit CI and glibc compliance CI.\nI also created a docker-compose dev environment for MacOS-based contributors, with all libraries and dependency installed; this helps us bypass MacOS's annoying build and link issues.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eCode maintainance/Bug Fixes/Code Review\u003c/strong\u003e: I maintained the code base via issues filed by my mentor and other contributors. I also helped fix some minor bugs in IR lowering and typechecking. I also help review some new, simple PRs for contributors.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"issues-and-prs\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#issues-and-prs\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eIssues and PRs\u003c/h2\u003e\n\u003cp\u003eBelow is all the issues, PRs and commits I've made to the \u003ca href=\"https://github.com/Rust-GCC/gccrs\"\u003egccrs\u003c/a\u003e repository, up to Aug 22 2024, after producing this I ended up closing some resolved issues that has been silently addressed in some PRs.\u003c/p\u003e\n\u003cp\u003eThe tables are produced via \u003ccode\u003egh\u003c/code\u003e cli tool and some \u003ccode\u003eI use nvim btw\u003c/code\u003e love :)\u003c/p\u003e\n\u003ch3 id=\"issues\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#issues\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eIssues\u003c/h3\u003e\n\u003cp\u003eHere's a formatted version of all my issues, up to Aug 22 2024, procured via \u003ccode\u003egh issue list -A badumbatish --state all\u003c/code\u003e:\u003c/p\u003e\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003ctable\u003e\u003cthead\u003e\u003ctr\u003e\u003cth\u003eIssue Number\u003c/th\u003e\u003cth\u003eIssue Status\u003c/th\u003e\u003cth\u003eIssue Title\u003c/th\u003e\u003cth\u003eLabels\u003c/th\u003e\u003cth\u003eFiled Date\u003c/th\u003e\u003c/tr\u003e\u003c/thead\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3102\"\u003e3102\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eSet up the rest of HIR pipeline in InlineAsm\u003c/td\u003e\u003ctd\u003e\u003c/td\u003e\u003ctd\u003e2024-07-27T03:20:50Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3099\"\u003e3099\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eparse_expr not stopping on =\u003e\u003c/td\u003e\u003ctd\u003e\u003c/td\u003e\u003ctd\u003e2024-07-25T19:41:07Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3072\"\u003e3072\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003easm parser lacking \u003ccode\u003elabel\u003c/code\u003e parse functionality\u003c/td\u003e\u003ctd\u003e\u003c/td\u003e\u003ctd\u003e2024-07-01T08:54:12Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3069\"\u003e3069\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eMake asm parser stores parse result\u003c/td\u003e\u003ctd\u003e\u003c/td\u003e\u003ctd\u003e2024-06-25T16:12:44Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3062\"\u003e3062\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eCLOSED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eAdd ExprType::InlineAsm variant to ExprType enum\u003c/td\u003e\u003ctd\u003e\u003c/td\u003e\u003ctd\u003e2024-06-24T13:23:55Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3061\"\u003e3061\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eTypechecking of asm! failed in \u003ccode\u003elet _\u003c/code\u003e\u003c/td\u003e\u003ctd\u003ebug\u003c/td\u003e\u003ctd\u003e2024-06-24T13:24:07Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3057\"\u003e3057\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003easm! macro failed to exhaustively parse all of options(), clobber_abis(), and register operands\u003c/td\u003e\u003ctd\u003ebug, expansion\u003c/td\u003e\u003ctd\u003e2024-06-18T13:32:24Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3052\"\u003e3052\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eFully incorporate tl::expected into InlineAsm parsing\u003c/td\u003e\u003ctd\u003e\u003c/td\u003e\u003ctd\u003e2024-06-14T09:54:17Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3051\"\u003e3051\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eCLOSED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eRemove unnecessary #include from rust-expr.h\u003c/td\u003e\u003ctd\u003egood-first-pr, cleanup\u003c/td\u003e\u003ctd\u003e2024-07-11T09:23:53Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3050\"\u003e3050\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eCLOSED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eSafe guard InlineAsm-related structs\u003c/td\u003e\u003ctd\u003e\u003c/td\u003e\u003ctd\u003e2024-07-03T09:58:52Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/3048\"\u003e3048\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eHandle outer attributes properly for inline assembly\u003c/td\u003e\u003ctd\u003e\u003c/td\u003e\u003ctd\u003e2024-06-14T09:55:37Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/issues/2937\"\u003e2937\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eCLOSED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eDocker image and container for Mac\u003c/td\u003e\u003ctd\u003e\u003c/td\u003e\u003ctd\u003e2024-05-10T14:53:25Z\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003eThe closed/filed rate is 4/8, which is not high. Through out writing the parser and the backend infra, I realized that there are these little issues that's just easier to just fix and not necessary filed. There is also issues that are discussed via \u003ca href=\"https://gist.github.com/badumbatish/9823719ef359a58b131220d9d79d2aec\"\u003ehackmd notes\u003c/a\u003e between me and my mentor that are not necessarily filed via GitHub.\u003c/p\u003e\n\u003ch3 id=\"prs\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#prs\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003ePRs\u003c/h3\u003e\n\u003cp\u003eHere's a formatted version of all my pull requests, up to Aug 22 2024, procured via \u003ccode\u003egh pr list -A badumbatish --state all\u003c/code\u003e:\u003c/p\u003e\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003ctable\u003e\u003cthead\u003e\u003ctr\u003e\u003cth\u003ePR Number\u003c/th\u003e\u003cth\u003ePR Status\u003c/th\u003e\u003cth\u003ePR Title\u003c/th\u003e\u003cth\u003eFiled Date\u003c/th\u003e\u003c/tr\u003e\u003c/thead\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3133\"\u003e3133\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eFix the disorder struct and class in inline asm\u003c/td\u003e\u003ctd\u003e2024-08-20T07:41:34Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3119\"\u003e3119\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eAdd running cicd 32bit\u003c/td\u003e\u003ctd\u003e2024-08-04T19:47:37Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3109\"\u003e3109\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eInline asm resolve expr\u003c/td\u003e\u003ctd\u003e2024-07-31T03:41:32Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3103\"\u003e3103\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eInline asm hir pipeline\u003c/td\u003e\u003ctd\u003e2024-07-27T08:22:57Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3098\"\u003e3098\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eFix the parser's operand and flags storage\u003c/td\u003e\u003ctd\u003e2024-07-25T16:38:11Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3093\"\u003e3093\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eChange assertion of asm operand constructor\u003c/td\u003e\u003ctd\u003e2024-07-21T22:46:28Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3090\"\u003e3090\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eAdded options for ParseMode\u003c/td\u003e\u003ctd\u003e2024-07-20T07:48:51Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3081\"\u003e3081\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003ePin node16 by allowing old version\u003c/td\u003e\u003ctd\u003e2024-07-10T02:32:08Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3074\"\u003e3074\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eSafe-guard InlineAsm structs\u003c/td\u003e\u003ctd\u003e2024-07-01T00:43:59Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3073\"\u003e3073\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eStore parse result of parse_format_string(s)\u003c/td\u003e\u003ctd\u003e2024-07-01T00:24:42Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3063\"\u003e3063\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eAdded ExprType::InlineAsm\u003c/td\u003e\u003ctd\u003e2024-06-23T18:06:02Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3060\"\u003e3060\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eDRAFT\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eAsm generic il codegen\u003c/td\u003e\u003ctd\u003e2024-06-23T14:11:44Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3059\"\u003e3059\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eAdd test case for using asm! outside of unsafe \u003c/td\u003e\u003ctd\u003e2024-06-22T06:40:27Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3053\"\u003e3053\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eincorporate tl::expected into InlineAsm parsing\u003c/td\u003e\u003ctd\u003e2024-06-14T06:08:01Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3011\"\u003e3011\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eRemove cstddef header from rust-fmt\u003c/td\u003e\u003ctd\u003e2024-05-19T03:03:05Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3002\"\u003e3002\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eMake gccrs recognize negative_impls\u003c/td\u003e\u003ctd\u003e2024-05-15T22:06:45Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/2982\"\u003e2982\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eInline asm\u003c/td\u003e\u003ctd\u003e2024-05-08T19:41:27Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/2981\"\u003e2981\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eOPEN\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eCleanup macro invoc\u003c/td\u003e\u003ctd\u003e2024-05-08T17:47:46Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/2980\"\u003e2980\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eFix all tests in execute to be \\r\\n\u003c/td\u003e\u003ctd\u003e2024-05-08T06:47:12Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/2941\"\u003e2941\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eAdd an alternative solution on MacOS\u003c/td\u003e\u003ctd\u003e2024-04-05T03:10:57Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/2911\"\u003e2911\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eStore visibility properly in ExternalTypeItem: Fixes #2897\u003c/td\u003e\u003ctd\u003e2024-03-09T22:46:59Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/2895\"\u003e2895\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eAdd error emitting when we can't resolve id expr\u003c/td\u003e\u003ctd\u003e2024-03-01T10:40:34Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/2874\"\u003e2874\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eFirst stab at issue 2855 by splitting the two maps\u003c/td\u003e\u003ctd\u003e2024-02-25T21:13:02Z\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/2871\"\u003e2871\u003c/a\u003e\u003c/td\u003e\u003ctd\u003e\u003cstrong\u003eMERGED\u003c/strong\u003e\u003c/td\u003e\u003ctd\u003eFix FixMe in changing return type of builtin_macro_from_string() from BuiltinMacro to tl::optional/\u003cdiv\u003e\u003c/div\u003e\u003c/td\u003e\u003ctd\u003e2024-02-23T21:22:58Z\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003eThe merged/filed rate is 22/25. Half of the PRs are easy to fix / fixable within a short amount of time (Code maintanence aspect). The other half is medium in difficulty, related to my summer project (Project aspect).\u003c/p\u003e\n\u003ch1 id=\"gccrs-inline-assembly\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#gccrs-inline-assembly\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eGCCRS Inline Assembly\u003c/h1\u003e\n\u003cp\u003eAlright, let's try to understand what I did this summer in greater detail.\u003c/p\u003e\n\u003cp\u003eThis write up will try to avoid lower level, implementation-based details but will let you walk away knowing what I, \u003ca href=\"https://badumbatish.github.io/\"\u003ebadumbatish\u003c/a\u003e did this summer :)\u003c/p\u003e\n\u003cp\u003eAlthough I won't post much code, I'll still provide links to my PRs for interested readers. Inspirations  includes contributors from the rust codebase and gccrs codebase. More specifically, \u003ca href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_builtin_macros/src/asm.rs\"\u003easm.rs\u003c/a\u003e from rustc, Arthur, Pierre-Emmanuel and Mahad from gccrs.\u003c/p\u003e\n\u003ch2 id=\"purpose\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#purpose\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003ePurpose\u003c/h2\u003e\n\u003cp\u003eAssembly are often used by programmers as a precise instrument in case that compiler's high level constructs are too coarse for the programmers' intent. With the advent of inline  assembly, you can do this without having to create a seperate assembly file, maintaining the stackframe, register invariants, juggling different platforms and different calling conventions by yourself, etc...\u003c/p\u003e\n\u003cp\u003eThe purpose of my project is to provide support for inline assembly in gccrs. With respect to Rust's memory safety guarantees as well as the context of assembly languages usages in today's modern era, the project aims to alleviate the complexity from the programmmers while providing precautions and safeguards with unsafe blocks requirements and higher level constructs such as register operands, compared to raw hardware registers.\u003c/p\u003e\n\u003ch2 id=\"syntax\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#syntax\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eSyntax\u003c/h2\u003e\n\u003cp\u003eIn this section we'll take a look at the syntax of inline assembly, as well as dissecting some examples.\u003c/p\u003e\n\u003ch3 id=\"grammar\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#grammar\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eGrammar\u003c/h3\u003e\n\u003cp\u003eThe syntax for inline assembly is quite simple. This is taken from the \u003ca href=\"https://doc.rust-lang.org/reference/inline-assembly.html\"\u003eRust Reference website\u003c/a\u003e :\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eformat_string := STRING_LITERAL / RAW_STRING_LITERAL\ndir_spec := \"in\" / \"out\" / \"lateout\" / \"inout\" / \"inlateout\"\nreg_spec := \u0026#x3C;register class\u003e / \"\\\"\" \u0026#x3C;explicit register\u003e \"\\\"\"\noperand_expr := expr / \"_\" / expr \"=\u003e\" expr / expr \"=\u003e\" \"_\"\nreg_operand := [ident \"=\"] dir_spec \"(\" reg_spec \")\" operand_expr\nclobber_abi := \"clobber_abi(\" \u0026#x3C;abi\u003e *(\",\" \u0026#x3C;abi\u003e) [\",\"] \")\"\noption := \"pure\" / \"nomem\" / \"readonly\" / \"preserves_flags\" / \"noreturn\" / \"nostack\" / \"att_syntax\" / \"raw\"\noptions := \"options(\" option *(\",\" option) [\",\"] \")\"\noperand := reg_operand / clobber_abi / options\nasm := \"asm!(\" format_string *(\",\" format_string) *(\",\" operand) [\",\"] \")\"\nglobal_asm := \"global_asm!(\" format_string *(\",\" format_string) *(\",\" operand) [\",\"] \")\"\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe topmost level, or the start of the parse rule is either \u003ccode\u003easm\u003c/code\u003e or \u003ccode\u003eglobal_asm\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eThe inline assembly code is represented by \u003ccode\u003eformat_string\u003c/code\u003e. The other aspect is \u003ccode\u003eoperand\u003c/code\u003e, which includes \u003ccode\u003ereg_operand\u003c/code\u003e, \u003ccode\u003eclobber_abi\u003c/code\u003e, and \u003ccode\u003eoptions\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eMore information about different types of operand can be referred to from \u003ca href=\"https://doc.rust-lang.org/reference/inline-assembly.html\"\u003ethe reference\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eKeep in mind that the way we see this division of the grammar is how we'll construct our AST subsequently, our parser.\u003c/p\u003e\n\u003ch3 id=\"syntax-example\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#syntax-example\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eSyntax example\u003c/h3\u003e\n\u003cp\u003eLet's look at some inline assembly examples pulled from the \u003ca href=\"https://doc.rust-lang.org/rust-by-example/unsafe/asm.html\"\u003eRust by example website\u003c/a\u003e.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThis is the simplest form, only including a no-op instruction\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003euse\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e std\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003earch\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003easm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003eunsafe\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e    asm!\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#A6D189\"\u003e\"nop\"\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cul\u003e\n\u003cli\u003eOf course, more complex (non-simple) form of inline assembly requires some extra functionality:\u003c/li\u003e\n\u003c/ul\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003euse\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e std\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003earch\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003easm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003elet\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e x\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003e u64\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003eunsafe\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e    asm!\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#A6D189\"\u003e\"mov \u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e{}\u003c/span\u003e\u003cspan style=\"color:#A6D189\"\u003e, 5\"\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e out\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ereg\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e x\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eassert_eq!\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ex\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e 5\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis requires the operand functionality, more specifically the reg_operand category. In simple terms, the \u003ccode\u003e{}\u003c/code\u003e in the format string (template string) (designated by the double quote symbol) refers to the variable x. The out(reg) asks the compiler to substitute the  by the register used to store x and to assume the inline assembly will only write to this register and not expect any particular initial value. On the ARM platform architecture, in the raw assembly, the \u003ccode\u003e{}\u003c/code\u003e in the formatted string would be replaced with a  register allocated to \u003ccode\u003ex\u003c/code\u003e, such as the \u003ccode\u003ex0\u003c/code\u003e register.\u003c/p\u003e\n\u003cp\u003eAn as a demonstrate, in the following code, \u003ccode\u003emove {}, 5\u003c/code\u003e is transformed into \u003ccode\u003emov x0, 5\u003c/code\u003e\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    .cfi_def_cfa_offset \u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e32\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    .cfi_offset \u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e29\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e, -\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e32\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    .cfi_offset \u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e30\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e, -\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e24\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    ...\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e#APP\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e// \u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e6\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e \"asm_mov.rs\" \u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e1\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    mov\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e x0, \u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e5\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e// \u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e \"\" \u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e2\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e#NO_APP\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    ...\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"overall-architecture\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#overall-architecture\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eOverall architecture\u003c/h2\u003e\n\u003cp\u003eIn this section we provide common compiler norms, discuss the overall architecture of the project as well as some of the most relevant files to the project.\u003c/p\u003e\n\u003cp\u003eThe end of this section provides a high level graph for readers to visualize the architecture.\u003c/p\u003e\n\u003ch3 id=\"definition\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#definition\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eDefinition\u003c/h3\u003e\n\u003cp\u003eBefore giving an overview of the architecture of the project, it's necessary to give context to common compiler norms:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eType checking: The process of ensuring that variables and expressions have types that align with the expected types (explicitly or implicitly) defined in the code, preventing type errors.\u003c/li\u003e\n\u003cli\u003eName resolution: The process of matching names (such as variables, functions, and types) in the code with their corresponding declarations to ensure correct scoping and accessibility.\u003c/li\u003e\n\u003cli\u003eUnsafe gating: The mechanism that restricts certain operations (e.g., raw pointer casting, inline assembly) to unsafe blocks, indicating that the programmer takes responsibility for upholding safety guarantees.\u003c/li\u003e\n\u003cli\u003eAST: Stands for Abstract syntax tree and is used to represent a program or a code snippet. Usually in a compiler, this data structure is the product of a parser. The compiler can then lower this data structure into a different data structure called HIR, which will be defined in the next sentence.\u003c/li\u003e\n\u003cli\u003eHIR: High Level Intermediate Representation. After AST, the compiler lowers the AST into a different representation. In gccrs, this is where different validations such as type checking, name resolution and unsafe gating happens. The compiler then lower this IR into what's known as GENERIC IL\u003c/li\u003e\n\u003cli\u003eTREE (GENERIC IL): GENERIC Intermediate Language. gcc's language-independent way of representing different constructs in trees.\u003c/li\u003e\n\u003cli\u003eGIMPLE: (From gcc:) is a three-address representation derived from GENERIC by breaking down GENERIC expressions into tuples of no more than 3 operands (with some exceptions like function calls).\u003c/li\u003e\n\u003cli\u003eGCC Backend: where gcc starts to generate archiecture-dependent code.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"architecture\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#architecture\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eArchitecture\u003c/h3\u003e\n\u003cp\u003eI haven't talked about how we should handle this. Obviously the plan is to have the compiler recognize the syntax so a parser is required, but what happens after that?\u003c/p\u003e\n\u003cp\u003eWell, like our cousin (or sibling?) rustc, the gccrs compiler itself has the AST, and then HIR. After that, gccrs converts its HIR into gcc's TREE (GENERIC IL) format. At this stage, gcc handles the conversion from inline assembly tree to gimple and then eventually raw architecture-dependent assembly code via gcc's backend.\u003c/p\u003e\n\u003cp\u003eWe need to also set up other stuff such as inline assembly validation, type checking, name resolution, etc etc. This will be mention in passing as it is relevant to Rust's safety feature.\u003c/p\u003e\n\u003ch3 id=\"related-files\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#related-files\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eRelated files\u003c/h3\u003e\n\u003cp\u003eThe related files for this issue includes\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003egcc/rust/expand/rust-macrobuiltins-asm.h/cc\u003c/code\u003e: Where the parsing of an \u003ccode\u003easm!()\u003c/code\u003e happens.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egcc/rust/ast/rust-expr.h\u003c/code\u003e: Where the ast of an inline asm is defined.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egcc/rust/hir/tree/rust-hir-expr.h\u003c/code\u003e: Where the HIR (high level ir) of an inline asm is defined.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egcc/rust/backend/rust-compile-asm.h/cc\u003c/code\u003e: where the backend of inline asm starts processing.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"architecture-visualization\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#architecture-visualization\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eArchitecture visualization\u003c/h3\u003e\n\u003cp\u003eThe picture below depicts the project's pipeline.\n\u003cimg src=\"/blogs/mermaid_gsoc_arch1.svg\" alt=\"mermaid_gsoc_arch\"\u003e\u003c/p\u003e\n\u003ch2 id=\"ast\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#ast\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eAST\u003c/h2\u003e\n\u003cp\u003eThe AST follows the structure that the syntax provides.\u003c/p\u003e\n\u003cp\u003eAt the end of PR \u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3060\"\u003e3060\u003c/a\u003e, it takes its structure from \u003ca href=\"https://github.com/rust-lang/rust/blob/master/compiler/rustc_builtin_macros/src/asm.rs\"\u003easm.rs\u003c/a\u003e. It inherits from the ExprWithoutBlock, which inherits from Expr, indicating that an asm! call is an expr.\u003c/p\u003e\n\u003cp\u003eHere, I give the high level structure of the AST related to inline assembly. In the gccrs codebase, the AST are represented with classes and structs.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eInlineAsm: this class inherits from ExprWithoutBlock, and contains containers for templated strings, operands, named arguments, register arguments, clobber abi, and options.\u003c/li\u003e\n\u003cli\u003eTupleTemplateStr: stands for a templated string where we store a location as well as the internet string\u003c/li\u003e\n\u003cli\u003eInlineAsmOperand: represents an operand in inline assembly, which can be a register operand (class InlineAsmRegOrRegClass) or some non-register operands such as a Sym or a Label.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eBy having a close mapping between the three things: Syntax, AST, and parsing, we lower our mental capacity in implementing them, maintaining a clear mental model if ever in need of debugging.\u003c/p\u003e\n\u003ch2 id=\"parser\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#parser\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eParser\u003c/h2\u003e\n\u003cp\u003eNice, now let's talk about the parser :)\u003c/p\u003e\n\u003cp\u003eWe'll be writing a simple recursive descent parser as described by our syntax section.\u003c/p\u003e\n\u003cp\u003eAs referenced above in the syntax section, the parser consists of 4 levels, 0 to 3, maintaining a clear and simple mapping between the parser and the syntax:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe first level (0), shows the entrance of the parser.\u003c/li\u003e\n\u003cli\u003eThe second level (1) describes the main loop of the parser, where we repeatedly parse all the formatted strings first, then operands then perform AST validation.\u003c/li\u003e\n\u003cli\u003eThe third and fourth level goes into the subcategory of each aspect of the second level and so on: parsing formatted strings means repeatedly parsing \u003cem\u003ea\u003c/em\u003e formatted string and parsing options means repeatedly parsing \u003cem\u003ean\u003c/em\u003e option, etc etc.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe diagram below shows the totality of the parser architecture, where the two greenish block in level 0 represents the starting point and the ending point of the parser.\n\u003cimg src=\"https://hackmd.io/_uploads/r1tIddrhR.svg\" alt=\"Untitled diagram-2024-09-04-060350\"\u003e\u003c/p\u003e\n\u003cp\u003eInterested readers can look into the master branch, in the file \u003ccode\u003egcc/rust/expand/rust-macro-builtins-asm.h/cc\u003c/code\u003e for the implementation detail of the parser.\u003c/p\u003e\n\u003ch2 id=\"ast-to-hir\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#ast-to-hir\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eAST to HIR\u003c/h2\u003e\n\u003cp\u003eAfter we have gotten our AST, the next step is lowering it into HIR.\u003c/p\u003e\n\u003cp\u003eSince the inline assembly ASTs doesn't undergo much change in structure from AST to HIR, the HIRs representation inherits almost everything from the ASTs structure.\u003c/p\u003e\n\u003cp\u003eDespite similarity in structure, the HIR lowering is a necessary step in the pipeline where we get to inherit all of gccrs' necessary name resolution, unsafe gating and type checking.\u003c/p\u003e\n\u003ch3 id=\"hir-creation\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#hir-creation\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eHIR Creation\u003c/h3\u003e\n\u003cp\u003eThere must be an automatic way to do this. After all, the call \u003ccode\u003easm!\u003c/code\u003e will appear everywhere, maybe in a block, maybe in another AST; how do we make sure that we can reach it and lower it correctly?\u003c/p\u003e\n\u003cp\u003eThe answer is the visitor pattern, here are \u003ca href=\"https://en.wikipedia.org/wiki/Visitor_pattern\"\u003esome\u003c/a\u003e of \u003ca href=\"https://refactoring.guru/design-patterns/visitor\"\u003ethe\u003c/a\u003e references to \u003ca href=\"https://www.youtube.com/watch?v=dQw4w9WgXcQ\"\u003elook into\u003c/a\u003e if you're new to this pattern.\u003c/p\u003e\n\u003cp\u003eIn short: The visitor pattern separate algorithms from the objects which they operate on.\u003c/p\u003e\n\u003cp\u003eIn my opinion, this is where the visitor pattern shines the brightest: you only have to worry about your part. Let's get into the nitty gritty.\u003c/p\u003e\n\u003cp\u003eIn the gccrs codebase, more specifically, the visitor class responsible for lowering AST to HIR is of the name \u003ccode\u003eASTLowering*\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eThe most general AST lowering class is \u003ccode\u003eASTLoweringBase\u003c/code\u003e where all other AST lowering class inherits from to overload as needed.\u003c/p\u003e\n\u003cp\u003eSince our AST inherits from ExprWithoutBlock, which is a type of Expr, we implement our lowering from \u003ccode\u003eASTLoweringExpr\u003c/code\u003e. The following code block highlights the fact that we need to lower all of AST::Expr in our AST::InlineAsm, primarily in our AST::InlineAsmOperand; I show the pattern for the first two lowering of AST::InlineAsmOperand, as well as the method to create the HIR::InlineAsm.\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003eHIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsmOperand\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003etranslate_operand_in\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003econst\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e AST\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsmOperand \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  auto\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e in_value \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e operand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_in\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  struct\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003e HIR\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eInlineAsmOperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003eIn\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e in (\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    in_value.reg\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    std::\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003eunique_ptr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003eExpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e (ASTLoweringExpr::\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003etranslate\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e (*in_value.expr.get ())))\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  return\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e in\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003eHIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsmOperand\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003etranslate_operand_out\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003econst\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e AST\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsmOperand \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  auto\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e out_value \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e operand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_out\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  struct\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003e HIR\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eInlineAsmOperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003eOut\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e out (out_value.reg\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e out_value.late\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e\t\t\t\t\t std::\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003eunique_ptr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003eExpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e (\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e\t\t\t\t\t   ASTLoweringExpr::\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003etranslate\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e (\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e\t\t\t\t\t     *out_value.expr.get ())))\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  return\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e out\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e// [...]\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e// We omit translate_operand_inout, translate_operand_split_in_out,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e// translate_operand_const, translate_operand_sym,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e// translate_operand_label for clarity\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003efrom_operand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003econst\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e AST\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsmOperand \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  using\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003e RegisterType\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e AST\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eInlineAsmOperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003eRegisterType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  auto\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e type \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e operand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_register_type\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  switch\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003etype\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    case\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e RegisterType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eIn\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e      return\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e translate_operand_in\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    case\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e RegisterType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eOut\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e      return\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e translate_operand_out\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    case\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e RegisterType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInOut\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e      return\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e translate_operand_inout\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    case\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e RegisterType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eSplitInOut\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e      return\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e translate_operand_split_in_out\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    case\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e RegisterType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eConst\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e      return\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e translate_operand_const\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    case\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e RegisterType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eSym\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e      return\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e translate_operand_sym\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    case\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e RegisterType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eLabel\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e      return\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e translate_operand_label\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    default\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e      rust_unreachable\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003evoid\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eASTLoweringExpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003evisit\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eAST\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsm \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  auto\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e crate_num \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e mappings\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_current_crate\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003e  Analysis\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eNodeMapping \u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003emapping\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecrate_num\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_node_id\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e\t\t\t\t mappings\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_next_hir_id\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecrate_num\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e\t\t\t\t mappings\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_next_localdef_id\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecrate_num\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003e  std\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003evector\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eHIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsmOperand\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e hir_operands\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  const\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e std\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003evector\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eAST\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsmOperand\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e \u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003east_operands \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_operands\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  for\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003eauto\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e \u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand \u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e ast_operands\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e      hir_operands\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003epush_back\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003efrom_operand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoperand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  translated\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#81C8BE\"\u003e    =\u003c/span\u003e\u003cspan style=\"color:#CA9EE6;font-weight:bold\"\u003e new\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e HIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eInlineAsm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_locus\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (),\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eis_global_asm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e\t\t\t  expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_template_\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (),\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_template_strs\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e\t\t\t  hir_operands\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_clobber_abi\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e\t\t\t  expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_options\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (),\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e mapping\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch3 id=\"unsafe-gating\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#unsafe-gating\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eUnsafe gating\u003c/h3\u003e\n\u003cp\u003eSince \u003ccode\u003easm!\u003c/code\u003e is platform dependent and is inherently unsafe, i.e \"you would get a \u003ca href=\"https://en.wikipedia.org/wiki/Segmentation_fault\"\u003esegmentation fault\u003c/a\u003e with no probable stacktrace whatsoever\", rust requires asm! to be in an unsafe block.\u003c/p\u003e\n\u003cp\u003eIn the gccrs codebase, this \u003ccode\u003eunsafe gating\u003c/code\u003e is handled via \u003ccode\u003egcc/rust/checks/rust-unsafe-checker.h/cc\u003c/code\u003e, again, employing the \u003ca href=\"https://stackoverflow.com/questions/6762256/how-does-double-dispatch-work-in-visitor-pattern\"\u003edouble dispatch\u003c/a\u003e functionality of the visitor pattern.\u003c/p\u003e\n\u003cp\u003eIn our implementation, the unsafe checker maintains a stack of contexts named \u003ccode\u003eunsafe_context\u003c/code\u003e with a convenient boolean function \u003ccode\u003eis_in_context\u003c/code\u003e. At the time of our visit, we check if it is an unsafe context or not.\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003evoid\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eUnsafeChecker\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003evisit\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsm \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  if\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eunsafe_context\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eis_in_context\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ())\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    return\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  rust_error_at\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_locus\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (),\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e ErrorCode\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eE0133\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#A6D189\"\u003e    \"use of inline assembly is unsafe and requires unsafe function or block\"\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cblockquote\u003e\n\u003cp\u003eBut Jas, why we wouldn't want the UnsafeChecker to just maintain a boolean \u003ccode\u003eis_unsafe\u003c/code\u003e, and once UnsafeChecker visit an unsafe block, we set the boolean \u003ccode\u003eis_unsafe\u003c/code\u003e to true and consequently false after the UnsafeChecker finishes visiting?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eThis won't work if we are traversing an AST where we have nested unsafe block, thus a \u003ccode\u003etemplate \u0026#x3C;typename T\u003e class StackedContexts\u003c/code\u003e is needed. Let's examine an example where a single boolean failed and why we would need to use a stack.\u003c/p\u003e\n\u003cp\u003eIn this example, there is only 1 unsafe context; the boolean implementation satisfies the unsafe requirement.\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003elet a = 15;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eunsafe { // we set the boolean to true\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e      // Now unsafe operations are allowed!\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e      let b = *(\u0026#x26;a as *const i32);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e      let c = std::mem::transmute\u0026#x3C;i32, f32\u003e(b);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e} // we set it to false\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e// Yay me!!!\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBut in the following case, where we have nested unsafe context, the boolean fails to recognize that we are still \"unsafe\"; thus needing a stack.\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#A6D189\"\u003eunsafe { // wraps the above unsafe context inside another unsafe context\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    let a = 15;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    unsafe { // we set the boolean to true\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e         let b = *(\u0026#x26;a as *const i32);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e         let c = std::mem::transmute\u0026#x3C;i32, f32\u003e(b);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    } // we set it to false\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    // Yay me!!!\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#A6D189\"\u003e }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#A6D189\"\u003e // Now unsafe operations are forbidden again, but the boolean is false\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#A6D189\"\u003e let f = std::mem::transmute\u0026#x3C;i32, f32\u003e(15); // Uh-oh!\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eBefore every visit to an unsafe context, the unsafe checker inserts a context into the stack and after every visit, it pops that context out. A check to see if we are still unsafe checks if the stack is empty.\nReaders interested in implementation details can check \u003ccode\u003egcc/rust/checks/errors/rust-unsafe-checker.h/cc\u003c/code\u003e and \u003ccode\u003egcc/rust/util/rust-stacked-contexts.h\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"type-checking\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#type-checking\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eType checking\u003c/h3\u003e\n\u003cp\u003eFrom the rust compiler dev references:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\"The only ones that are of particular interest to rustc are NORETURN which makes asm! return ! instead of ()\".\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eWe minimally represent this situation with the following implementation in \u003ccode\u003egcc/rust/typecheck/rust-hir-typecheck-expr.h/cc\u003c/code\u003e\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003evoid\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eTypeCheckExpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003evisit\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eHIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsm \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e  // We recursively typechecks its operands.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  typecheck_inline_asm_operand\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  if\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eoptions\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003ecount\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eAST\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eInlineAsmOption\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eNORETURN\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e ==\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e 1\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    infered \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#CA9EE6;font-weight:bold\"\u003e new\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e TyTy\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eNeverType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_mappings\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ().\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_hirid\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  else\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e    infered\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#81C8BE\"\u003e      =\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e TyTy\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eTupleType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_unit_type\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_mappings\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ().\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_hirid\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eI omit the part where we also recursive typecheck and infer each expr in each operand for the next part\u003c/p\u003e\n\u003ch3 id=\"resolution\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#resolution\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eResolution\u003c/h3\u003e\n\u003cp\u003eGiven an example that is part of \u003ca href=\"https://github.com/Rust-GCC/gccrs/pull/3060/files#diff-693188f770da1bcaab140cfa09a7df64b510f5b17f21d9dc7627fc401776086a\"\u003einline_asm_mov_x86_rs\u003c/a\u003e test case, where we refers to _x as a potential output:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003elet mut _x: i32 = 0;\nunsafe {\n    asm!(\n        \"mov $5, {}\",\n        out(reg) _x\n    );\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe need a way to somehow link the \u003ccode\u003e_x\u003c/code\u003e that we refers inside the asm!, inside the unsafe block to the \u003ccode\u003e_x\u003c/code\u003e outside of the unsafe block.\u003c/p\u003e\n\u003cp\u003eThe part that handles this is called name resolution. The \u003ca href=\"https://rustc-dev-guide.rust-lang.org/name-resolution.html#:~:text=The%20name%20resolution%20in%20Rust,other%20via%20the%20ResolverAstLoweringExt%20trait.\"\u003eRust Compiler Dev Reference\u003c/a\u003e goes into much details for this part.\u003c/p\u003e\n\u003cp\u003eHere I provide some implementation details for gccrs.\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e// Perform type checking on expr. Also runs type unification algorithm.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e// Returns the unified type of expr\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003eTyTy\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eBaseType \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e*\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eTypeCheckExpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eResolve\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eHIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eExpr \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  TypeCheckExpr resolver\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eaccept_vis\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eresolver\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  if\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eresolver\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003einfered \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e==\u003c/span\u003e\u003cspan style=\"color:#E78284\"\u003e nullptr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    return\u003c/span\u003e\u003cspan style=\"color:#CA9EE6;font-weight:bold\"\u003e new\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e TyTy\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eErrorType\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_mappings\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ().\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_hirid\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ());\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  auto\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e ref \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_mappings\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ().\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_hirid\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  resolver\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003einfered\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eset_ref\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eref\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  resolver\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003econtext\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003einsert_type\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_mappings\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (),\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e resolver\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003einfered\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  return\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e resolver\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003einfered\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"tree-generic\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#tree-generic\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eTREE (GENERIC)\u003c/h2\u003e\n\u003cp\u003eAfter we have finished setting up the AST and the HIR, we'll set up the TREE (GENERIC IR) infrastructure for our asm! node and after that, this IR will be lowered by gcc itself (GIMPLE IR), relieving us from duty.\u003c/p\u003e\n\u003cp\u003eThe most central data structure used in the IR is \u003ccode\u003etree\u003c/code\u003e, thus the name. From now, we'll refer to TREE IR as GENERIC IR.\u003c/p\u003e\n\u003cp\u003eThe knowledge I learned about GENERIC is through this documentation \u003ca href=\"https://gcc.gnu.org/onlinedocs/gccint/GENERIC.html\"\u003ehttps://gcc.gnu.org/onlinedocs/gccint/GENERIC.html\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"overall\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#overall\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eOverall\u003c/h3\u003e\n\u003cp\u003eLet's look at the definition and explore the tree code structures\u003c/p\u003e\n\u003cp\u003eFrom the GCC GENERIC:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThe purpose of GENERIC is simply to provide a language-independent way of representing an entire function in trees... If you can express it with the codes in gcc/tree.def, its GENERIC.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eNeedless to say, we are to obtain a working knowledge of trees and tree codes :)\u003c/p\u003e\n\u003cp\u003eIn the tree.def file, the tree codes are defined with the following structure:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eDEFTREECODE (name, string_name, class, operand_count)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ewhere:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003ename: The symbolic name of the tree node.\u003c/li\u003e\n\u003cli\u003estring_name: The human-readable string representing the node.\u003c/li\u003e\n\u003cli\u003eclass: A classification for the nodes to follow a specific structure/functionality.\u003c/li\u003e\n\u003cli\u003eoperand_count: The number of fields it takes to make the tree of this type.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eLet's give an example of some of the tree codes we're sure to use:\u003c/p\u003e\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\u003ctable\u003e\u003cthead\u003e\u003ctr\u003e\u003cth\u003eTree code definition\u003c/th\u003e\u003cth\u003edefinition location in tree.def\u003c/th\u003e\u003cth\u003eUsage in our backend\u003c/th\u003e\u003c/tr\u003e\u003c/thead\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd\u003eDEFTREECOE(TREE_LIST, \"tree_list\", tcc_exceptional, 0)\u003c/td\u003e\u003ctd\u003eLine 54\u003c/td\u003e\u003ctd\u003eConstruction of operands\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003eDEFTREECODE(STRING_CST, \"string_cst\", tcc_constant, 0)\u003c/td\u003e\u003ctd\u003eLine 310\u003c/td\u003e\u003ctd\u003eConstruction of templated assembly code\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003eDEFTREECODE(ASM_EXPR, \"asm_expr\", tcc_statement, 5)\u003c/td\u003e\u003ctd\u003eLine 1008\u003c/td\u003e\u003ctd\u003eConstruction of inline assembly node\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\n\u003ch3 id=\"anatomy\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#anatomy\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eAnatomy\u003c/h3\u003e\n\u003cp\u003eI'll give a detailed look of the ones that are needed for the project.\u003c/p\u003e\n\u003ch4 id=\"tree_list\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#tree_list\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eTREE_LIST\u003c/h4\u003e\n\u003cp\u003eTREE_LIST is ... just a list of trees... It has a TREE_VALUE, TREE_PURPOSE and TREE_CHAIN.\u003c/p\u003e\n\u003cp\u003eFor the first two values, TREE_VALUE holds the element while TREE_PURPOSE gives a directive to later stages on what to do with this TREE_VALUE. In our tree usage section, we'll see that a tree list of register operands contains a TREE_VALUE of variables and a TREE_PURPOSE of register type, denoting if it's input or output register operands.\u003c/p\u003e\n\u003cp\u003eThe TREE_CHAIN node points to the next element in the tree list, which is also a TREE_LIST.\u003c/p\u003e\n\u003cp\u003eIn \u003ca href=\"https://github.com/Rust-GCC/gccrs/blob/master/gcc/tree.cc\"\u003egcc/tree.cc\u003c/a\u003e, a way to construct a tree list is\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e/* Return a newly created TREE_LIST node whose\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e   purpose and value fields are PARM and VALUE.  */\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003etree\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003ebuild_tree_list\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003etree parm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e tree value MEM_STAT_DECL\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  tree t \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e make_node\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eTREE_LIST PASS_MEM_STAT\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  TREE_PURPOSE\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003et\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e parm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  TREE_VALUE\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003et\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e value\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  return\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e t\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eA trend you'll see is that these underlying wrapper methods that construct our trees is that they'll start with a \u003ccode\u003etree t = make node(...)\u003c/code\u003e or something that allocates memory for a tree, and then some  more \u003ccode\u003eUPPER_CASE_SETTER_GETTER_METHOD(t) = ...\u003c/code\u003e that follows.\u003c/p\u003e\n\u003ch4 id=\"string_cst\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#string_cst\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eSTRING_CST\u003c/h4\u003e\n\u003cp\u003eThe STRING_CST is a tree constant of string. We'll use this type of TREE in a lot of places. For example, TREE_PURPOSE in the above TREE_LIST often uses some form of STRING_CST as a directive for later stages. We can also use it as a way to encode our unprocessed/templated inline assembly code as STRING_CST.\u003c/p\u003e\n\u003cp\u003eSometimes, our strings can also be represented not by a STRING_CST but by ARRAY of type CHAR, and this is also acceptable. An example of this is in \u003ccode\u003ecc\u003c/code\u003e for the inline assembly code.\u003c/p\u003e\n\u003cp\u003eA call to construct STRING_CST: \u003ccode\u003ebuild_string\u003c/code\u003e, takes two parameters: a length of cstr, including the NULL delimiter and the cstr itself.\u003c/p\u003e\n\u003ch4 id=\"asm_expr\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#asm_expr\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eASM_EXPR\u003c/h4\u003e\n\u003cp\u003eAn ASM_EXPR has 5 parameters it needs passing.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAn ASM_STRING of treecode STRING_CST\u003c/li\u003e\n\u003cli\u003eAn ASM_OUTPUTS of treecode TREE_LIST\u003c/li\u003e\n\u003cli\u003eAn ASM_INPUTS of treecode TREE_LIST\u003c/li\u003e\n\u003cli\u003eAn ASM_CLOBBERS\u003c/li\u003e\n\u003cli\u003eAn ASM_LABELS\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI omit the last two treecodes simply because the project hasn't had the capacity to explore the clobber and label functionality.\u003c/p\u003e\n\u003ch3 id=\"tree-usage\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#tree-usage\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eTREE USAGE\u003c/h3\u003e\n\u003cp\u003eIn constructing the tree representation of our inline assembly, we combine the existing infrastructure as well as our knowledge of tree codes.\u003c/p\u003e\n\u003cp\u003eMore specifically, we rely on existing tree generation of our variables and raw c strings. We build ourselves a list of input and output registers to make up the ASM_EXPR tree.\u003c/p\u003e\n\u003cp\u003eThe process of building our ASM_EXPR is as follow:\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003etree\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eCompileAsm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003etree_codegen_asm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eHIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsm \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  auto\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e asm_expr\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#81C8BE\"\u003e    =\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e asm_build_stmt\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eget_locus\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (),\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e {\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003easm_construct_string_tree\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e\t\t\t\t\t  asm_construct_outputs\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e\t\t\t\t\t  asm_construct_inputs\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e\t\t\t\t\t  asm_construct_clobber_tree\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e),\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e\t\t\t\t\t  asm_construct_label_tree\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  ASM_INPUT_P\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003easm_expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eis_simple_asm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  ASM_VOLATILE_P\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003easm_expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e false\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  ASM_INLINE_P\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003easm_expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eis_inline_asm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  return\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e asm_expr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003etree\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eCompileAsm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003easm_build_stmt\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003e  location_t\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e loc\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  const\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e std\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003earray\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003etree\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e CompileAsm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eASM_TREE_ARRAY_LENGTH\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e \u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003etrees\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e  // Prototype functiion for building an ASM_EXPR tree.\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  tree ret\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  bool\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e side_effects\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  ret \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e make_node\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eASM_EXPR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  TREE_TYPE\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eret\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e void_type_node\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  SET_EXPR_LOCATION\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eret\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e loc\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  side_effects \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e false\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  for\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003esize_t\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e i \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e 0\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e i \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e trees\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003esize\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e ();\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e i\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e++\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e    {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e      tree t \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e trees\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e[\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ei\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e      if\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003et \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x26;\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e !\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eTYPE_P\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003et\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e))\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e\tside_effects \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e|=\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e TREE_SIDE_EFFECTS\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003et\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e      TREE_OPERAND\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eret\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e i\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e t\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e  TREE_SIDE_EFFECTS\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eret\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e |=\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e side_effects\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e  return\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e ret\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn the end, we add the tree to a list of statements in the following fashion:\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003evoid\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eCompileExpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003evisit\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003eHIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eInlineAsm \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x26;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  CompileAsm \u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003easm_codegen\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ectx\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e);\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  ctx\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eadd_statement\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003easm_codegen\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003etree_codegen_asm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eexpr\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e));\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eReaders interested in the implementation details can refer to\n\u003ccode\u003egcc/rust/backend/rust-compile-asm.h/cc\u003c/code\u003e and \u003ccode\u003egcc/rust/backend/rust-compile-expr.h/cc\u003c/code\u003e\u003c/p\u003e\n\u003ch2 id=\"results\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#results\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eResults\u003c/h2\u003e\n\u003cp\u003eYayyy, we've finally relieved ourselves of code generation responsibilities, leaving the rest to GIMPLE, RTL, and gcc backend. The gccrs compiler can now generate correct instructions using the in and out register operands.\u003c/p\u003e\n\u003cp\u003eBelow shows a few test cases that gccrs can now pass:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e/* { dg-do run { target arm*-*-* } } */\n/* { dg-output \"5\\r*\\n9\\r*\\n\" }*/\n\n#![feature(rustc_attrs)]\n#[rustc_builtin_macro]\nmacro_rules! asm {\n    () =\u003e {};\n}\n\nextern \"C\" {\n    fn printf(s: *const i8, ...);\n}\n\nfn main() -\u003e i32 {\n    let mut x: i32 = 0;\n    let mut _y: i32 = 9;\n\n    unsafe {\n        asm!(\n            \"mov {}, 5\",\n            out(reg) x\n        );\n        printf(\"%d\\n\\0\" as *const str as *const i8, x);\n    };\n\n    unsafe {\n        asm!(\n            \"mov {}, {}\",\n            in(reg) _y,\n            out(reg) x\n        );\n        printf(\"%d\\n\\0\" as *const str as *const i8, x);\n    }\n\n    0\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"end-words\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#end-words\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eEnd words\u003c/h2\u003e\n\u003cp\u003eParticipating in Google Summer of Code for gccrs  (and get paid for it hehe) has been my most gratifying and meaningful experience in software development. I am mentored by Arthur Cohen and Pierre-Emmanuel \"PEP\" Patry; Arthur helped me with the direction of the project and code reviews while Pierre-Emmanuel provided me with code infrastructure navigation and PR code-reviews, both of which are much needed.\u003c/p\u003e\n\u003cp\u003eThe main struggles for me in this internship is three fold:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAround designing the code infrastructure to support inline assembly.\u003c/li\u003e\n\u003cli\u003eAround constructing new AST/HIR/ Tree IR via inheritance.\u003c/li\u003e\n\u003cli\u003eIn general, navigating around documentation and codebase.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThere wasn't much in terms of inline assembly related work before the summer of my internship in gccrs. This means that I need also to decide how to\ncreate and structure my code in a way that fits into the codebase itself. At that moment, there was just this fear of not knowing what to do, not knowing what to code.\nThe concept is akin to create something out of thin air: you made up a class and named it AST, inherited this class from another AST and trust that the visitor\npattern will come to save you once you have also created your made-up parser to produce this made-up AST; and the pattern continues on.\nThat's the thing I love about software engineering in general and compiler more specifically.\u003c/p\u003e\n\u003cp\u003eDocumentation, I've learned, is a some-what of dire thing in the compiler world. I'm now, in retrospect, extra grateful for Arthur when he wrote\nup a whole docs detailing each step for me when I attempted a hard PR. Thank you Arthur moah moah moah I love you.\u003c/p\u003e\n\u003cp\u003eI am taking a graduate course in compiler right now (Compiler optimization) (beaten to a pulp) and will try to get into another graduate compiler class next semester (Implementation of PL) and work in the industry in 2025.\u003c/p\u003e\n\u003cp\u003eI would love to be informed of new opportunities. If you know of a compiler related job posting, please feel free to contact me at either:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"mailto:tanghocle456@gmail.com\"\u003etanghocle456@gmail.com\u003c/a\u003e (for job posting)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"mailto:jjasmine@berkeley.edu\"\u003ejjasmine@berkeley.edu\u003c/a\u003e (for job posting)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://x.com/thisisjjasmine\"\u003ehttps://x.com/thisisjjasmine\u003c/a\u003e (social media)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThank you for reading :)\u003c/p\u003e"])</script><script>self.__next_f.push([1,"6:[\"$\",\"article\",null,{\"className\":\"p-8 prose  max-w-none w-full lg:w-1/2 md:w-4/6 sm:w-5/6 prose-sky mx-auto\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex justify-center text-2xl font-bold \",\"children\":[\"$\",\"h2\",null,{\"children\":\"What I did for GSoc 2024\"}]}],[\"$\",\"div\",null,{\"className\":\"flex justify-start text-xl font-bold underline\",\"children\":[\"$\",\"h4\",null,{\"children\":\"2024-08-22\"}]}],[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$e\"}}]]}]\na:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"What I did for GSoc 2024\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Built with NextJS, TailwindCSS, and a tonnn of loveee :)\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/_next/static/media/pfp3.5cd65164.png\"}]]\n8:null\n"])</script></body></html>