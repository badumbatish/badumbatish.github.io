<!DOCTYPE html><html lang="en" class="px-4 py-4"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/7385e8d9d3c5518f-s.p.ttf" as="font" crossorigin="" type="font/ttf"/><link rel="stylesheet" href="/_next/static/css/4c262d18fc086fff.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-024c71c063ddb8d8.js"/><script src="/_next/static/chunks/4bd1b696-cc921fdf64582ac2.js" async=""></script><script src="/_next/static/chunks/517-f9c47ac1c3159d98.js" async=""></script><script src="/_next/static/chunks/main-app-64657d68b3fa7103.js" async=""></script><script src="/_next/static/chunks/173-ad05a37061268ac6.js" async=""></script><script src="/_next/static/chunks/565-d3001cb0b7ac580c.js" async=""></script><script src="/_next/static/chunks/app/layout-5c184bc8512acba2.js" async=""></script><meta name="next-size-adjust" content=""/><title>[REPORT] Going to the gym with MLIR: Writing a recompiler for DEX instructions</title><meta name="description" content="Built with NextJS, TailwindCSS, and a tonnn of loveee :)"/><link rel="icon" href="/_next/static/media/pfp3.5cd65164.png"/><script src="/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body class="__className_d4e0c8 flex flex-col min-h-screen"><a href="/"><div class="flex justify-center items-center py-4 "><h1 class="text-4xl font-bold">Jasmine Tang</h1></div></a><div class="flex-1"><article class="p-8 prose  max-w-none w-full lg:w-1/2 md:w-4/6 sm:w-5/6 prose-sky mx-auto"><div class="flex justify-center text-2xl font-bold "><h2>[REPORT] Going to the gym with MLIR: Writing a recompiler for DEX instructions</h2></div><div class="flex justify-start text-xl font-bold underline"><h4>2024-12-07</h4></div><div><nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#prologue">Prologue</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#reader-supporting-section">Reader supporting section</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#terminology">Terminology</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#acronyms">Acronyms</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#introduction">Introduction</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#planning">Planning</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#version-control-and-contributions">Version control and contributions</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#goals-and-current-status">Goals and current status</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#mlirs-operations-and-values">MLIR's operations and values</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#operations">Operations</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#values">Values</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#dissecting-mlir">Dissecting MLIR</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#parsing-cmdline-and-cmake">Parsing, cmdline and cmake</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#dialect-reusability-and-extensibility">Dialect reusability and extensibility</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#conclude">Conclude</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#non-mlir-non-ssa-cfg-to-mlir-ssa-cfg">Non-MLIR, NON-SSA CFG to MLIR-SSA CFG</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#optimization-and-analysis">Optimization and Analysis</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#translation">Translation</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#parameter-versus-local-registers">Parameter versus local registers</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#getting-out-of-ssa">Getting out of SSA</a><ol class="toc-level toc-level-3"><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#ssa-value-to-virtual-registers">SSA value to virtual registers</a></li><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#dealing-with-phis-block-arguments-ssa-destruction">Dealing with phis (block arguments) (SSA destruction)</a></li><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#control-flow-combination">Control flow combination</a></li></ol></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#so-whats-going-on-right-now-jaz-whats-next">So what's going on right now Jaz? What's next?</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#resources">Resources</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#figures">Figures</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#tutorials-and-docs">Tutorials and Docs</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#algorithms">Algorithms</a></li></ol></li></ol></nav><h2 id="prologue"><a aria-hidden="true" tabindex="-1" href="#prologue"><span class="icon icon-link"></span></a>Prologue</h2>
<p>Hi there, I hope everyone's having a great day, this article is about lifting and lowering DEX instructions in MLIR, utilizing the framework in analysing and optimizing the <a href="https://source.android.com/docs/core/runtime/dalvik-bytecode">DEX</a> format.</p>
<p>The blog is intended as a report submission for <a href="https://www2.eecs.berkeley.edu/Courses/CS265/">CS265</a> <a href="https://github.com/mwillsey/cs265">here</a>. The report focuses more on the high level details. The project also discusses the ease (or uneasiness) of executing the project, meanwhile introducing the benefits of MLIR with its elements in the ecosystem</p>
<p>The report is about 3700 words, or 15 minutes of reading. The editing cut-off is 12PM PST Dec 17th 2024.</p>
<p>I also include a supporting section to recap different terminologies for unfamiliar readers.</p>
<p>Please try out this <a href="https://www.youtube.com/watch?v=-KhfFjCwFDU&#x26;ab_channel=Mademoiselle">song</a> while reading, it really soothes the mind. I hope everyone enjoys :)</p>
<h2 id="reader-supporting-section"><a aria-hidden="true" tabindex="-1" href="#reader-supporting-section"><span class="icon icon-link"></span></a>Reader supporting section</h2>
<p></p><details><summary>Open Reader supporting section</summary><p></p>
<p>This section introduces some terminology and/or acronyms that reviews from my friends deemed might be important context.</p>
<h3 id="terminology"><a aria-hidden="true" tabindex="-1" href="#terminology"><span class="icon icon-link"></span></a>Terminology</h3>
<ul>
<li>
<p>SSA: Static Single Assignment, a form where each variable is assigned exactly once, enabling easier optimization and analysis. This form is enforced in MLIR. We'll see the useful feature of this in the translation section.</p>
</li>
<li>
<p>Phi: A phi node is an SSA (Static Single Assignment) construct that selects a value based on the control flow predecessor, allowing variables to have multiple incoming definitions at a basic block merge point.</p>
</li>
<li>
<p>Block arguments: Equivalent to phi (?!) but in a different form.</p>
</li>
<li>
<p>Dialect: A custom language extension in MLIR like arith (stands for arithmetic) or cf (stands for control flow) or func (for function related things) used to represent IRs.</p>
</li>
<li>
<p>Operations: A term (and concrete thing in MLIR's C++ API) that can be used to represent different concepts in MLIR. This ranges from higher-level concepts like function definitions, function calls, buffer allocations, view or slices of buffers, and process creation, to lower-level concepts like target-independent arithmetic, target-specific instructions, configuration registers, and logic gates.</p>
</li>
</ul>
<p>To give an example of the two terminology, the dialect <code>arith</code> features different operations such <code>addf</code> (adding two floats) or <code>addi</code> (adding two integers) or <code>cmpi</code> (comparing two integers). Another example is the <code>func</code>'s dialect's <code>func</code> (to represent a function) or <code>return</code> to represent a return call or <code>call</code> to represent invoking a function.</p>
<h3 id="acronyms"><a aria-hidden="true" tabindex="-1" href="#acronyms"><span class="icon icon-link"></span></a>Acronyms</h3>
<ul>
<li>
<p>LLVM: used to mean Low level virtual machine, but now is an umbrella term for a collection of modular and reusable compiler and toolchain technologies. Another meaning for LLVM is the subproject LLVM within the LLVM collection. The subproject provides reusable components for code generation, optimization, and analysis, enabling developers to build high-performance, platform-agnostic tools.</p>
</li>
<li>
<p>MLIR: stands for Multi-Level Intermediate Representation. A flexible, extensible compiler infrastructure within the LLVM project designed to support multiple levels of abstraction and domain-specific optimizations. It provides a unified framework for building high-performance compilers and tools tailored to diverse hardware and programming models.</p>
</li>
<li>
<p>DEX: Stands for Dalvik Executable, which is a format used on Android before being replaced by ART, which stands for Android runtime.</p>
</li>
<li>
<p>MjolnIR: A custom IR for representing DEX instructions built from MLIR's facility. The library's current implementation uses this IR primarily.</p>
</li>
<li>
<p>Basic block (BB): a straight-line code sequence with no branches in except to the entry and no branches out except at the exit.</p>
</li>
<li>
<p>CFG: Control flow graph, the graphical representation of control flow or computation during the execution of programs or applications. On its most basic level, a CFG (control flow graph) contains a bunch of BBs (basic blocks), which are glued together by control flows</p>
</li>
</ul>
<p></p></details><p></p>
<h2 id="introduction"><a aria-hidden="true" tabindex="-1" href="#introduction"><span class="icon icon-link"></span></a>Introduction</h2>
<p>The MLIR project from the LLVM framework provides a framework for building reusable and extensible compiler infrastructure, allowing for a unified handling of different IRs within the same framework.</p>
<p>In the case of the library <a href="https://github.com/Shuriken-Group/Shuriken-Analyzer">Shuriken</a> from <a href="https://github.com/Shuriken-Group">Shuriken Group</a> for Dalvik Executable (DEX) file analysis, we can leverage the MLIR by extending a somewhat 1-to-1 mapping of DEX to MLIR, the newly created IR (MjolnIR), allowing us to use the much more mature framework for analyzing the binary itself. As DEX is used as a mean for transportation from a server to an android device where it is compiled into ART for installation, being able to optimize the bytecode size of dex allows us to save cost on networking as well as server and android device's storage cost.</p>
<p>In the future, MjolnIR will be used in optimization, obfuscating, deobfuscating the Dalvik Machine Bytecode.</p>
<p>This project (and this blog post) wouldn't be possible without the guidance of Eduardo (Edu) Blázquez González (Fare9), (<a href="https://farena.in/">Eduardo</a>), a PhD doctorate and a compiler engineer at Quarkslab in developing, lifting and lowering the IR.
This summer, Edu's the one that reached out to me on twitter to befriend me :) We chatted about compilers and stuff, and later he introduced me to the codebase.
He's been helping me with onboarding the codebase infrastructure, together with emotional support and chatting about life hahahah :)</p>
<p>I am also grateful to <a href="https://www.mwillsey.com/">Max Willsey</a>, the professor of the compiler graduate class CS265, for allowing me, an undergraduate to enroll as well as guiding me on the direction of the project.
Throughout the semester, there were some assignments where I fell behind. I know that opportunities are hard to come by and I really took every lesson to heart. I thank you for your advice and your bet for taking me into the class :)</p>
<p>Much work is needed in supporting the full instruction set of DEX as well as optimization of it. The project report will discuss the current work (which is a subset of the DEX instruction set) as well as future work.</p>
<h2 id="planning"><a aria-hidden="true" tabindex="-1" href="#planning"><span class="icon icon-link"></span></a>Planning</h2>
<h3 id="version-control-and-contributions"><a aria-hidden="true" tabindex="-1" href="#version-control-and-contributions"><span class="icon icon-link"></span></a>Version control and contributions</h3>
<p>All code for the project is under the <a href="https://github.com/Shuriken-Group/Shuriken-Analyzer">Shuriken Analyzer</a> repository, which is under the <a href="https://github.com/Shuriken-Group">Shuriken Group</a>'s ownership.</p>
<p>The group also includes other projects, such as</p>
<ul>
<li><a href="https://github.com/Shuriken-Group/setup_llvm_tools">LLVM/MLIR dependency fetching tool</a>: To power CI/CD for this project.</li>
<li><a href="https://github.com/Shuriken-Group/shuribot">Telegram bot for Shuriken</a> : for issue filing and status request, as our group's communication is mainly via telegram.</li>
</ul>
<p>My contributions for the project are shown separately via the <a href="https://github.com/Shuriken-Group/Shuriken-Analyzer/issues?q=is%3Aissue+author%3Abadumbatish">issues</a> and <a href="https://github.com/Shuriken-Group/Shuriken-Analyzer/pulls?q=is%3Apr+author%3Abadumbatish">pull requests</a></p>
<h3 id="goals-and-current-status"><a aria-hidden="true" tabindex="-1" href="#goals-and-current-status"><span class="icon icon-link"></span></a>Goals and current status</h3>
<p>In analysing the DEX format, we need to parse the DEX file, construct a CFG (non-MLIR, and non-SSA), and then translate the CFG to MLIR's SSA CFG, apply some analysis, then <em>translate it to smali</em>, and then translate smali to dex (via 3rd party tool).</p>
<p>Smali is the human-readable assembly format for the dalvik virtual machine. Edu's provided us with a good <a href="https://github.com/Shuriken-Group/Shuriken-Analyzer/wiki/smali_documentation">write-up</a> for smali that I think necessitates a read. Here, I show a small "Hello World" program written in smali that is compiled from java.</p>
<pre><code># This is a comment
.method public static main([Ljava/lang/String;)V
	.registers 2 # We use a total of 2 registers here.

    # Get the PrintStream object into register v0
	sget-object v0, Ljava/lang/System;->out:Ljava/lang/PrintStream;

    # Get the const string "Hello World" into v1
	const-string v1, "Hello World"

    # Invoke v0's println method on v1
	invoke-virtual {v0, v1}, Ljava/lang/PrintStream;->println(Ljava/lang/String;)V

    # return void
	return-void

.end method
</code></pre>
<p>The reasoning for this is that smali is an easier output to work with than dex. In dex format, we need to maintain different tables of strings, types, methods and classes in the pre-header before we get to output the actual DEX. To make matters worse, control flow are done via offsets, which disrupts optimization and requires recalculation of offsets.</p>
<p>In smali, all is resolved via text references instead. In such a short amount of time (~ 6 weeks), it's hard to achieve true circular transformation (DEX->MLIR->DEX). I therefore opted for (DEX->MLIR->smali->DEX) first (actually at the time of writing this (Dec 7th 2024), I'm even nervous to see if we can get DEX->MLIR->smali for submission).</p>
<p>With the naming of the MLIR's dialect being MjolnIR, the goal of the project is divided into two fronts:</p>
<ul>
<li>Achieve the circular transformation of: DEX -> MjolnIR (MLIR) -> Smali.</li>
<li>Survey some analysis/optimization provided by MLIR, using our new IR.</li>
</ul>
<p>In parsing the dex and constructing the CFG, the job was done by Edu prior to me joining the team. There was also an effort in lifting some subset of DEX to MLIR in the <a href="https://github.com/Fare9/KUNAI-static-analyzer">KUNAI</a> repo by Edu (recorded <a href="https://www.youtube.com/watch?v=hfqOivYdD40&#x26;ab_channel=LLVM">here</a>).</p>
<p>Therefore, my responsibilities in the project is to set up MLIR, port over and maintain the lifting process of DEX, figure out the optimization and lowering aspect.</p>
<p>The diagram shown below details the steps we need to take in the project.</p>
<p><img src="/blogs/mlir_gym_goal.svg" alt="mlir_gym_goal.svg"></p>
<h3 id="mlirs-operations-and-values"><a aria-hidden="true" tabindex="-1" href="#mlirs-operations-and-values"><span class="icon icon-link"></span></a>MLIR's operations and values</h3>
<h3 id="operations"><a aria-hidden="true" tabindex="-1" href="#operations"><span class="icon icon-link"></span></a>Operations</h3>
<p>MLIR is built from what are known as "Operations," which are used to describe many different levels of abstractions and computations.</p>
<p>Every operation has a unique name, often written in the format dialect.operation_name. For example:</p>
<ul>
<li>arith.addi (integer addition in the arith dialect)</li>
<li>func.func (function definition in the func dialect)</li>
</ul>
<p>An operation may contain one or more regions, which in turn contain blocks of other operations. This allows hierarchical nesting, making MLIR very expressive.</p>
<p>On the top level, the MLIR features a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">ModuleOp</span></span></code></span>, which is a container operation of a single graph region.</p>
<p>In lifting DEX to MLIR, we think of</p>
<ul>
<li>An input DEX file comprises 1 up to 65535 <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">ModuleOp</span></span></code></span>, where each <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">ModuleOp</span></span></code></span> represents a class.</li>
<li>Each method (class's function) in the DEX file is a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">MethodOp</span></span></code></span>, a MjolnIR dialect's operation similarly to the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">func</span></span></code></span> operation in func dialect.</li>
<li>Each method might have control flows, which glues together basic blocks.</li>
</ul>
<p>Although a simple 1-1 representation, MLIR can feature much more complex hierarchy, as demonstrated below. We however, rely on the rigid structure we've defined for ourselves to simplify the lifting and lowering processes.</p>
<p>The following diagram showcases MLIR's recursively fluid structure.
<img src="/blogs/mlir_diagram_1.png" alt="mlir_diagram_1"></p>
<h3 id="values"><a aria-hidden="true" tabindex="-1" href="#values"><span class="icon icon-link"></span></a>Values</h3>
<p>An important thing to notice is how SSA form is represented in MLIR, which is done with <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span>. The MLIR Value plays an important role in the project; operations take in values and produces values, passing them to functions and blocks (these are operations as described above) to get out
some value or to establish control flow. Hence, frequent trips to <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span>'s <a href="https://mlir.llvm.org/doxygen/classmlir_1_1Value.html">doxygen</a> are needed. A fun thing to note is that with <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">DenseMap</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span> can be hashed; this powers both the lifting process and the lowering process.</p>
<p>To glue together the concept of operations and values, let's look at an example. Given an operation such as the integer addition
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#E5C890">arith</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">AddIOp</span></span></code></span>, MLIR gives us different accessors such as <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">getLhs</span><span style="color:#949CBB">()</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">getRhs</span><span style="color:#949CBB">()</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">getResult</span><span style="color:#949CBB">()</span></span></code></span> to access its values.
Each of these values can consequently invoke <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">getParentBlock</span><span style="color:#949CBB">()</span></span></code></span> or <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">replaceAllUsesWith</span><span style="color:#949CBB">()</span></span></code></span> to further manipulate themselves.</p>
<p>In a big picture with operations introduced above, the MLIR Language Reference succinctly says:</p>
<blockquote>
<p>MLIR is fundamentally based on a graph-like data structure of nodes, called Operations, and edges, called Values.</p>
</blockquote>
<h3 id="dissecting-mlir"><a aria-hidden="true" tabindex="-1" href="#dissecting-mlir"><span class="icon icon-link"></span></a>Dissecting MLIR</h3>
<p>Knowing how MLIR's operation and value works plays a crucial role in getting the recompiler working, as lifting, optimizing, and lowering all depend on them. I think therefore, it's also important to look at its textual form.</p>
<p>A pretty full (for our sakes) view of MLIR is shown below:</p>
<p><img src="/blogs/mlir_diagram_2.png" alt="mlir_diagram_2"></p>
<p>Below, I show some demos of some textual MLIR.</p>
<p>From Jeremy Kun's tutorial (a pretty cool person and maybe my idol), which the report author heavily relies on:</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#737994;font-style:italic">// The first `func` is the dialect's name. The second `func` is the operation's name</span></span>
<span class="line"><span style="color:#C6D0F5">func.func @</span><span style="color:#8CAAEE;font-style:italic">main</span><span style="color:#949CBB">(</span><span style="color:#81C8BE">%</span><span style="color:#C6D0F5">arg0: i32</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> -></span><span style="color:#C6D0F5"> i32 </span><span style="color:#949CBB">{</span><span style="color:#737994;font-style:italic"> // Variable names (SSA values) are prefixed with %</span></span>
<span class="line"><span style="color:#737994;font-style:italic">  // by convention naming of %arg0 means it is a different subclass than %0</span></span>
<span class="line"><span style="color:#81C8BE">  %</span><span style="color:#EF9F76">0</span><span style="color:#81C8BE"> =</span><span style="color:#C6D0F5"> math</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">ctlz </span><span style="color:#81C8BE">%</span><span style="color:#C6D0F5">arg0 : i32</span><span style="color:#737994;font-style:italic"> // Here we're using ctlz operation from math dialect</span></span>
<span class="line"><span style="color:#C6D0F5">  func</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">return </span><span style="color:#81C8BE">%</span><span style="color:#EF9F76">0</span><span style="color:#C6D0F5"> : i32</span><span style="color:#737994;font-style:italic"> // return op from func dialect</span></span>
<span class="line"><span style="color:#737994;font-style:italic">                    // taking in the ssa value %0 of type i32</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>A special thing for dialects in MLIR is that without a compiler writer's specified instruction to print an IR in textual form, MLIR will faithfully print everything that an operation has to the terminal (auto-generative aspect). This helps me quickly debug implementation issues in the project.</p>
<h2 id="parsing-cmdline-and-cmake"><a aria-hidden="true" tabindex="-1" href="#parsing-cmdline-and-cmake"><span class="icon icon-link"></span></a>Parsing, cmdline and cmake</h2>
<p>Supposedly, the project will provide a command line tool for user to input in either a path to a DEX file or a folder of DEX files so that the tool can either lift and lower the DEX file(s).</p>
<p>The command line executable is hand-written, with the formatting via <a href="https://fmt.dev/11.0/">fmt</a>.</p>
<p>Below shows the interface of the entry point executable when ran with <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">--help</span></span></code></span>:</p>
<pre><code>./shuriken-opt --help
USAGE: shuriken-opt [-h | --help] [-d | --diagnostics] [-f|--file file_name --lift -g|--graph --lower --opt]
    -h | --help: Shows the help menu, like what you're seeing right now
    -d | --diagnostics: Enables diagnostics for shuriken-opt
    -f | --file: Analyzes a file with file name, needs additional information
    -lift : Lift the dex format up to MjolnIR
    -lower: Lower the lifted MjolnIR down to smali (Enables lift when this is opted)
    -opt: Run some default optimization (Nop removal for now)
    -g | --graph: Dump the graph in dot format (needs a file)
</code></pre>
<p>To maintain the build of the project, I opt for CMake, which is both Shuriken's build system and LLVM and MLIR's build system. It's also a build system tool I'm most familiar with in C++ ecosystem.</p>
<h2 id="dialect-reusability-and-extensibility"><a aria-hidden="true" tabindex="-1" href="#dialect-reusability-and-extensibility"><span class="icon icon-link"></span></a>Dialect reusability and extensibility</h2>
<p>A high selling point of MLIR is the ability to reuse its dialects and the ease of defining new dialects in it. This is no different for our library, with our dialect MjolnIR.</p>
<p>In MLIR, there are multiple ways to define a dialect. You can either opt for MLIR's C++ API way to define it. Even though quick, the downsides of this quickly catches up: tons of boilerplate and scattering codes scatter across different files, which screams "update me" whenever LLVM goes to a new version, introducing breaking changes.</p>
<p>Another way to go is via TableGen, a generic language to maintain records of DSLs in a concise way. Benefits (that are relevant to the project) include:</p>
<ul>
<li>Centralized source of truth: Every aspect of an operation should be in the same localized place. This is true to some extent. Some parts of TableGen syntax regarding MLIR are still a bit hazy to me and requires digging through either the MLIR docs or the source code itself for clarification; I think this is expected for any beginners.</li>
<li>Boilerplate removal and auto generation: defining and extending a dialect in TableGen syntax is easier than in C++, due to its cutting down on non-needed aspect when extending and its auto-generative nature.</li>
</ul>
<p><a href="https://mlir.llvm.org/docs/Tutorials/Toy/Ch-2/#op-vs-operation-using-mlir-operations">Chapter 2</a> in the toy tutorial demonstrates this the clearest, I recommend a quick skim for confidence.</p>
<p>Introductory asides, it's clear we opt for the TableGen method instead. I'm also in favor of using TableGen since this is an opportunity to learn about new stuff!</p>
<p>In our library, we reuse two of the built-in dialects: <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">arith</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">cf</span></span></code></span>. We also extend upon this by creating new operations:</p>
<ul>
<li>A pseudo branch operation <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">MjolnIR</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">fallthrough</span></span></code></span> since entering a block in MLIR requires control flow but in smali the normalcy is to execute the next line after a branch if the condition is not met.</li>
<li>Two operations <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">MjolnIR</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">method</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">MjolnIR</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">return</span></span></code></span> to replace <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">func</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">func</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">func</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">return</span></span></code></span> since we need to capture extra infos about our method such as accessors such as public, private, static, etc... The <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">func</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">return</span></span></code></span> is obsolete since it requires that its parent is <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">func</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">func</span></span></code></span>, thus the need for <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">MjolnIR</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">return</span></span></code></span>.</li>
</ul>
<h4 id="conclude"><a aria-hidden="true" tabindex="-1" href="#conclude"><span class="icon icon-link"></span></a>Conclude</h4>
<p>Doing the project in MLIR's system introduces several benefits:</p>
<ul>
<li>Reusing different built-in dialects from MLIR saves myself a lot of time from implementation design and implementation bugs.</li>
<li>Everything in MLIR (for a beginner) fits well together. For example, the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">cf</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">condbr</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">cf</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">br</span></span></code></span> plays really nice with MLIR's SSA block arguments style, providing iterators to their respective block arguments. Having implemented the alternative phi node version in <a href="https://capra.cs.cornell.edu/bril/intro.html">bril</a> IR makes me realize how clean MLIR's SSA form actually is. In addition, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span> provides different ways to identify if a value is from a function or block's argument or a normal value, this makes generating values for smali's <code>p{}</code> (method parameters) and <code>v{}</code> (local variables) relatively easy.</li>
</ul>
<h2 id="non-mlir-non-ssa-cfg-to-mlir-ssa-cfg"><a aria-hidden="true" tabindex="-1" href="#non-mlir-non-ssa-cfg-to-mlir-ssa-cfg"><span class="icon icon-link"></span></a>Non-MLIR, NON-SSA CFG to MLIR-SSA CFG</h2>
<blockquote>
<p>From this point forward, referring to non-ssa CFG means that it is non-mlir and vice versa (as MLIR requires SSA form in its CFG).</p>
</blockquote>
<p>A special characteristic of DEX is that it utilizes (almost infinite) virtual registers without caring for stack space.
This allows for a seamless construction of the program's CFG from the DEX format.</p>
<p>After constructing the CFG's non-SSA form, we translate it to MLIR's SSA CFG via <a href="https://c9x.me/compile/bib/braun13cc.pdf">Braun's SSA algorithm</a></p>
<p>On the high level overview, we keep an <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">DenseMap</span></span></code></span> between the original CFG's basic blocks to a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">BasicBlockDef</span></span></code></span>, this is meant to replace the paper's <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">currentDef</span><span style="color:#949CBB">[</span><span style="color:#C6D0F5">variable</span><span style="color:#949CBB">][</span><span style="color:#C6D0F5">Block</span><span style="color:#949CBB">]</span></span></code></span>.</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">struct</span><span style="color:#E5C890;font-style:italic"> BasicBlockDef</span><span style="color:#949CBB"> {</span><span style="color:#737994;font-style:italic"> // stripped down version of BasicBlockDef</span></span>
<span class="line"><span style="color:#E5C890">    mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">DenseMap</span><span style="color:#81C8BE">&#x3C;</span><span style="color:#E5C890">std</span><span style="color:#949CBB">::</span><span style="color:#CA9EE6">uint32_t</span><span style="color:#949CBB">,</span><span style="color:#E5C890"> mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span><span style="color:#81C8BE">></span><span style="color:#C6D0F5"> Defs</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#737994;font-style:italic">    // ...</span></span>
<span class="line"><span style="color:#CA9EE6">    unsigned</span><span style="color:#C6D0F5"> Filled : </span><span style="color:#EF9F76">1</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">};</span></span></code></pre>
<p>In the BasicBlockDef wraps another <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">DenseMap</span></span></code></span> of <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">uint32</span></span></code></span> to <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span>, this is how we're accessing the <code>variable</code> in <code>currentDef[variable][Block]</code> from the paper's algorithm.</p>
<p>When the original CFG's instructions ask to either read or write to DEX's virtual registers, we either get the value from our map between integers and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span> in the current block, or we recursively call the query on the block's predecessor(s).</p>
<p>The query of a variable's definition in a block's map in the project is the equivalent of C++ MLIR's</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">DenseMap</span><span style="color:#949CBB">[</span><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Block</span><span style="color:#81C8BE">*</span><span style="color:#949CBB">][</span><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">DenseMap</span><span style="color:#949CBB">[</span><span style="color:#E5C890">std</span><span style="color:#949CBB">::</span><span style="color:#CA9EE6">uint32_t</span><span style="color:#949CBB">][</span><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span><span style="color:#949CBB">]]</span></span></code></pre>
<h2 id="optimization-and-analysis"><a aria-hidden="true" tabindex="-1" href="#optimization-and-analysis"><span class="icon icon-link"></span></a>Optimization and Analysis</h2>
<p>In writing an optimization pass, MLIR offers a variety of tools for the job. Different machinery includes <a href="https://mlir.llvm.org/docs/Tutorials/DataFlowAnalysis/">DataFlowAnalysis</a>, <a href="https://mlir.llvm.org/docs/PatternRewriter/">Pattern Rewriters</a>, <a href="https://mlir.llvm.org/docs/PassManagement/">generic operation pass</a>.</p>
<p>In writing up this part of the project, the biggest obstacles is surprisingly not about learning the apis of different optimization tools, but actually verifying MLIR's and ourselves' dialect.</p>
<p>For time management, I'm opting for a simple pattern rewriter to remove all nops: the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">applyPatternsAndFoldGreedily</span></span></code></span> pass. Using the pass runs MLIR's verifier on its built-in dialect, triggering a lot of errors on our compiler build. Despite this, fixing this was somewhat straight forward with MLIR's error messages (?!) and documentation on its operations.</p>
<h2 id="translation"><a aria-hidden="true" tabindex="-1" href="#translation"><span class="icon icon-link"></span></a>Translation</h2>
<h3 id="parameter-versus-local-registers"><a aria-hidden="true" tabindex="-1" href="#parameter-versus-local-registers"><span class="icon icon-link"></span></a>Parameter versus local registers</h3>
<p>The Smali IR differentiates between a parameter and a local variable with the prefix <code>p</code> or <code>v.</code> This in turn requires us to also somehow identify this in MLIR.</p>
<p>Fortunately with MLIR's helpful methods such as <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">llvm</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">dyn_cast</span><span style="color:#949CBB">&#x3C;>()</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">llvm</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">isa</span><span style="color:#949CBB">&#x3C;>()</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">BlockArgument</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">getOwner</span><span style="color:#949CBB">()</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Block</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">isEntryBlock</span><span style="color:#949CBB">()</span></span></code></span>, it was relatively straightforward to resolve this, which will be shown in the next section.</p>
<h3 id="getting-out-of-ssa"><a aria-hidden="true" tabindex="-1" href="#getting-out-of-ssa"><span class="icon icon-link"></span></a>Getting out of SSA</h3>
<h4 id="ssa-value-to-virtual-registers"><a aria-hidden="true" tabindex="-1" href="#ssa-value-to-virtual-registers"><span class="icon icon-link"></span></a>SSA value to virtual registers</h4>
<p>Since SSA variables are only assigned once, we can assign each SSA variable to its virtual register counter-part by keeping a counter, seeing a new SSA variable means incrementing the counter and assign that SSA variable that newly incremented counter value.</p>
<p>We'll use C++ templating to do this with a class called <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">SmaliCounter</span></span></code></span>, generic on type <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Aspect</span></span></code></span>.</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">template</span><span style="color:#949CBB">&#x3C;</span><span style="color:#CA9EE6">class</span><span style="color:#E5C890;font-style:italic"> Aspect</span><span style="color:#949CBB">></span><span style="color:#737994;font-style:italic"> // a template so we can reuse it</span></span>
<span class="line"><span style="color:#CA9EE6">class</span><span style="color:#E5C890;font-style:italic"> SmaliCounter</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#CA9EE6">    size_t</span><span style="color:#C6D0F5"> counter </span><span style="color:#81C8BE">=</span><span style="color:#EF9F76"> 0</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#E5C890">    mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">DenseMap</span><span style="color:#81C8BE">&#x3C;</span><span style="color:#C6D0F5">Aspect</span><span style="color:#949CBB">,</span><span style="color:#CA9EE6"> size_t</span><span style="color:#81C8BE">></span><span style="color:#C6D0F5"> counter_map</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">public</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">    SmaliCounter</span><span style="color:#949CBB">(</span><span style="color:#CA9EE6">size_t</span><span style="color:#EA999C;font-style:italic"> start_from</span><span style="color:#949CBB">)</span><span style="color:#949CBB"> :</span><span style="color:#8CAAEE;font-style:italic"> counter</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">start_from</span><span style="color:#949CBB">)</span><span style="color:#949CBB"> {}</span></span>
<span class="line"><span style="color:#CA9EE6">    size_t</span><span style="color:#8CAAEE;font-style:italic"> get_counter</span><span style="color:#949CBB">(</span><span style="color:#E5C890;font-style:italic">Aspect</span><span style="color:#EA999C;font-style:italic"> a</span><span style="color:#949CBB">)</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#CA9EE6">        if</span><span style="color:#949CBB"> (</span><span style="color:#E78284">this</span><span style="color:#949CBB">-></span><span style="color:#C6D0F5">counter_map</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">find</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">a</span><span style="color:#949CBB">)</span><span style="color:#81C8BE"> ==</span><span style="color:#E78284"> this</span><span style="color:#949CBB">-></span><span style="color:#C6D0F5">counter_map</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">end</span><span style="color:#949CBB">())</span></span>
<span class="line"><span style="color:#E78284">            this</span><span style="color:#949CBB">-></span><span style="color:#C6D0F5">counter_map</span><span style="color:#949CBB">[</span><span style="color:#C6D0F5">a</span><span style="color:#949CBB">]</span><span style="color:#81C8BE"> =</span><span style="color:#C6D0F5"> counter</span><span style="color:#81C8BE">++</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">        return</span><span style="color:#E78284"> this</span><span style="color:#949CBB">-></span><span style="color:#C6D0F5">counter_map</span><span style="color:#949CBB">[</span><span style="color:#C6D0F5">a</span><span style="color:#949CBB">];</span></span>
<span class="line"><span style="color:#949CBB">    }</span></span>
<span class="line"><span style="color:#949CBB">};</span></span></code></pre>
<p>We have 3 counters to keep track of: the parameters, the local variables and the basic blocks themselves. Let's respectively call them <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">prc</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">vrc</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">bc</span></span></code></span>. To determine a location to jump to, we input a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Block</span><span style="color:#81C8BE">*</span></span></code></span> to <code>bc</code> and get out either a preexisting location or a new one, as indicated by <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">get_counter</span></span></code></span>.</p>
<p>The situation is a bit trickier with <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">prc</span></span></code></span> (method parameters) and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">vrc</span></span></code></span> (local variables) since they're both <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span>. However, an interesting thing to note is that the method parameters are actually <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">BlockArgument</span></span></code></span>, a subclass of <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span>. This subclass exposes a method called <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">getOwner</span></span></code></span> that returns a block*, and the block in turns exposes a method to check if its the entry block of a method or not.</p>
<p>Thus, if an <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span> is actually of <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">BlockArgument</span></span></code></span> and if it belongs to the entry block of a method, then it is a parameter, and will be inputted to <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">prc</span></span></code></span> and vice versa. I add the second requirement since a block argument can also come from different blocks that are glued together by control flow instead.</p>
<h4 id="dealing-with-phis-block-arguments-ssa-destruction"><a aria-hidden="true" tabindex="-1" href="#dealing-with-phis-block-arguments-ssa-destruction"><span class="icon icon-link"></span></a>Dealing with phis (block arguments) (SSA destruction)</h4>
<p>In translating from MjolnIR to smali, I opted for a simple out-of-ssa transformation <a href="https://github.com/mwillsey/cs265/blob/2024-fall/lessons/03-ssa.md#converting-out-of-ssa">introduced in class</a>, slightly tweaked to fit MLIR's ssa block arguments fashion:</p>
<pre><code>For every control flow (cf.condbr and cf.br):
 - Copies the current arguments being passed into the true block,
to the actual parameters, which looks like (move* vA, vB)

 - Inserts an instruction that jumps to the true block
if the operand to the instruction is true, which looks like (if-* vX, :block_Y)

 - Copies the current arguments being passed into the false block,
to the actual parameters, which looks like (move* vA, vB)

 - Inserts an instruction that jumps to the false block,
which looks like (goto :block_Y)

The cf.br case simply reduces down to the last two step.
</code></pre>
<p>The following drawing executes the algorithm on a handwritten example.</p>
<p><img src="/blogs/out_of_ssa.svg" alt="out_of_ssa.svg"></p>
<h4 id="control-flow-combination"><a aria-hidden="true" tabindex="-1" href="#control-flow-combination"><span class="icon icon-link"></span></a>Control flow combination</h4>
<p>A quirky thing between MLIR and smali is how they differ in their branching.</p>
<p>In MLIR, we first obtain a boolean value from something like <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">arith</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">cmpi</span></span></code></span>. Then we use this value to feed it
into <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">cf</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">condbr</span></span></code></span> to either jump to a block or continue as normal.</p>
<p>In contrast, smali employs different kind of <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">if</span><span style="color:#81C8BE">-*</span></span></code></span> instructions as a way to combine the MLIR's two-step approach.</p>
<p>For example, an <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">if</span><span style="color:#81C8BE">-</span><span style="color:#C6D0F5">ne</span></span></code></span> is used to represent a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">arith</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">cmpi</span></span></code></span> instruction of two <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span>, and then depending on if they're equal or not, jump to a block.</p>
<p>I'll once again use the SSA property to resolve this issue.</p>
<p>Upon a branching based on a predicate (<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">cf</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">condbr</span></span></code></span>), we can query the defining op of an <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span></span></code></span> to obtain its boolean defining operation (defOp) (step 1 in mlir). Notice that when we first encounter that defOp, we still generate its smali equivalent (since we don't know if it might be used once or multiple times or will be passed in to some other blocks). Then, we proceed to pick the correct branching smali instruction. Since the nature of SSA is a value can only be defined once, a single value can not correspond to different defOps.</p>
<p>For the case that <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">mlir</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Value</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">getDefiningOp</span><span style="color:#949CBB">()</span></span></code></span> returning <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E78284">nullptr</span></span></code></span>, this means that its a block argument. We just generate <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">if</span><span style="color:#81C8BE">-</span><span style="color:#C6D0F5">nez</span></span></code></span> from smali.</p>
<p>For this part (translating), I think what troubles me the most is the fact that, to the best of our knowledge, no project exists to translate from a custom IR to smali. Combined with limited knowledge of both smali and MLIR, the cycle continues itself since not knowing smali well requires me to perform multiple iteration on the custom IR, which suffers again from limited knowledge of MLIR.</p>
<h2 id="so-whats-going-on-right-now-jaz-whats-next"><a aria-hidden="true" tabindex="-1" href="#so-whats-going-on-right-now-jaz-whats-next"><span class="icon icon-link"></span></a>So what's going on right now Jaz? What's next?</h2>
<p>The project's progressing at a steady rate right now, with me and Edu's contributing on the MLIR side.</p>
<p>Contentedly, with different priorities both in my life (looking at you "full time recruiting") and in UC Berkeley (looking at you EE16B and EE126), a short timeline of 6 weeks renders the initial goals of the project somewhat incomplete. That is, although lifting and simple analysis of DEX via MLIR is achieved, some work are needed in translating MjolnIR to smali.</p>
<p>In retrospect, I think I should have thought ahead and started the project 4 weeks earlier (1 month into class). More familiarity with SSA form, SSA construction earlier in the process would have expedited porting the lifter as well as writing up the out-of-ssa translation.</p>
<p>After the semester ends, I'll continue working on the MjolnIR-to-smali translation, besides supporting new DEX feature into MjolnIR and refactoring existing code. Then, some form of dataflow analysis on the new IR is expected.</p>
<p>With this new-found knowledge of MLIR, the next steps would be trying to write <a href="https://github.com/badumbatish/tyoMLIR">an ML compiler</a> by extending upon MLIR's <a href="https://mlir.llvm.org/docs/Tutorials/Toy/">toy tutorial</a></p>
<blockquote>
<p>But why contentedly?</p>
</blockquote>
<p>I've been wanting to dive deeper into MLIR for a long time. When it was time to choose a project, in the back of my mind, I've had some doubts. But ughh, I want to learn, and I don't care if a project I chose ran into time constraints. It was important for me to learn about an industry's tools as well as put my mind to implement different algorithms I've learned in classes in the ecosystem.</p>
<p>I think <a href="https://www.youtube.com/Vsauce">VSauce</a>'s supertask's <a href="https://youtu.be/ffUnNaQTfZE?si=7byTONQdK9pP3JnI&#x26;t=1062">17:42 to 20:07</a> captures the best the mentality on the project.</p>
<p>I hope everyone's enjoyed the little 15-minute read, I'll see everyone soon with some new blog post :)</p>
<h2 id="resources"><a aria-hidden="true" tabindex="-1" href="#resources"><span class="icon icon-link"></span></a>Resources</h2>
<p>Below lies the related resources I've visited during the timeline of the project.</p>
<h3 id="figures"><a aria-hidden="true" tabindex="-1" href="#figures"><span class="icon icon-link"></span></a>Figures</h3>
<p>Jasmine</p>
<ul>
<li><a href="https://badumbatish.github.io/">https://badumbatish.github.io/</a></li>
<li><a href="https://bsky.app/profile/badumbatish.bsky.social">bluesky</a></li>
<li><a href="https://www.linkedin.com/in/jjasmine-t/">linkedin</a></li>
</ul>
<p>Edu</p>
<ul>
<li><a href="https://farena.in/">https://farena.in/</a></li>
<li><a href="https://bsky.app/profile/farena.in">bluesky</a></li>
<li><a href="https://x.com/Farenain">twitter</a></li>
</ul>
<p>Max Willsey</p>
<ul>
<li><a href="https://www.mwillsey.com/">https://www.mwillsey.com/</a></li>
</ul>
<p>Jeremy Kun</p>
<ul>
<li><a href="https://www.jeremykun.com/">https://www.jeremykun.com/</a></li>
</ul>
<h3 id="tutorials-and-docs"><a aria-hidden="true" tabindex="-1" href="#tutorials-and-docs"><span class="icon icon-link"></span></a>Tutorials and Docs</h3>
<p>A good tutorial read is MLIR's official <a href="https://mlir.llvm.org/docs/Tutorials/Toy/">toy tutorial</a>. It helps me familiarize myself with the commandline, different elements in MLIR and different ways to do things, as well as their trade-offs.</p>
<p>Jeremy's <a href="https://github.com/j2kun/mlir-tutorial">MLIR tutorials</a> brings a fresh change into LLVM's terse style of tutorial, I frequent the sites a lot and recommends if you're trying to learn more about mlir.</p>
<p>MLIR's <a href="https://mlir.llvm.org/doxygen/index.html">doxygen</a> page is much needed for resolving dependency issues as well as correct usage of MLIR's elements. I recommend familiarizing yourself with different operations' and values' method signatures.</p>
<p>MLIR's <a href="https://mlir.llvm.org/docs/LangRef/">LangRef</a> provides a good worldview about its ecosystem for a beginner.</p>
<p>ChatGPT and Claude are also (not really, but kinda) helpful tools in super boosting your learning about MLIR and LLVM's api.</p>
<h3 id="algorithms"><a aria-hidden="true" tabindex="-1" href="#algorithms"><span class="icon icon-link"></span></a>Algorithms</h3>
<p>Max Willsey's <a href="https://github.com/mwillsey/cs265/blob/2024-fall/lessons/03-ssa.md">lesson</a> about SSA form is much needed for the project. I also recommended another introductory perspective into the matter with Engineering a Compiler's chapter 9.3.</p>
<p>A read for <a href="https://c9x.me/compile/bib/braun13cc.pdf">Braun's algorithm</a> is also required. Edu also posted about it for MLIR <a href="https://farena.in/compilers/mlir/ssa-mlir-algorithm/">here</a>, which forms the foundation for his implementation in <a href="https://github.com/Fare9/KUNAI-static-analyzer">KUNAI</a>.</p></div></article></div><button class="bottom-4 right-4 fixed"><div class="inline text-2xl font-bold border-black border-2 rounded  p-0 m-0 h-100 w-100">⇡⇡</div></button><footer class="footer self-center justify-center gap-2 pt-4 items-center italic "><p>I&#x27;m looking for new grad compiler work, please email at jjasmine@berkeley.edu</p><p>Built by Jasmine with NextJS, TailwindCSS, and a tonnn of loveee :)</p></footer><script src="/_next/static/chunks/webpack-024c71c063ddb8d8.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[8173,[\"173\",\"static/chunks/173-ad05a37061268ac6.js\",\"565\",\"static/chunks/565-d3001cb0b7ac580c.js\",\"177\",\"static/chunks/app/layout-5c184bc8512acba2.js\"],\"\"]\n3:I[5244,[],\"\"]\n4:I[3866,[],\"\"]\n5:I[1168,[\"173\",\"static/chunks/173-ad05a37061268ac6.js\",\"565\",\"static/chunks/565-d3001cb0b7ac580c.js\",\"177\",\"static/chunks/app/layout-5c184bc8512acba2.js\"],\"default\"]\n7:I[6213,[],\"OutletBoundary\"]\n9:I[6213,[],\"MetadataBoundary\"]\nb:I[6213,[],\"ViewportBoundary\"]\nd:I[4835,[],\"\"]\n:HL[\"/_next/static/media/7385e8d9d3c5518f-s.p.ttf\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/ttf\"}]\n:HL[\"/_next/static/css/4c262d18fc086fff.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"XprnscMOY58CZpZ9HfFrD\",\"p\":\"\",\"c\":[\"\",\"posts\",\"going_to_mlir_gym_1\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"posts\",{\"children\":[[\"id\",\"going_to_mlir_gym_1\",\"d\"],{\"children\":[\"__PAGE__\",{}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/4c262d18fc086fff.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"px-4 py-4\",\"children\":[\"$\",\"body\",null,{\"className\":\"__className_d4e0c8 flex flex-col min-h-screen\",\"children\":[[\"$\",\"$L2\",null,{\"href\":\"/\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex justify-center items-center py-4 \",\"children\":[\"$\",\"h1\",null,{\"className\":\"text-4xl font-bold\",\"children\":\"Jasmine Tang\"}]}]}],[\"$\",\"div\",null,{\"className\":\"flex-1\",\"children\":[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]}],[\"$\",\"$L5\",null,{}],[\"$\",\"footer\",null,{\"className\":\"footer self-center justify-center gap-2 pt-4 items-center italic \",\"children\":[[\"$\",\"p\",null,{\"children\":\"I'm looking for new grad compiler work, please email at jjasmine@berkeley.edu\"}],[\"$\",\"p\",null,{\"children\":\"Built by Jasmine with NextJS, TailwindCSS, and a tonnn of loveee :)\"}]]}]]}]}]]}],{\"children\":[\"posts\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[[\"id\",\"going_to_mlir_gym_1\",\"d\"],[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L3\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"posts\",\"children\",\"$0:f:0:1:2:children:2:children:0\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L4\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[\"$L6\",null,[\"$\",\"$L7\",null,{\"children\":\"$L8\"}]]}],{},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"rXONvhGFs6t8prMwQItaV\",{\"children\":[[\"$\",\"$L9\",null,{\"children\":\"$La\"}],[\"$\",\"$Lb\",null,{\"children\":\"$Lc\"}],[\"$\",\"meta\",null,{\"name\":\"next-size-adjust\",\"content\":\"\"}]]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$d\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"c:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n"])</script><script>self.__next_f.push([1,"e:Tf1da,"])</script><script>self.__next_f.push([1,"\u003cnav class=\"toc\"\u003e\u003col class=\"toc-level toc-level-1\"\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#prologue\"\u003ePrologue\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#reader-supporting-section\"\u003eReader supporting section\u003c/a\u003e\u003col class=\"toc-level toc-level-2\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#terminology\"\u003eTerminology\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#acronyms\"\u003eAcronyms\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#introduction\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#planning\"\u003ePlanning\u003c/a\u003e\u003col class=\"toc-level toc-level-2\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#version-control-and-contributions\"\u003eVersion control and contributions\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#goals-and-current-status\"\u003eGoals and current status\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#mlirs-operations-and-values\"\u003eMLIR's operations and values\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#operations\"\u003eOperations\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#values\"\u003eValues\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#dissecting-mlir\"\u003eDissecting MLIR\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#parsing-cmdline-and-cmake\"\u003eParsing, cmdline and cmake\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#dialect-reusability-and-extensibility\"\u003eDialect reusability and extensibility\u003c/a\u003e\u003col class=\"toc-level toc-level-2\"\u003e\u003cli class=\"toc-item toc-item-h4\"\u003e\u003ca class=\"toc-link toc-link-h4\" href=\"#conclude\"\u003eConclude\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#non-mlir-non-ssa-cfg-to-mlir-ssa-cfg\"\u003eNon-MLIR, NON-SSA CFG to MLIR-SSA CFG\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#optimization-and-analysis\"\u003eOptimization and Analysis\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#translation\"\u003eTranslation\u003c/a\u003e\u003col class=\"toc-level toc-level-2\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#parameter-versus-local-registers\"\u003eParameter versus local registers\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#getting-out-of-ssa\"\u003eGetting out of SSA\u003c/a\u003e\u003col class=\"toc-level toc-level-3\"\u003e\u003cli class=\"toc-item toc-item-h4\"\u003e\u003ca class=\"toc-link toc-link-h4\" href=\"#ssa-value-to-virtual-registers\"\u003eSSA value to virtual registers\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h4\"\u003e\u003ca class=\"toc-link toc-link-h4\" href=\"#dealing-with-phis-block-arguments-ssa-destruction\"\u003eDealing with phis (block arguments) (SSA destruction)\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h4\"\u003e\u003ca class=\"toc-link toc-link-h4\" href=\"#control-flow-combination\"\u003eControl flow combination\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#so-whats-going-on-right-now-jaz-whats-next\"\u003eSo what's going on right now Jaz? What's next?\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h2\"\u003e\u003ca class=\"toc-link toc-link-h2\" href=\"#resources\"\u003eResources\u003c/a\u003e\u003col class=\"toc-level toc-level-2\"\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#figures\"\u003eFigures\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#tutorials-and-docs\"\u003eTutorials and Docs\u003c/a\u003e\u003c/li\u003e\u003cli class=\"toc-item toc-item-h3\"\u003e\u003ca class=\"toc-link toc-link-h3\" href=\"#algorithms\"\u003eAlgorithms\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/nav\u003e\u003ch2 id=\"prologue\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#prologue\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003ePrologue\u003c/h2\u003e\n\u003cp\u003eHi there, I hope everyone's having a great day, this article is about lifting and lowering DEX instructions in MLIR, utilizing the framework in analysing and optimizing the \u003ca href=\"https://source.android.com/docs/core/runtime/dalvik-bytecode\"\u003eDEX\u003c/a\u003e format.\u003c/p\u003e\n\u003cp\u003eThe blog is intended as a report submission for \u003ca href=\"https://www2.eecs.berkeley.edu/Courses/CS265/\"\u003eCS265\u003c/a\u003e \u003ca href=\"https://github.com/mwillsey/cs265\"\u003ehere\u003c/a\u003e. The report focuses more on the high level details. The project also discusses the ease (or uneasiness) of executing the project, meanwhile introducing the benefits of MLIR with its elements in the ecosystem\u003c/p\u003e\n\u003cp\u003eThe report is about 3700 words, or 15 minutes of reading. The editing cut-off is 12PM PST Dec 17th 2024.\u003c/p\u003e\n\u003cp\u003eI also include a supporting section to recap different terminologies for unfamiliar readers.\u003c/p\u003e\n\u003cp\u003ePlease try out this \u003ca href=\"https://www.youtube.com/watch?v=-KhfFjCwFDU\u0026#x26;ab_channel=Mademoiselle\"\u003esong\u003c/a\u003e while reading, it really soothes the mind. I hope everyone enjoys :)\u003c/p\u003e\n\u003ch2 id=\"reader-supporting-section\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#reader-supporting-section\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eReader supporting section\u003c/h2\u003e\n\u003cp\u003e\u003c/p\u003e\u003cdetails\u003e\u003csummary\u003eOpen Reader supporting section\u003c/summary\u003e\u003cp\u003e\u003c/p\u003e\n\u003cp\u003eThis section introduces some terminology and/or acronyms that reviews from my friends deemed might be important context.\u003c/p\u003e\n\u003ch3 id=\"terminology\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#terminology\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eTerminology\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eSSA: Static Single Assignment, a form where each variable is assigned exactly once, enabling easier optimization and analysis. This form is enforced in MLIR. We'll see the useful feature of this in the translation section.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ePhi: A phi node is an SSA (Static Single Assignment) construct that selects a value based on the control flow predecessor, allowing variables to have multiple incoming definitions at a basic block merge point.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eBlock arguments: Equivalent to phi (?!) but in a different form.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDialect: A custom language extension in MLIR like arith (stands for arithmetic) or cf (stands for control flow) or func (for function related things) used to represent IRs.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOperations: A term (and concrete thing in MLIR's C++ API) that can be used to represent different concepts in MLIR. This ranges from higher-level concepts like function definitions, function calls, buffer allocations, view or slices of buffers, and process creation, to lower-level concepts like target-independent arithmetic, target-specific instructions, configuration registers, and logic gates.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eTo give an example of the two terminology, the dialect \u003ccode\u003earith\u003c/code\u003e features different operations such \u003ccode\u003eaddf\u003c/code\u003e (adding two floats) or \u003ccode\u003eaddi\u003c/code\u003e (adding two integers) or \u003ccode\u003ecmpi\u003c/code\u003e (comparing two integers). Another example is the \u003ccode\u003efunc\u003c/code\u003e's dialect's \u003ccode\u003efunc\u003c/code\u003e (to represent a function) or \u003ccode\u003ereturn\u003c/code\u003e to represent a return call or \u003ccode\u003ecall\u003c/code\u003e to represent invoking a function.\u003c/p\u003e\n\u003ch3 id=\"acronyms\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#acronyms\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eAcronyms\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eLLVM: used to mean Low level virtual machine, but now is an umbrella term for a collection of modular and reusable compiler and toolchain technologies. Another meaning for LLVM is the subproject LLVM within the LLVM collection. The subproject provides reusable components for code generation, optimization, and analysis, enabling developers to build high-performance, platform-agnostic tools.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eMLIR: stands for Multi-Level Intermediate Representation. A flexible, extensible compiler infrastructure within the LLVM project designed to support multiple levels of abstraction and domain-specific optimizations. It provides a unified framework for building high-performance compilers and tools tailored to diverse hardware and programming models.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eDEX: Stands for Dalvik Executable, which is a format used on Android before being replaced by ART, which stands for Android runtime.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eMjolnIR: A custom IR for representing DEX instructions built from MLIR's facility. The library's current implementation uses this IR primarily.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eBasic block (BB): a straight-line code sequence with no branches in except to the entry and no branches out except at the exit.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCFG: Control flow graph, the graphical representation of control flow or computation during the execution of programs or applications. On its most basic level, a CFG (control flow graph) contains a bunch of BBs (basic blocks), which are glued together by control flows\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003c/p\u003e\u003c/details\u003e\u003cp\u003e\u003c/p\u003e\n\u003ch2 id=\"introduction\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#introduction\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eIntroduction\u003c/h2\u003e\n\u003cp\u003eThe MLIR project from the LLVM framework provides a framework for building reusable and extensible compiler infrastructure, allowing for a unified handling of different IRs within the same framework.\u003c/p\u003e\n\u003cp\u003eIn the case of the library \u003ca href=\"https://github.com/Shuriken-Group/Shuriken-Analyzer\"\u003eShuriken\u003c/a\u003e from \u003ca href=\"https://github.com/Shuriken-Group\"\u003eShuriken Group\u003c/a\u003e for Dalvik Executable (DEX) file analysis, we can leverage the MLIR by extending a somewhat 1-to-1 mapping of DEX to MLIR, the newly created IR (MjolnIR), allowing us to use the much more mature framework for analyzing the binary itself. As DEX is used as a mean for transportation from a server to an android device where it is compiled into ART for installation, being able to optimize the bytecode size of dex allows us to save cost on networking as well as server and android device's storage cost.\u003c/p\u003e\n\u003cp\u003eIn the future, MjolnIR will be used in optimization, obfuscating, deobfuscating the Dalvik Machine Bytecode.\u003c/p\u003e\n\u003cp\u003eThis project (and this blog post) wouldn't be possible without the guidance of Eduardo (Edu) Blázquez González (Fare9), (\u003ca href=\"https://farena.in/\"\u003eEduardo\u003c/a\u003e), a PhD doctorate and a compiler engineer at Quarkslab in developing, lifting and lowering the IR.\nThis summer, Edu's the one that reached out to me on twitter to befriend me :) We chatted about compilers and stuff, and later he introduced me to the codebase.\nHe's been helping me with onboarding the codebase infrastructure, together with emotional support and chatting about life hahahah :)\u003c/p\u003e\n\u003cp\u003eI am also grateful to \u003ca href=\"https://www.mwillsey.com/\"\u003eMax Willsey\u003c/a\u003e, the professor of the compiler graduate class CS265, for allowing me, an undergraduate to enroll as well as guiding me on the direction of the project.\nThroughout the semester, there were some assignments where I fell behind. I know that opportunities are hard to come by and I really took every lesson to heart. I thank you for your advice and your bet for taking me into the class :)\u003c/p\u003e\n\u003cp\u003eMuch work is needed in supporting the full instruction set of DEX as well as optimization of it. The project report will discuss the current work (which is a subset of the DEX instruction set) as well as future work.\u003c/p\u003e\n\u003ch2 id=\"planning\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#planning\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003ePlanning\u003c/h2\u003e\n\u003ch3 id=\"version-control-and-contributions\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#version-control-and-contributions\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eVersion control and contributions\u003c/h3\u003e\n\u003cp\u003eAll code for the project is under the \u003ca href=\"https://github.com/Shuriken-Group/Shuriken-Analyzer\"\u003eShuriken Analyzer\u003c/a\u003e repository, which is under the \u003ca href=\"https://github.com/Shuriken-Group\"\u003eShuriken Group\u003c/a\u003e's ownership.\u003c/p\u003e\n\u003cp\u003eThe group also includes other projects, such as\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/Shuriken-Group/setup_llvm_tools\"\u003eLLVM/MLIR dependency fetching tool\u003c/a\u003e: To power CI/CD for this project.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/Shuriken-Group/shuribot\"\u003eTelegram bot for Shuriken\u003c/a\u003e : for issue filing and status request, as our group's communication is mainly via telegram.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eMy contributions for the project are shown separately via the \u003ca href=\"https://github.com/Shuriken-Group/Shuriken-Analyzer/issues?q=is%3Aissue+author%3Abadumbatish\"\u003eissues\u003c/a\u003e and \u003ca href=\"https://github.com/Shuriken-Group/Shuriken-Analyzer/pulls?q=is%3Apr+author%3Abadumbatish\"\u003epull requests\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"goals-and-current-status\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#goals-and-current-status\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eGoals and current status\u003c/h3\u003e\n\u003cp\u003eIn analysing the DEX format, we need to parse the DEX file, construct a CFG (non-MLIR, and non-SSA), and then translate the CFG to MLIR's SSA CFG, apply some analysis, then \u003cem\u003etranslate it to smali\u003c/em\u003e, and then translate smali to dex (via 3rd party tool).\u003c/p\u003e\n\u003cp\u003eSmali is the human-readable assembly format for the dalvik virtual machine. Edu's provided us with a good \u003ca href=\"https://github.com/Shuriken-Group/Shuriken-Analyzer/wiki/smali_documentation\"\u003ewrite-up\u003c/a\u003e for smali that I think necessitates a read. Here, I show a small \"Hello World\" program written in smali that is compiled from java.\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e# This is a comment\n.method public static main([Ljava/lang/String;)V\n\t.registers 2 # We use a total of 2 registers here.\n\n    # Get the PrintStream object into register v0\n\tsget-object v0, Ljava/lang/System;-\u003eout:Ljava/lang/PrintStream;\n\n    # Get the const string \"Hello World\" into v1\n\tconst-string v1, \"Hello World\"\n\n    # Invoke v0's println method on v1\n\tinvoke-virtual {v0, v1}, Ljava/lang/PrintStream;-\u003eprintln(Ljava/lang/String;)V\n\n    # return void\n\treturn-void\n\n.end method\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe reasoning for this is that smali is an easier output to work with than dex. In dex format, we need to maintain different tables of strings, types, methods and classes in the pre-header before we get to output the actual DEX. To make matters worse, control flow are done via offsets, which disrupts optimization and requires recalculation of offsets.\u003c/p\u003e\n\u003cp\u003eIn smali, all is resolved via text references instead. In such a short amount of time (~ 6 weeks), it's hard to achieve true circular transformation (DEX-\u003eMLIR-\u003eDEX). I therefore opted for (DEX-\u003eMLIR-\u003esmali-\u003eDEX) first (actually at the time of writing this (Dec 7th 2024), I'm even nervous to see if we can get DEX-\u003eMLIR-\u003esmali for submission).\u003c/p\u003e\n\u003cp\u003eWith the naming of the MLIR's dialect being MjolnIR, the goal of the project is divided into two fronts:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAchieve the circular transformation of: DEX -\u003e MjolnIR (MLIR) -\u003e Smali.\u003c/li\u003e\n\u003cli\u003eSurvey some analysis/optimization provided by MLIR, using our new IR.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIn parsing the dex and constructing the CFG, the job was done by Edu prior to me joining the team. There was also an effort in lifting some subset of DEX to MLIR in the \u003ca href=\"https://github.com/Fare9/KUNAI-static-analyzer\"\u003eKUNAI\u003c/a\u003e repo by Edu (recorded \u003ca href=\"https://www.youtube.com/watch?v=hfqOivYdD40\u0026#x26;ab_channel=LLVM\"\u003ehere\u003c/a\u003e).\u003c/p\u003e\n\u003cp\u003eTherefore, my responsibilities in the project is to set up MLIR, port over and maintain the lifting process of DEX, figure out the optimization and lowering aspect.\u003c/p\u003e\n\u003cp\u003eThe diagram shown below details the steps we need to take in the project.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blogs/mlir_gym_goal.svg\" alt=\"mlir_gym_goal.svg\"\u003e\u003c/p\u003e\n\u003ch3 id=\"mlirs-operations-and-values\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#mlirs-operations-and-values\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eMLIR's operations and values\u003c/h3\u003e\n\u003ch3 id=\"operations\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#operations\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eOperations\u003c/h3\u003e\n\u003cp\u003eMLIR is built from what are known as \"Operations,\" which are used to describe many different levels of abstractions and computations.\u003c/p\u003e\n\u003cp\u003eEvery operation has a unique name, often written in the format dialect.operation_name. For example:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003earith.addi (integer addition in the arith dialect)\u003c/li\u003e\n\u003cli\u003efunc.func (function definition in the func dialect)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAn operation may contain one or more regions, which in turn contain blocks of other operations. This allows hierarchical nesting, making MLIR very expressive.\u003c/p\u003e\n\u003cp\u003eOn the top level, the MLIR features a \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eModuleOp\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, which is a container operation of a single graph region.\u003c/p\u003e\n\u003cp\u003eIn lifting DEX to MLIR, we think of\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAn input DEX file comprises 1 up to 65535 \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eModuleOp\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, where each \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eModuleOp\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e represents a class.\u003c/li\u003e\n\u003cli\u003eEach method (class's function) in the DEX file is a \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eMethodOp\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, a MjolnIR dialect's operation similarly to the \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003efunc\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e operation in func dialect.\u003c/li\u003e\n\u003cli\u003eEach method might have control flows, which glues together basic blocks.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAlthough a simple 1-1 representation, MLIR can feature much more complex hierarchy, as demonstrated below. We however, rely on the rigid structure we've defined for ourselves to simplify the lifting and lowering processes.\u003c/p\u003e\n\u003cp\u003eThe following diagram showcases MLIR's recursively fluid structure.\n\u003cimg src=\"/blogs/mlir_diagram_1.png\" alt=\"mlir_diagram_1\"\u003e\u003c/p\u003e\n\u003ch3 id=\"values\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#values\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eValues\u003c/h3\u003e\n\u003cp\u003eAn important thing to notice is how SSA form is represented in MLIR, which is done with \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e. The MLIR Value plays an important role in the project; operations take in values and produces values, passing them to functions and blocks (these are operations as described above) to get out\nsome value or to establish control flow. Hence, frequent trips to \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e's \u003ca href=\"https://mlir.llvm.org/doxygen/classmlir_1_1Value.html\"\u003edoxygen\u003c/a\u003e are needed. A fun thing to note is that with \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eDenseMap\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e can be hashed; this powers both the lifting process and the lowering process.\u003c/p\u003e\n\u003cp\u003eTo glue together the concept of operations and values, let's look at an example. Given an operation such as the integer addition\n\u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003earith\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eAddIOp\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, MLIR gives us different accessors such as \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003egetLhs\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003egetRhs\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003egetResult\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e to access its values.\nEach of these values can consequently invoke \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003egetParentBlock\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e or \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003ereplaceAllUsesWith\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e to further manipulate themselves.\u003c/p\u003e\n\u003cp\u003eIn a big picture with operations introduced above, the MLIR Language Reference succinctly says:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eMLIR is fundamentally based on a graph-like data structure of nodes, called Operations, and edges, called Values.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"dissecting-mlir\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#dissecting-mlir\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eDissecting MLIR\u003c/h3\u003e\n\u003cp\u003eKnowing how MLIR's operation and value works plays a crucial role in getting the recompiler working, as lifting, optimizing, and lowering all depend on them. I think therefore, it's also important to look at its textual form.\u003c/p\u003e\n\u003cp\u003eA pretty full (for our sakes) view of MLIR is shown below:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blogs/mlir_diagram_2.png\" alt=\"mlir_diagram_2\"\u003e\u003c/p\u003e\n\u003cp\u003eBelow, I show some demos of some textual MLIR.\u003c/p\u003e\n\u003cp\u003eFrom Jeremy Kun's tutorial (a pretty cool person and maybe my idol), which the report author heavily relies on:\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e// The first `func` is the dialect's name. The second `func` is the operation's name\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003efunc.func @\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003emain\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e%\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003earg0: i32\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e -\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e i32 \u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e{\u003c/span\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e // Variable names (SSA values) are prefixed with %\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e  // by convention naming of %arg0 means it is a different subclass than %0\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#81C8BE\"\u003e  %\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e math\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ectlz \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e%\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003earg0 : i32\u003c/span\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e // Here we're using ctlz operation from math dialect\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003e  func\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ereturn \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e%\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e : i32\u003c/span\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e // return op from func dialect\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e                    // taking in the ssa value %0 of type i32\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eA special thing for dialects in MLIR is that without a compiler writer's specified instruction to print an IR in textual form, MLIR will faithfully print everything that an operation has to the terminal (auto-generative aspect). This helps me quickly debug implementation issues in the project.\u003c/p\u003e\n\u003ch2 id=\"parsing-cmdline-and-cmake\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#parsing-cmdline-and-cmake\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eParsing, cmdline and cmake\u003c/h2\u003e\n\u003cp\u003eSupposedly, the project will provide a command line tool for user to input in either a path to a DEX file or a folder of DEX files so that the tool can either lift and lower the DEX file(s).\u003c/p\u003e\n\u003cp\u003eThe command line executable is hand-written, with the formatting via \u003ca href=\"https://fmt.dev/11.0/\"\u003efmt\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eBelow shows the interface of the entry point executable when ran with \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e--help\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e./shuriken-opt --help\nUSAGE: shuriken-opt [-h | --help] [-d | --diagnostics] [-f|--file file_name --lift -g|--graph --lower --opt]\n    -h | --help: Shows the help menu, like what you're seeing right now\n    -d | --diagnostics: Enables diagnostics for shuriken-opt\n    -f | --file: Analyzes a file with file name, needs additional information\n    -lift : Lift the dex format up to MjolnIR\n    -lower: Lower the lifted MjolnIR down to smali (Enables lift when this is opted)\n    -opt: Run some default optimization (Nop removal for now)\n    -g | --graph: Dump the graph in dot format (needs a file)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eTo maintain the build of the project, I opt for CMake, which is both Shuriken's build system and LLVM and MLIR's build system. It's also a build system tool I'm most familiar with in C++ ecosystem.\u003c/p\u003e\n\u003ch2 id=\"dialect-reusability-and-extensibility\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#dialect-reusability-and-extensibility\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eDialect reusability and extensibility\u003c/h2\u003e\n\u003cp\u003eA high selling point of MLIR is the ability to reuse its dialects and the ease of defining new dialects in it. This is no different for our library, with our dialect MjolnIR.\u003c/p\u003e\n\u003cp\u003eIn MLIR, there are multiple ways to define a dialect. You can either opt for MLIR's C++ API way to define it. Even though quick, the downsides of this quickly catches up: tons of boilerplate and scattering codes scatter across different files, which screams \"update me\" whenever LLVM goes to a new version, introducing breaking changes.\u003c/p\u003e\n\u003cp\u003eAnother way to go is via TableGen, a generic language to maintain records of DSLs in a concise way. Benefits (that are relevant to the project) include:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCentralized source of truth: Every aspect of an operation should be in the same localized place. This is true to some extent. Some parts of TableGen syntax regarding MLIR are still a bit hazy to me and requires digging through either the MLIR docs or the source code itself for clarification; I think this is expected for any beginners.\u003c/li\u003e\n\u003cli\u003eBoilerplate removal and auto generation: defining and extending a dialect in TableGen syntax is easier than in C++, due to its cutting down on non-needed aspect when extending and its auto-generative nature.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://mlir.llvm.org/docs/Tutorials/Toy/Ch-2/#op-vs-operation-using-mlir-operations\"\u003eChapter 2\u003c/a\u003e in the toy tutorial demonstrates this the clearest, I recommend a quick skim for confidence.\u003c/p\u003e\n\u003cp\u003eIntroductory asides, it's clear we opt for the TableGen method instead. I'm also in favor of using TableGen since this is an opportunity to learn about new stuff!\u003c/p\u003e\n\u003cp\u003eIn our library, we reuse two of the built-in dialects: \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003earith\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecf\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e. We also extend upon this by creating new operations:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eA pseudo branch operation \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eMjolnIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003efallthrough\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e since entering a block in MLIR requires control flow but in smali the normalcy is to execute the next line after a branch if the condition is not met.\u003c/li\u003e\n\u003cli\u003eTwo operations \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eMjolnIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003emethod\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e and \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eMjolnIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ereturn\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e to replace \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003efunc\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003efunc\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e and \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003efunc\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ereturn\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e since we need to capture extra infos about our method such as accessors such as public, private, static, etc... The \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003efunc\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ereturn\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e is obsolete since it requires that its parent is \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003efunc\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003efunc\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, thus the need for \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eMjolnIR\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ereturn\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"conclude\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#conclude\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eConclude\u003c/h4\u003e\n\u003cp\u003eDoing the project in MLIR's system introduces several benefits:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eReusing different built-in dialects from MLIR saves myself a lot of time from implementation design and implementation bugs.\u003c/li\u003e\n\u003cli\u003eEverything in MLIR (for a beginner) fits well together. For example, the \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecf\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003econdbr\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e and \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecf\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ebr\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e plays really nice with MLIR's SSA block arguments style, providing iterators to their respective block arguments. Having implemented the alternative phi node version in \u003ca href=\"https://capra.cs.cornell.edu/bril/intro.html\"\u003ebril\u003c/a\u003e IR makes me realize how clean MLIR's SSA form actually is. In addition, \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e provides different ways to identify if a value is from a function or block's argument or a normal value, this makes generating values for smali's \u003ccode\u003ep{}\u003c/code\u003e (method parameters) and \u003ccode\u003ev{}\u003c/code\u003e (local variables) relatively easy.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"non-mlir-non-ssa-cfg-to-mlir-ssa-cfg\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#non-mlir-non-ssa-cfg-to-mlir-ssa-cfg\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eNon-MLIR, NON-SSA CFG to MLIR-SSA CFG\u003c/h2\u003e\n\u003cblockquote\u003e\n\u003cp\u003eFrom this point forward, referring to non-ssa CFG means that it is non-mlir and vice versa (as MLIR requires SSA form in its CFG).\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eA special characteristic of DEX is that it utilizes (almost infinite) virtual registers without caring for stack space.\nThis allows for a seamless construction of the program's CFG from the DEX format.\u003c/p\u003e\n\u003cp\u003eAfter constructing the CFG's non-SSA form, we translate it to MLIR's SSA CFG via \u003ca href=\"https://c9x.me/compile/bib/braun13cc.pdf\"\u003eBraun's SSA algorithm\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eOn the high level overview, we keep an \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eDenseMap\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e between the original CFG's basic blocks to a \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eBasicBlockDef\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, this is meant to replace the paper's \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecurrentDef\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e[\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003evariable\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e][\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eBlock\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e.\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003estruct\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003e BasicBlockDef\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e {\u003c/span\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e // stripped down version of BasicBlockDef\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003e    mlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eDenseMap\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003estd\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003euint32_t\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003e mlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e Defs\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e    // ...\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    unsigned\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e Filled : \u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e};\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eIn the BasicBlockDef wraps another \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eDenseMap\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e of \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003euint32\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e to \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, this is how we're accessing the \u003ccode\u003evariable\u003c/code\u003e in \u003ccode\u003ecurrentDef[variable][Block]\u003c/code\u003e from the paper's algorithm.\u003c/p\u003e\n\u003cp\u003eWhen the original CFG's instructions ask to either read or write to DEX's virtual registers, we either get the value from our map between integers and \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e in the current block, or we recursively call the query on the block's predecessor(s).\u003c/p\u003e\n\u003cp\u003eThe query of a variable's definition in a block's map in the project is the equivalent of C++ MLIR's\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eDenseMap\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e[\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eBlock\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e][\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eDenseMap\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e[\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003estd\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003euint32_t\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e][\u003c/span\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e]]\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003ch2 id=\"optimization-and-analysis\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#optimization-and-analysis\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eOptimization and Analysis\u003c/h2\u003e\n\u003cp\u003eIn writing an optimization pass, MLIR offers a variety of tools for the job. Different machinery includes \u003ca href=\"https://mlir.llvm.org/docs/Tutorials/DataFlowAnalysis/\"\u003eDataFlowAnalysis\u003c/a\u003e, \u003ca href=\"https://mlir.llvm.org/docs/PatternRewriter/\"\u003ePattern Rewriters\u003c/a\u003e, \u003ca href=\"https://mlir.llvm.org/docs/PassManagement/\"\u003egeneric operation pass\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eIn writing up this part of the project, the biggest obstacles is surprisingly not about learning the apis of different optimization tools, but actually verifying MLIR's and ourselves' dialect.\u003c/p\u003e\n\u003cp\u003eFor time management, I'm opting for a simple pattern rewriter to remove all nops: the \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eapplyPatternsAndFoldGreedily\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e pass. Using the pass runs MLIR's verifier on its built-in dialect, triggering a lot of errors on our compiler build. Despite this, fixing this was somewhat straight forward with MLIR's error messages (?!) and documentation on its operations.\u003c/p\u003e\n\u003ch2 id=\"translation\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#translation\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eTranslation\u003c/h2\u003e\n\u003ch3 id=\"parameter-versus-local-registers\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#parameter-versus-local-registers\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eParameter versus local registers\u003c/h3\u003e\n\u003cp\u003eThe Smali IR differentiates between a parameter and a local variable with the prefix \u003ccode\u003ep\u003c/code\u003e or \u003ccode\u003ev.\u003c/code\u003e This in turn requires us to also somehow identify this in MLIR.\u003c/p\u003e\n\u003cp\u003eFortunately with MLIR's helpful methods such as \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003ellvm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003edyn_cast\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e\u0026#x3C;\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003ellvm\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eisa\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e\u0026#x3C;\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eBlockArgument\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003egetOwner\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e and \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eBlock\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eisEntryBlock\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, it was relatively straightforward to resolve this, which will be shown in the next section.\u003c/p\u003e\n\u003ch3 id=\"getting-out-of-ssa\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#getting-out-of-ssa\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eGetting out of SSA\u003c/h3\u003e\n\u003ch4 id=\"ssa-value-to-virtual-registers\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#ssa-value-to-virtual-registers\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eSSA value to virtual registers\u003c/h4\u003e\n\u003cp\u003eSince SSA variables are only assigned once, we can assign each SSA variable to its virtual register counter-part by keeping a counter, seeing a new SSA variable means incrementing the counter and assign that SSA variable that newly incremented counter value.\u003c/p\u003e\n\u003cp\u003eWe'll use C++ templating to do this with a class called \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eSmaliCounter\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, generic on type \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eAspect\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e.\u003c/p\u003e\n\u003cpre class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003etemplate\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003eclass\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003e Aspect\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#737994;font-style:italic\"\u003e // a template so we can reuse it\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003eclass\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003e SmaliCounter\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    size_t\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e counter \u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#EF9F76\"\u003e 0\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003e    mlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eDenseMap\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eAspect\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e,\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003e size_t\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e counter_map\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003epublic\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e:\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e    SmaliCounter\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#CA9EE6\"\u003esize_t\u003c/span\u003e\u003cspan style=\"color:#EA999C;font-style:italic\"\u003e start_from\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e :\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e counter\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003estart_from\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e {}\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e    size_t\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003e get_counter\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#E5C890;font-style:italic\"\u003eAspect\u003c/span\u003e\u003cspan style=\"color:#EA999C;font-style:italic\"\u003e a\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e {\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e        if\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e (\u003c/span\u003e\u003cspan style=\"color:#E78284\"\u003ethis\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecounter_map\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003efind\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e(\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ea\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e)\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e ==\u003c/span\u003e\u003cspan style=\"color:#E78284\"\u003e this\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecounter_map\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003eend\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e())\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E78284\"\u003e            this\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecounter_map\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e[\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ea\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e]\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e =\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003e counter\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e++\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003e        return\u003c/span\u003e\u003cspan style=\"color:#E78284\"\u003e this\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e-\u003e\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecounter_map\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e[\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ea\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e];\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e    }\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#949CBB\"\u003e};\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eWe have 3 counters to keep track of: the parameters, the local variables and the basic blocks themselves. Let's respectively call them \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eprc\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003evrc\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e and \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003ebc\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e. To determine a location to jump to, we input a \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eBlock\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e*\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e to \u003ccode\u003ebc\u003c/code\u003e and get out either a preexisting location or a new one, as indicated by \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eget_counter\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e.\u003c/p\u003e\n\u003cp\u003eThe situation is a bit trickier with \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eprc\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e (method parameters) and \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003evrc\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e (local variables) since they're both \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e. However, an interesting thing to note is that the method parameters are actually \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eBlockArgument\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, a subclass of \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e. This subclass exposes a method called \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003egetOwner\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e that returns a block*, and the block in turns exposes a method to check if its the entry block of a method or not.\u003c/p\u003e\n\u003cp\u003eThus, if an \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e is actually of \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eBlockArgument\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e and if it belongs to the entry block of a method, then it is a parameter, and will be inputted to \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003eprc\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e and vice versa. I add the second requirement since a block argument can also come from different blocks that are glued together by control flow instead.\u003c/p\u003e\n\u003ch4 id=\"dealing-with-phis-block-arguments-ssa-destruction\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#dealing-with-phis-block-arguments-ssa-destruction\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eDealing with phis (block arguments) (SSA destruction)\u003c/h4\u003e\n\u003cp\u003eIn translating from MjolnIR to smali, I opted for a simple out-of-ssa transformation \u003ca href=\"https://github.com/mwillsey/cs265/blob/2024-fall/lessons/03-ssa.md#converting-out-of-ssa\"\u003eintroduced in class\u003c/a\u003e, slightly tweaked to fit MLIR's ssa block arguments fashion:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eFor every control flow (cf.condbr and cf.br):\n - Copies the current arguments being passed into the true block,\nto the actual parameters, which looks like (move* vA, vB)\n\n - Inserts an instruction that jumps to the true block\nif the operand to the instruction is true, which looks like (if-* vX, :block_Y)\n\n - Copies the current arguments being passed into the false block,\nto the actual parameters, which looks like (move* vA, vB)\n\n - Inserts an instruction that jumps to the false block,\nwhich looks like (goto :block_Y)\n\nThe cf.br case simply reduces down to the last two step.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThe following drawing executes the algorithm on a handwritten example.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blogs/out_of_ssa.svg\" alt=\"out_of_ssa.svg\"\u003e\u003c/p\u003e\n\u003ch4 id=\"control-flow-combination\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#control-flow-combination\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eControl flow combination\u003c/h4\u003e\n\u003cp\u003eA quirky thing between MLIR and smali is how they differ in their branching.\u003c/p\u003e\n\u003cp\u003eIn MLIR, we first obtain a boolean value from something like \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003earith\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecmpi\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e. Then we use this value to feed it\ninto \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecf\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003econdbr\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e to either jump to a block or continue as normal.\u003c/p\u003e\n\u003cp\u003eIn contrast, smali employs different kind of \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003eif\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e-*\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e instructions as a way to combine the MLIR's two-step approach.\u003c/p\u003e\n\u003cp\u003eFor example, an \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003eif\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ene\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e is used to represent a \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003earith\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecmpi\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e instruction of two \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, and then depending on if they're equal or not, jump to a block.\u003c/p\u003e\n\u003cp\u003eI'll once again use the SSA property to resolve this issue.\u003c/p\u003e\n\u003cp\u003eUpon a branching based on a predicate (\u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003ecf\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e.\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003econdbr\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e), we can query the defining op of an \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E5C890\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e to obtain its boolean defining operation (defOp) (step 1 in mlir). Notice that when we first encounter that defOp, we still generate its smali equivalent (since we don't know if it might be used once or multiple times or will be passed in to some other blocks). Then, we proceed to pick the correct branching smali instruction. Since the nature of SSA is a value can only be defined once, a single value can not correspond to different defOps.\u003c/p\u003e\n\u003cp\u003eFor the case that \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#C6D0F5\"\u003emlir\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003eValue\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#8CAAEE;font-style:italic\"\u003egetDefiningOp\u003c/span\u003e\u003cspan style=\"color:#949CBB\"\u003e()\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e returning \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#E78284\"\u003enullptr\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e, this means that its a block argument. We just generate \u003cspan class=\"shiki catppuccin-frappe\" style=\"background-color:#303446;color:#c6d0f5\" tabindex=\"0\"\u003e\u003ccode\u003e\u003cspan class=\"line\"\u003e\u003cspan style=\"color:#CA9EE6\"\u003eif\u003c/span\u003e\u003cspan style=\"color:#81C8BE\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#C6D0F5\"\u003enez\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/span\u003e from smali.\u003c/p\u003e\n\u003cp\u003eFor this part (translating), I think what troubles me the most is the fact that, to the best of our knowledge, no project exists to translate from a custom IR to smali. Combined with limited knowledge of both smali and MLIR, the cycle continues itself since not knowing smali well requires me to perform multiple iteration on the custom IR, which suffers again from limited knowledge of MLIR.\u003c/p\u003e\n\u003ch2 id=\"so-whats-going-on-right-now-jaz-whats-next\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#so-whats-going-on-right-now-jaz-whats-next\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eSo what's going on right now Jaz? What's next?\u003c/h2\u003e\n\u003cp\u003eThe project's progressing at a steady rate right now, with me and Edu's contributing on the MLIR side.\u003c/p\u003e\n\u003cp\u003eContentedly, with different priorities both in my life (looking at you \"full time recruiting\") and in UC Berkeley (looking at you EE16B and EE126), a short timeline of 6 weeks renders the initial goals of the project somewhat incomplete. That is, although lifting and simple analysis of DEX via MLIR is achieved, some work are needed in translating MjolnIR to smali.\u003c/p\u003e\n\u003cp\u003eIn retrospect, I think I should have thought ahead and started the project 4 weeks earlier (1 month into class). More familiarity with SSA form, SSA construction earlier in the process would have expedited porting the lifter as well as writing up the out-of-ssa translation.\u003c/p\u003e\n\u003cp\u003eAfter the semester ends, I'll continue working on the MjolnIR-to-smali translation, besides supporting new DEX feature into MjolnIR and refactoring existing code. Then, some form of dataflow analysis on the new IR is expected.\u003c/p\u003e\n\u003cp\u003eWith this new-found knowledge of MLIR, the next steps would be trying to write \u003ca href=\"https://github.com/badumbatish/tyoMLIR\"\u003ean ML compiler\u003c/a\u003e by extending upon MLIR's \u003ca href=\"https://mlir.llvm.org/docs/Tutorials/Toy/\"\u003etoy tutorial\u003c/a\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eBut why contentedly?\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eI've been wanting to dive deeper into MLIR for a long time. When it was time to choose a project, in the back of my mind, I've had some doubts. But ughh, I want to learn, and I don't care if a project I chose ran into time constraints. It was important for me to learn about an industry's tools as well as put my mind to implement different algorithms I've learned in classes in the ecosystem.\u003c/p\u003e\n\u003cp\u003eI think \u003ca href=\"https://www.youtube.com/Vsauce\"\u003eVSauce\u003c/a\u003e's supertask's \u003ca href=\"https://youtu.be/ffUnNaQTfZE?si=7byTONQdK9pP3JnI\u0026#x26;t=1062\"\u003e17:42 to 20:07\u003c/a\u003e captures the best the mentality on the project.\u003c/p\u003e\n\u003cp\u003eI hope everyone's enjoyed the little 15-minute read, I'll see everyone soon with some new blog post :)\u003c/p\u003e\n\u003ch2 id=\"resources\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#resources\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eResources\u003c/h2\u003e\n\u003cp\u003eBelow lies the related resources I've visited during the timeline of the project.\u003c/p\u003e\n\u003ch3 id=\"figures\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#figures\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eFigures\u003c/h3\u003e\n\u003cp\u003eJasmine\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://badumbatish.github.io/\"\u003ehttps://badumbatish.github.io/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://bsky.app/profile/badumbatish.bsky.social\"\u003ebluesky\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.linkedin.com/in/jjasmine-t/\"\u003elinkedin\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eEdu\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://farena.in/\"\u003ehttps://farena.in/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://bsky.app/profile/farena.in\"\u003ebluesky\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://x.com/Farenain\"\u003etwitter\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eMax Willsey\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.mwillsey.com/\"\u003ehttps://www.mwillsey.com/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eJeremy Kun\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://www.jeremykun.com/\"\u003ehttps://www.jeremykun.com/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"tutorials-and-docs\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#tutorials-and-docs\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eTutorials and Docs\u003c/h3\u003e\n\u003cp\u003eA good tutorial read is MLIR's official \u003ca href=\"https://mlir.llvm.org/docs/Tutorials/Toy/\"\u003etoy tutorial\u003c/a\u003e. It helps me familiarize myself with the commandline, different elements in MLIR and different ways to do things, as well as their trade-offs.\u003c/p\u003e\n\u003cp\u003eJeremy's \u003ca href=\"https://github.com/j2kun/mlir-tutorial\"\u003eMLIR tutorials\u003c/a\u003e brings a fresh change into LLVM's terse style of tutorial, I frequent the sites a lot and recommends if you're trying to learn more about mlir.\u003c/p\u003e\n\u003cp\u003eMLIR's \u003ca href=\"https://mlir.llvm.org/doxygen/index.html\"\u003edoxygen\u003c/a\u003e page is much needed for resolving dependency issues as well as correct usage of MLIR's elements. I recommend familiarizing yourself with different operations' and values' method signatures.\u003c/p\u003e\n\u003cp\u003eMLIR's \u003ca href=\"https://mlir.llvm.org/docs/LangRef/\"\u003eLangRef\u003c/a\u003e provides a good worldview about its ecosystem for a beginner.\u003c/p\u003e\n\u003cp\u003eChatGPT and Claude are also (not really, but kinda) helpful tools in super boosting your learning about MLIR and LLVM's api.\u003c/p\u003e\n\u003ch3 id=\"algorithms\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" href=\"#algorithms\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eAlgorithms\u003c/h3\u003e\n\u003cp\u003eMax Willsey's \u003ca href=\"https://github.com/mwillsey/cs265/blob/2024-fall/lessons/03-ssa.md\"\u003elesson\u003c/a\u003e about SSA form is much needed for the project. I also recommended another introductory perspective into the matter with Engineering a Compiler's chapter 9.3.\u003c/p\u003e\n\u003cp\u003eA read for \u003ca href=\"https://c9x.me/compile/bib/braun13cc.pdf\"\u003eBraun's algorithm\u003c/a\u003e is also required. Edu also posted about it for MLIR \u003ca href=\"https://farena.in/compilers/mlir/ssa-mlir-algorithm/\"\u003ehere\u003c/a\u003e, which forms the foundation for his implementation in \u003ca href=\"https://github.com/Fare9/KUNAI-static-analyzer\"\u003eKUNAI\u003c/a\u003e.\u003c/p\u003e"])</script><script>self.__next_f.push([1,"6:[\"$\",\"article\",null,{\"className\":\"p-8 prose  max-w-none w-full lg:w-1/2 md:w-4/6 sm:w-5/6 prose-sky mx-auto\",\"children\":[[\"$\",\"div\",null,{\"className\":\"flex justify-center text-2xl font-bold \",\"children\":[\"$\",\"h2\",null,{\"children\":\"[REPORT] Going to the gym with MLIR: Writing a recompiler for DEX instructions\"}]}],[\"$\",\"div\",null,{\"className\":\"flex justify-start text-xl font-bold underline\",\"children\":[\"$\",\"h4\",null,{\"children\":\"2024-12-07\"}]}],[\"$\",\"div\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"$e\"}}]]}]\na:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"[REPORT] Going to the gym with MLIR: Writing a recompiler for DEX instructions\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Built with NextJS, TailwindCSS, and a tonnn of loveee :)\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/_next/static/media/pfp3.5cd65164.png\"}]]\n8:null\n"])</script></body></html>