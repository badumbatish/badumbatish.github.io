1:"$Sreact.fragment"
2:I[8173,["173","static/chunks/173-09f9817a8afa96b6.js","880","static/chunks/app/posts/%5Bid%5D/page-0a046863f2056281.js"],""]
3:I[5244,[],""]
4:I[3866,[],""]
5:I[1168,["173","static/chunks/173-09f9817a8afa96b6.js","970","static/chunks/970-1bb5a11d460674d4.js","177","static/chunks/app/layout-8efea218579f6a1a.js"],"default"]
7:I[6213,[],"OutletBoundary"]
9:I[6213,[],"MetadataBoundary"]
b:I[6213,[],"ViewportBoundary"]
d:I[4835,[],""]
:HL["/_next/static/media/7385e8d9d3c5518f-s.p.ttf","font",{"crossOrigin":"","type":"font/ttf"}]
:HL["/_next/static/css/916422c3eb75abfa.css","style"]
:HL["/_next/static/css/7ad14cf05ba66ef7.css","style"]
0:{"P":null,"b":"LZhVjZAXVo_j8vLAK6nQ0","p":"","c":["","posts","what_after_kalei_location_debug"],"i":false,"f":[[["",{"children":["posts",{"children":[["id","what_after_kalei_location_debug","d"],{"children":["__PAGE__",{}]}]}]},"$undefined","$undefined",true],["",["$","$1","c",{"children":[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/916422c3eb75abfa.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","html",null,{"lang":"en","className":"px-4 py-4","children":["$","body",null,{"className":"__className_d4e0c8 flex flex-col min-h-screen","children":[["$","$L2",null,{"href":"/","children":["$","div",null,{"className":"flex justify-center items-center py-4 ","children":["$","h1",null,{"className":"text-4xl font-bold","children":"Jasmine Tang"}]}]}],["$","div",null,{"className":"flex-1","children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":[[],[["$","title",null,{"children":"404: This page could not be found."}],["$","div",null,{"style":{"fontFamily":"system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"","height":"100vh","textAlign":"center","display":"flex","flexDirection":"column","alignItems":"center","justifyContent":"center"},"children":["$","div",null,{"children":[["$","style",null,{"dangerouslySetInnerHTML":{"__html":"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}"}}],["$","h1",null,{"className":"next-error-h1","style":{"display":"inline-block","margin":"0 20px 0 0","padding":"0 23px 0 0","fontSize":24,"fontWeight":500,"verticalAlign":"top","lineHeight":"49px"},"children":404}],["$","div",null,{"style":{"display":"inline-block"},"children":["$","h2",null,{"style":{"fontSize":14,"fontWeight":400,"lineHeight":"49px","margin":0},"children":"This page could not be found."}]}]]}]}]]],"forbidden":"$undefined","unauthorized":"$undefined"}]}],["$","$L5",null,{}],["$","footer",null,{"className":"footer self-center justify-center gap-2 pt-4 items-center italic ","children":["$","p",null,{"children":"Built by Jasmine with NextJS, TailwindCSS, and a tonnn of loveee :)"}]}]]}]}]]}],{"children":["posts",["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":[["id","what_after_kalei_location_debug","d"],["$","$1","c",{"children":[null,["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","posts","children","$0:f:0:1:2:children:2:children:0","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L4",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","forbidden":"$undefined","unauthorized":"$undefined"}]]}],{"children":["__PAGE__",["$","$1","c",{"children":["$L6",[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/7ad14cf05ba66ef7.css","precedence":"next","crossOrigin":"$undefined","nonce":"$undefined"}]],["$","$L7",null,{"children":"$L8"}]]}],{},null,false]},null,false]},null,false]},null,false],["$","$1","h",{"children":[null,["$","$1","9uT5aJuFruybkpYdlkxCy",{"children":[["$","$L9",null,{"children":"$La"}],["$","$Lb",null,{"children":"$Lc"}],["$","meta",null,{"name":"next-size-adjust","content":""}]]}]]}],false]],"m":"$undefined","G":["$d","$undefined"],"s":false,"S":true}
c:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}]]
e:Tf2cc,<nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#prologue">Prologue</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#introduction">Introduction</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#location-reporter-locator-and-reporter">Location, Reporter, Locator and Reporter</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#the-location-class">The Location class</a></li><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#the-reportee-class">The Reportee class</a></li><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#the-reporter-class">The Reporter class</a></li><li class="toc-item toc-item-h4"><a class="toc-link toc-link-h4" href="#the-locator-class">The Locator class</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#tokens-and-the-lexer">Tokens (and the lexer)</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#ast-nodes-and-the-parser">AST nodes (and the parser)</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#study-case-scope-checking-visitor">Study case: scope checking visitor</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#class-lexical-scope">class Lexical Scope</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#visiting">Visiting</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#result">Result</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#whats-next">What's next?</a></li></ol></nav><h2 id="prologue"><a aria-hidden="true" tabindex="-1" href="#prologue"><span class="icon icon-link"></span></a>Prologue</h2>
<p>Hi everyone, wow, it's been a quick minute since I posted a new article. How's everyone doing :) I'm still trucking
away at life applying to compiler jobs as well as schooling at Berk. Hope everybody's doing great :)</p>
<p>This
article is for
people
who might be
asking:</p>
<p>"Ok, I've done the <a href="https://llvm.org/docs/tutorial/MyFirstLanguageFrontend/index.html" rel="nofollow" target="_blank">llvm tutorial</a> already.
What's next?"</p>
<p>More specifically, the article is about adding primitive support for error reporting to the
toy compiler. The article assumes some familiarity with lexer, parsing and the visitor pattern. Some familiarity with
the parser and its abstract syntax tree (<a href="https://dev.to/balapriya/abstract-syntax-tree-ast-explained-in-plain-english-1h38" rel="nofollow" target="_blank">AST</a>) construction from the <a href="https://llvm.org/docs/tutorial/MyFirstLanguageFrontend/index.html" rel="nofollow" target="_blank">llvm tutorial</a>
is helpful
but not necessary.</p>
<p>Besides that, the article is also to share my software design decisions regarding my compiler's diagnostics and to
improve my technical writing ability.</p>
<p>As is tradition :) I also wanna share some songs with you. The two songs are <a href="https://www.youtube.com/watch?v=r-zubTTp8Tg&#x26;ab_channel=COIN" rel="nofollow" target="_blank">Valentine</a> and <a href="https://www.youtube.com/watch?v=XvG12DVUCNg&#x26;ab_channel=COIN" rel="nofollow" target="_blank">Into my arms</a>,
both by COIN, one of my fav bands :) To me, Valentine is this flirty and fun—like a rush of butterflies, you know?
It’s got that energetic, dreamy beat that feels like falling in love for the first time. But Into My Arms' this
pure intimacy, deep, and emotional calling. It's as if the singer knows what they really wants and they're just
pulling at the heartstrings and begging
you to just melt
into
someone’s
embrace.</p>
<p>Sigh, at this point you might be thinking I must be writing blogs just to share and review music, huh? :) Smh</p>
<p>I hope you enjoy :) (both the songs and the blog hahah)</p>
<h2 id="introduction"><a aria-hidden="true" tabindex="-1" href="#introduction"><span class="icon icon-link"></span></a>Introduction</h2>
<p>Compiler diagnostics is an important aspect in one's compiler. From erroring out on the programmer's mistake to
providing warnings or giving diagnostics, the ability to accurately locate the location of the pesky problems to said
programmer is proven to be extremely valuable: only providing to the programmer the row and column number of where an error occurs is less helpful and more confusing than a compiler pointing, tracing and explaining an error to a programmer.</p>
<p>The article then discusses a way to improve upon the llvm Kaleidoscope toy compiler in the diagnostic aspect for the
user. The picture below shows the difference between a primitive and a somewhat sophisticated
error
diagnostics scheme and is implemented as
part of
the sammine
compiler.</p>
<p><img src="/blogs/what_after_kalei_location_debug/comparison.png" alt="comparison between"></p>
<h2 id="location-reporter-locator-and-reporter"><a aria-hidden="true" tabindex="-1" href="#location-reporter-locator-and-reporter"><span class="icon icon-link"></span></a>Location, Reporter, Locator and Reporter</h2>
<p>Let's start with a simple description of the problem and a simple answer to the said problem.</p>
<blockquote>
<p>Given a string (which is the input of the compiler), and a starting point index and an ending point index of said
string, indicate the component (either a token or a subpart of some AST) that is faulty.</p>
</blockquote>
<p>Below shows a string of a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">variable definition </span></span></code></span> and its corresponding starting and ending point in
the input
string:</p>
<pre><code>start of decl
|       end of decl
|       |
↓       ↓
01234556789
let x = 1;\eof
</code></pre>
<p>Here, the starting point for the let expr has index 0 in
the string, and the ending point for the let expr has index 7 in the string (the semicolon at 8 is not counted).</p>
<p>From first principles, how can a compiler consolidate the location of these tokens: <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">let</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">x</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#81C8BE">=</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#EF9F76">1</span></span></code></span>
together and understand that the declaration spans from 0 to 7?</p>
<p>Let us define the class <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Location</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reportee</span></span></code></span>
and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reporter</span></span></code></span> currently implemented as part of the compiler and see how all of these building blocks fit in together.</p>
<h4 id="the-location-class"><a aria-hidden="true" tabindex="-1" href="#the-location-class"><span class="icon icon-link"></span></a>The Location class</h4>
<p>The <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Location</span></span></code></span> class is basically two indices, indicating the location of a construct in the
input string. The first index
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_start</span></span></code></span>
signifies the
starting location of a component and vice versa for <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_end</span></span></code></span>. If a construct in the compiler (a token or an AST)
only occupies a single space, then <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_start</span></span></code></span> == <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_end</span></span></code></span>.</p>
<p>When two <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Location</span></span></code></span>s come together to form one singular <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Location</span></span></code></span>, we take the minimum of all
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_start</span></span></code></span> and the maximum of all the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_end</span></span></code></span>. This is implemented as the pipe operator <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#81C8BE">|</span></span></code></span> for the class:</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#737994;font-style:italic">// Combine two locations</span></span>
<span class="line"><span style="color:#E5C890;font-style:italic">Location</span><span style="color:#CA9EE6"> operator</span><span style="color:#C6D0F5">|</span><span style="color:#949CBB">(</span><span style="color:#CA9EE6">const</span><span style="color:#E5C890;font-style:italic"> Location</span><span style="color:#81C8BE"> &#x26;</span><span style="color:#EA999C;font-style:italic">other</span><span style="color:#949CBB">)</span><span style="color:#CA9EE6"> const</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#C6D0F5">    Location result</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#C6D0F5">    result</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">source_start </span><span style="color:#81C8BE">=</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">min</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">source_start</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> other</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">source_start</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#C6D0F5">    result</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">source_end </span><span style="color:#81C8BE">=</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">max</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">source_end</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> other</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">source_end</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">    return</span><span style="color:#C6D0F5"> result</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">void</span><span style="color:#CA9EE6"> operator</span><span style="color:#C6D0F5">|=</span><span style="color:#949CBB">(</span><span style="color:#CA9EE6">const</span><span style="color:#E5C890;font-style:italic"> Location</span><span style="color:#81C8BE"> &#x26;</span><span style="color:#EA999C;font-style:italic">other</span><span style="color:#949CBB">)</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#C6D0F5">    source_start </span><span style="color:#81C8BE">=</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">min</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">source_start</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> other</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">source_start</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#C6D0F5">    source_end </span><span style="color:#81C8BE">=</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">max</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">source_end</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> other</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">source_end</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>Let's look at an example, given the string of a binary expression <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">x</span><span style="color:#81C8BE">+</span><span style="color:#C6D0F5">y</span></span></code></span>, since <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">x</span></span></code></span> takes the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">Location</span><span style="color:#949CBB">(</span><span style="color:#EF9F76">0</span><span style="color:#949CBB">,</span><span style="color:#EF9F76">0</span><span style="color:#949CBB">)</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">y</span></span></code></span>
takes the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">Location</span><span style="color:#949CBB">(</span><span style="color:#EF9F76">2</span><span style="color:#949CBB">,</span><span style="color:#EF9F76">2</span><span style="color:#949CBB">)</span></span></code></span>. The location for the resulting binary expression is <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">Location</span><span style="color:#949CBB">(</span><span style="color:#8CAAEE;font-style:italic">min</span><span style="color:#949CBB">(</span><span style="color:#EF9F76">0</span><span style="color:#949CBB">,</span><span style="color:#EF9F76">2</span><span style="color:#949CBB">),</span><span style="color:#8CAAEE;font-style:italic"> max</span><span style="color:#949CBB">(</span><span style="color:#EF9F76">0</span><span style="color:#949CBB">,</span><span style="color:#EF9F76">2</span><span style="color:#949CBB">))</span><span style="color:#81C8BE"> =</span><span style="color:#8CAAEE;font-style:italic"> Location</span><span style="color:#949CBB">(</span><span style="color:#EF9F76">0</span><span style="color:#949CBB">,</span><span style="color:#EF9F76"> 2</span><span style="color:#949CBB">)</span></span></code></span>.</p>
<p>Another thing to notice is that the Location class offers modifiers on <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_end</span></span></code></span>, this is mostly useful in the
case of lexing different token such as <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#81C8BE">+</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#81C8BE">+=</span></span></code></span> - often in sammine I have to backtrack and thus this is really
helpful.</p>
<h4 id="the-reportee-class"><a aria-hidden="true" tabindex="-1" href="#the-reportee-class"><span class="icon icon-link"></span></a>The Reportee class</h4>
<p>Given a location, we need a message to be associated with it, together with the diagnostic kind: Is this message an
error? Is it a warning? Is this just to provide the programmer/compiler writer with some extra information for an
informed decision?</p>
<p>The class that takes care of this is the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reportee</span></span></code></span> class. It defines different <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">ReportKind</span></span></code></span> such as <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">error</span></span></code></span>,
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">warn</span></span></code></span> or <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">diag</span></span></code></span> for error, warning or diagnostics respectively. It also provides abstraction such as <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">add_error</span><span style="color:#949CBB">()</span></span></code></span>,
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">add_warn</span><span style="color:#949CBB">()</span></span></code></span> or <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">add_diag</span></span></code></span> for said <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">ReportKind</span></span></code></span>s. The input to these <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">add_</span><span style="color:#81C8BE">*</span><span style="color:#949CBB">()</span></span></code></span> call is a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Report</span></span></code></span> type, which is
just a tuple of <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">ReportKind</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> Location</span><span style="color:#949CBB">,</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">string</span></span></code></span>.</p>
<p>Who's calling <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">add_error</span><span style="color:#949CBB">()</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">add_warn</span><span style="color:#949CBB">()</span></span></code></span>? Whichever phase the compiler needs to communicate with the
programmer
about, that phase will inherit from this <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reportee</span></span></code></span> class and use these utilities functions. The sections on Lexer and
Parser will go over these finer details.</p>
<p>Besides this, the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reportee</span></span></code></span> class also carries <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">size_t</span></span></code></span> of <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">error_count</span></span></code></span>, <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">warn_count</span></span></code></span> and
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">diag_count</span></span></code></span> to be used as statistics for the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reporter</span></span></code></span> class, which is the topic of our next subsection.</p>
<h4 id="the-reporter-class"><a aria-hidden="true" tabindex="-1" href="#the-reporter-class"><span class="icon icon-link"></span></a>The Reporter class</h4>
<p>The compiler
needs to 'report' messages coming from different stages (Reportee) such as lexing, parsing or type checking, of
which the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reporter</span></span></code></span> class is in charge.</p>
<p>Upon construction, it takes in a file name, the source code string, and the context radius. For example, if the context
radius is 2, then if we're reporting on 1 line of code at line 3, we would print out from line 1 to line 5 (via the
Locator class).</p>
<p>Then it splits this source code string into different strings seperated by newlines, and constructs a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">vector</span></span></code></span>
of pairs of the running sum lengths of all the strings up to the current string and the current
string. This is implemented as <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890">Reporter</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">get_diagnostic_data</span></span></code></span> and the result is stored as an intermediary
ingredient for the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Locator</span></span></code></span> class:</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">using</span><span style="color:#E5C890;font-style:italic"> DiagnosticData</span><span style="color:#81C8BE"> =</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#E5C890;font-style:italic">vector</span><span style="color:#949CBB">&#x3C;</span><span style="color:#E5C890">std</span><span style="color:#949CBB">::</span><span style="color:#E5C890;font-style:italic">pair</span><span style="color:#949CBB">&#x3C;</span><span style="color:#E5C890">std</span><span style="color:#949CBB">::</span><span style="color:#CA9EE6">size_t</span><span style="color:#949CBB">,</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#E5C890;font-style:italic">string_view</span><span style="color:#949CBB">>>;</span></span>
<span class="line"><span style="color:#E5C890;font-style:italic">DiagnosticData</span><span style="color:#E5C890"> Reporter</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">get_diagnostic_data</span><span style="color:#949CBB">(</span><span style="color:#E5C890">std</span><span style="color:#949CBB">::</span><span style="color:#E5C890;font-style:italic">string_view</span><span style="color:#EA999C;font-style:italic"> str</span><span style="color:#949CBB">)</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#C6D0F5">  DiagnosticData result</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#CA9EE6">  size_t</span><span style="color:#C6D0F5"> start </span><span style="color:#81C8BE">=</span><span style="color:#EF9F76"> 0</span><span style="color:#949CBB">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#CA9EE6">  while</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">start </span><span style="color:#81C8BE">&#x3C;</span><span style="color:#C6D0F5"> str</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">size</span><span style="color:#949CBB">())</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#CA9EE6">    size_t</span><span style="color:#C6D0F5"> end </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> str</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">find</span><span style="color:#949CBB">(</span><span style="color:#A6D189">'</span><span style="color:#F4B8E4">\n</span><span style="color:#A6D189">'</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> start</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">    if</span><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">end </span><span style="color:#81C8BE">==</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#E5C890">string_view</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">npos</span><span style="color:#949CBB">)</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#737994;font-style:italic">      // Add the last substring if no more newlines are found</span></span>
<span class="line"><span style="color:#C6D0F5">      result</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">push_back</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">{start</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> str</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">substr</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">start</span><span style="color:#949CBB">)</span><span style="color:#C6D0F5">}</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#CA9EE6">      break</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">    }</span></span>
<span class="line"><span style="color:#737994;font-style:italic">    // Add the substring excluding the newline character</span></span>
<span class="line"><span style="color:#C6D0F5">    result</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">push_back</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">{start</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> str</span><span style="color:#949CBB">.</span><span style="color:#8CAAEE;font-style:italic">substr</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">start</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> end </span><span style="color:#81C8BE">-</span><span style="color:#C6D0F5"> start</span><span style="color:#949CBB">)</span><span style="color:#C6D0F5">}</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#C6D0F5">    start </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> end </span><span style="color:#81C8BE">+</span><span style="color:#EF9F76"> 1</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">  }</span></span>
<span class="line"><span style="color:#CA9EE6">  return</span><span style="color:#C6D0F5"> result</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>Then, the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reporter</span></span></code></span> class takes in a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Report</span></span></code></span>, a tuple of <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">ReportKind</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> Location</span><span style="color:#949CBB">,</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">string</span></span></code></span> and
print the message via stderr to the programmer; it also knows that for a specific
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">ReportKind</span></span></code></span>, which color should be printed.</p>
<h4 id="the-locator-class"><a aria-hidden="true" tabindex="-1" href="#the-locator-class"><span class="icon icon-link"></span></a>The Locator class</h4>
<p>You must be wondering, just the linear <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#949CBB">(</span><span style="color:#C6D0F5">source_start</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> source_end</span><span style="color:#949CBB">)</span></span></code></span> indices is not enough, this result is just
the
bare
minimum.
Somehow the compiler needs to be able to map a location of <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#949CBB"> (</span><span style="color:#C6D0F5">source_start</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> source_end</span><span style="color:#949CBB">)</span></span></code></span> to the starting and ending rows and columns for easier visualization.
What if we also want some lines of code before and
after the concerning line of code for more context, how would we do that?
Maybe if the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Location</span></span></code></span> needed to be
reported is one,
or two,
or
three lines only, and it'd be very helpful to hone in and point out the mistake for the programmer.</p>
<p>To do this, the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Locator</span></span></code></span>, with the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_start</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_end</span></span></code></span>, consecutively performs binary search on the
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">DiagnosticData</span></span></code></span>
given by the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reporter</span></span></code></span>,
and
returns the row and column needed for reporting.</p>
<p>This is why we're making <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">DiagnosticData</span></span></code></span> to be a vector of
pairs where the first element is monotonically increasing: we can binary search on the first element of the pair to
get out the index of the vector (which tells us what row it is), as well as the second element of said index (which
allows us to print out the involving row). The reduction from <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> to <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>l</mi><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(ln(n))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">))</span></span></span></span> is a much-needed break once the
compiler input exceeds 10,000 rows or more with multiple files.</p>
<p>It then subtracts and adds, respectively on these rows obtained from
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_start</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">source_end</span></span></code></span>, the provided <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">context_radius</span></span></code></span> to get the final rows and columns
result,
usable by the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Reporter</span></span></code></span> class.</p>
<h2 id="tokens-and-the-lexer"><a aria-hidden="true" tabindex="-1" href="#tokens-and-the-lexer"><span class="icon icon-link"></span></a>Tokens (and the lexer)</h2>
<p>Wewwww....
Let's talk about the tokens and the lexer. When given the source code as a string (maybe via a file), the lexer
scans from left to right on that string, each time incrementing the index on the string and returning a token.
Thus, this is the basis of our class Location.</p>
<p>In sammine, tokens are (loosely) modeled as:</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">class</span><span style="color:#E5C890;font-style:italic"> Token</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#CA9EE6">public</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#C6D0F5">    TokenType type</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#E5C890">    std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">string lexeme</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#C6D0F5">    Location location</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#8CAAEE;font-style:italic">    Token</span><span style="color:#949CBB">(</span><span style="color:#E5C890;font-style:italic">TokenType</span><span style="color:#EA999C;font-style:italic"> type</span><span style="color:#949CBB">,</span><span style="color:#E5C890"> std</span><span style="color:#949CBB">::</span><span style="color:#E5C890;font-style:italic">string</span><span style="color:#EA999C;font-style:italic"> lexeme</span><span style="color:#949CBB">,</span><span style="color:#E5C890;font-style:italic"> Location</span><span style="color:#EA999C;font-style:italic"> location</span><span style="color:#949CBB">)</span></span>
<span class="line"><span style="color:#949CBB">      :</span><span style="color:#8CAAEE;font-style:italic"> type</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">type</span><span style="color:#949CBB">),</span><span style="color:#8CAAEE;font-style:italic"> lexeme</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">std</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">move</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">lexeme</span><span style="color:#949CBB">)),</span><span style="color:#8CAAEE;font-style:italic"> location</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">location</span><span style="color:#949CBB">)</span><span style="color:#949CBB"> {}</span></span>
<span class="line"><span style="color:#949CBB">};</span></span></code></pre>
<p>and for the lexer:</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">class</span><span style="color:#E5C890;font-style:italic"> Lexer</span><span style="color:#949CBB"> :</span><span style="color:#CA9EE6"> public</span><span style="color:#E5C890"> sammine_util</span><span style="color:#949CBB">::</span><span style="color:#E5C890;font-style:italic">Reportee</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#CA9EE6">private</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#E5C890">    sammine_util</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Location location</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#E5C890">    std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">vector</span><span style="color:#81C8BE">&#x3C;</span><span style="color:#C6D0F5">Token</span><span style="color:#81C8BE">></span><span style="color:#C6D0F5"> tokStream</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#C6D0F5">    ...</span></span></code></pre>
<p>One thing to note is after we've recognized a token together with its <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Location</span></span></code></span>, we update the Location of the
Lexer via <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">update_location</span><span style="color:#949CBB">()</span></span></code></span>.</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">void</span><span style="color:#E5C890"> Lexer</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">updateLocation</span><span style="color:#949CBB">()</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#C6D0F5">    location </span><span style="color:#81C8BE">=</span><span style="color:#E5C890"> sammine_util</span><span style="color:#949CBB">::</span><span style="color:#8CAAEE;font-style:italic">Location</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">location</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">source_end</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> location</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">source_end</span><span style="color:#949CBB">);</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>The reasoning for this is that if we don't do this, then in the following example, the
token <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#81C8BE">+=</span></span></code></span> as well as the token <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">b</span></span></code></span> will have inaccurate locations, spanning from the start of the input to the
current index.</p>
<pre><code>Location a: (0, 0)
| Location +=: (0, 3)
| |  Location b: (0, 5)
↓ ↓  ↓
012345
a += b
</code></pre>
<h2 id="ast-nodes-and-the-parser"><a aria-hidden="true" tabindex="-1" href="#ast-nodes-and-the-parser"><span class="icon icon-link"></span></a>AST nodes (and the parser)</h2>
<p>After we've produced our tokens, the parser takes in the stream of tokens and produces our ASTs. An AST is created
after identification for a specific ordering of some tokens.</p>
<p>For this newly created AST, the simple thing to do is to combine all the AST's token's location into one. Below shows
pseudocode for that</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">AST_construct</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">Token tok1</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> Token tok2</span><span style="color:#949CBB">,</span><span style="color:#C6D0F5"> ...</span><span style="color:#949CBB">)</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#C6D0F5">    ...</span></span>
<span class="line"><span style="color:#C6D0F5">    AST</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">Location </span><span style="color:#81C8BE">=</span><span style="color:#C6D0F5"> first token location of AST</span></span>
<span class="line"><span style="color:#C6D0F5">    For all tokens T that made up the AST</span><span style="color:#949CBB">:</span></span>
<span class="line"><span style="color:#C6D0F5">        AST</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">Location </span><span style="color:#81C8BE">|=</span><span style="color:#C6D0F5"> T</span><span style="color:#949CBB">.</span><span style="color:#C6D0F5">location</span></span>
<span class="line"><span style="color:#C6D0F5">    ...</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>In AST construction, we follow quite literally what the parser is parsing, for the following example: there is an
AST of function with an AST
of expr being nested in it (as a list of expressions).</p>
<pre><code>fn f(x : f64) {
    let y = 0;
}
</code></pre>
<p>The code block then translates to this pseudocode c++ structure:</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#CA9EE6">class</span><span style="color:#E5C890;font-style:italic"> AST_Func</span><span style="color:#949CBB"> {</span><span style="color:#737994;font-style:italic"> // this stands for fn f</span></span>
<span class="line"><span style="color:#C6D0F5">    AST_Prototype prototype </span><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#E5C890">        std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">string func_name</span><span style="color:#737994;font-style:italic"> // stands for the name `f`</span></span>
<span class="line"><span style="color:#E5C890">        std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">vector</span><span style="color:#81C8BE">&#x3C;</span><span style="color:#C6D0F5">AST_TypedVar</span><span style="color:#81C8BE">></span><span style="color:#C6D0F5"> function_arguments</span><span style="color:#737994;font-style:italic"> // this stands for `x : 64`</span></span>
<span class="line"><span style="color:#949CBB">    }</span></span>
<span class="line"><span style="color:#C6D0F5">    AST_Block function_block </span><span style="color:#949CBB">{</span></span>
<span class="line"><span style="color:#E5C890">        std</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">vector</span><span style="color:#81C8BE">&#x3C;</span><span style="color:#E5C890">AST</span><span style="color:#949CBB">::</span><span style="color:#C6D0F5">Expr</span><span style="color:#81C8BE">></span><span style="color:#C6D0F5"> statements</span><span style="color:#737994;font-style:italic"> // this stands for a singular `let y = 0;`</span></span>
<span class="line"><span style="color:#949CBB">    }</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<h2 id="study-case-scope-checking-visitor"><a aria-hidden="true" tabindex="-1" href="#study-case-scope-checking-visitor"><span class="icon icon-link"></span></a>Study case: scope checking visitor</h2>
<p>Knowing how a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Location</span></span></code></span> plays out in a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">lexer</span></span></code></span>'s token and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">parser</span></span></code></span>'s AST is helpful, but so what? Operations on the
AST such as scope checking or type checking also needs reporting on where a programmer went wrong, the responsibility
is
not just within the lexer
and the parser.</p>
<p>In this case, let's see how we
can use
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Location</span></span></code></span> to inform our programmers of some scope problem.</p>
<p>In <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">sammine</span></span></code></span>, given a function, the compiler should error out if an unknown variable is referenced or if
a variable is defined twice (the language prevents shadowing variable).</p>
<p>Given the following code:</p>
<pre class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#E5C890;font-style:italic">fn</span><span style="color:#8CAAEE;font-style:italic"> f</span><span style="color:#949CBB">(</span><span style="color:#E5C890;font-style:italic">x</span><span style="color:#C6D0F5"> : </span><span style="color:#E5C890;font-style:italic">f64</span><span style="color:#949CBB">)</span><span style="color:#949CBB"> {</span></span>
<span class="line"><span style="color:#C6D0F5">    let x </span><span style="color:#81C8BE">=</span><span style="color:#EF9F76"> 0</span><span style="color:#949CBB">;</span></span>
<span class="line"><span style="color:#C6D0F5">    ...</span></span>
<span class="line"><span style="color:#949CBB">}</span></span></code></pre>
<p>the compiler should error out since we don't allow shadowing of a variable:</p>
<p>To do this, we set up an AST visitor first, where each kind of visitor visits an outlying AST <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">out</span></span></code></span> first, perform
something (walk) on that AST (<a href="https://en.wikipedia.org/wiki/Tree_traversal#Pre-order_implementation" rel="nofollow" target="_blank">preorder</a>), then
visit its children AST, and then comes back and perform another action (walk) on the
AST <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">out</span></span></code></span> (<a href="https://en.wikipedia.org/wiki/Tree_traversal#Post-order_implementation" rel="nofollow" target="_blank">postorder</a>).</p>
<p>For paraphrasing purposes, on how to <a href="https://en.wikipedia.org/wiki/Visitor_pattern#Java_example" rel="nofollow" target="_blank">set up
the AST visitor pattern</a>, we
separate the step between visiting an AST and performing the pre- and post-ordering operation on said AST.</p>
<p>The action of perform the pre- and post-ordering operation on an AST is called walking and is implemented as
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">pre_order_walk</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">post_order_walk</span></span></code></span>.</p>
<p>Without specified otherwise, readers (and programmers) can assume that this is the execution ordering for a visitor:</p>
<pre><code>Visit(AST):
    pre_order_walk(ast)
    ~ recursively visit each element (sub AST) in the AST ~
    post_order_walk(ast)
</code></pre>
<p>Following the assumption that a visit to AST will ultimately and recursively visit each element of the AST as well,
the following sections on scope checking
will only discuss the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">pre_order_walk</span><span style="color:#949CBB">()</span></span></code></span> and the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">post_order_walk</span><span style="color:#949CBB">()</span></span></code></span></p>
<h3 id="class-lexical-scope"><a aria-hidden="true" tabindex="-1" href="#class-lexical-scope"><span class="icon icon-link"></span></a>class Lexical Scope</h3>
<p>The Lexical Scope class stores information about variable declarations and can be used to query whether a certain
variable (represented by a string) existed in a scope or not.</p>
<p>For example, in a function <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">f</span></span></code></span>, if we haven't defined a variable <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">x</span></span></code></span> but we're using it, it is considered
illegal in
<span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">sammine</span></span></code></span> .</p>
<p>To do this, the scope class consists of a mapping <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">symbol_to_loc</span></span></code></span> between symbols to locations as well as a
reference to
the parent
scope (just in case we want to implement some kind of lambda).</p>
<p>The reason to have a mapping between symbols and locations is when we have a clash of symbol, we can error out and
report on the location that is registered for the clashed symbol.</p>
<h3 id="visiting"><a aria-hidden="true" tabindex="-1" href="#visiting"><span class="icon icon-link"></span></a>Visiting</h3>
<p>The scope visitor will, of course, visit different ASTs at play. However, what we're concerned with is how these
orders affect what we want to do, in this case, scope checking. What we want to do next is to declare a few rules
for the scope visitor to register a scope and check for variable shadowing in a scope. Since we have seperated the
pattern into the visit step and the walk step.</p>
<ul>
<li><span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">pre_order_walk</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">FunctionAST</span><span style="color:#949CBB">)</span></span></code></span>: We push a newly created scope on the
scope stack.</li>
<li><span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">post_order_walk</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">FunctionAST</span><span style="color:#949CBB">)</span></span></code></span>: We pop that stack out of the scope stack</li>
</ul>
<p>Let's talk about VarDefAST's walk first, after which the walk of PrototypeAST will make more sense. A VarDefAST
basically just contains a variable definition:</p>
<ul>
<li><span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">pre_order_walk</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">VarDefAST</span><span style="color:#949CBB">)</span></span></code></span>: We check if a variable named <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">var</span></span></code></span> that we want to define has already been
defined or not.
If it has, then we query the location that previously defined <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">var</span></span></code></span> via <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">symbol_to_loc</span><span style="color:#949CBB">[</span><span style="color:#C6D0F5">var</span><span style="color:#949CBB">]</span></span></code></span> and <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">add_error</span><span style="color:#949CBB">()</span></span></code></span> both
the previous location and the current <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">VarDefAST</span></span></code></span>'s location.</li>
<li><span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">post_order_walk</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">VarDefAST</span><span style="color:#949CBB">)</span></span></code></span>: Do nothing.</li>
</ul>
<p>Since <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">PrototypeAST</span></span></code></span>, the definition of a <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">FunctionAST</span></span></code></span>, contains a vector of variable declaration, we apply the same
procedure that we have for <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">VarDefAST</span></span></code></span> on <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">PrototypeAST</span></span></code></span>.</p>
<ul>
<li><span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">pre_order_walk</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">PrototypeAST</span><span style="color:#949CBB">)</span></span></code></span> : Same as <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">pre_order_walk</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">VarDefAST</span><span style="color:#949CBB">)</span></span></code></span> for its vector of variable declaration.</li>
<li><span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#8CAAEE;font-style:italic">post_order_walk</span><span style="color:#949CBB">(</span><span style="color:#C6D0F5">PrototypeAST</span><span style="color:#949CBB">)</span></span></code></span>: Do nothing.</li>
</ul>
<h3 id="result"><a aria-hidden="true" tabindex="-1" href="#result"><span class="icon icon-link"></span></a>Result</h3>
<p>Yayyy! Now, if we call the scope checking visitor and let it recursively visit down to each function and
consequently to each variable definition, we'll get something like this to the terminal for the following program.</p>
<pre><code># this is a function
fn f(x : f64) {
    # Use `let{:cpp}` keyword
    let x = 0;
    3 + 1;
    x + 2;
    x - 2;
    x = 2;
}

</code></pre>
<p><img src="/blogs/what_after_kalei_location_debug/scopecheck_error.png" alt="scope_check_demo"></p>
<h2 id="whats-next"><a aria-hidden="true" tabindex="-1" href="#whats-next"><span class="icon icon-link"></span></a>What's next?</h2>
<p>That's it from me for now!</p>
<p>Implementing diagnostics for my compiler was really fun. I knew that being able to abstract and reuse code is a
crucial aspect of software engineering, and showcasing this in an actual project is a big deal for me. Different
stages in a compiler needing diagnostics mean that unless I reuse code, repetitive concepts will keep popping up.</p>
<p>There are still features to be desired and to be implemented. One of them is chaining diagnostic locations: figuring
out a clean way to chain together multiple diagnostic would be really helpful for programmers. Another one is
propagating the location info down to LLVM's codegen stage:
this means that we need to somehow conform the <span class="shiki catppuccin-frappe" style="background-color:#303446;color:#c6d0f5" tabindex="0"><code><span class="line"><span style="color:#C6D0F5">Location</span></span></code></span> class to LLVM's debugging location info class.
Interested readers can read about the write up <a href="https://llvm.org/docs/SourceLevelDebugging.html" rel="nofollow" target="_blank">here</a></p>
<p>After this quick demonstration, hopefully I have motivated you to now implement features like detecting the <em>use of
not-yet-defined
variables</em> and <em>use of not-yet-defined functions</em>.</p>
<p>I hope you enjoyed the blog! (And the music recommendations as well—heheh.)</p>6:["$","div",null,{"className":"py-12 flex flex-col items-center  justify-items-start mx-auto ","children":[["$","$L2",null,{"href":"/blog","className":"flex justify-center text-4xl","children":["$","h2",null,{"children":"My blog"}]}],["$","article",null,{"className":"p-8 prose pt-0.5 max-w-none w-full lg:w-1/2 md:w-4/6 sm:w-5/6 prose-sky mx-auto","children":[["$","div",null,{"className":"flex justify-center text-2xl font-bold ","children":["$","h2",null,{"children":"What after Kaleidoscope: Error location"}]}],["$","div",null,{"className":"flex justify-start text-xl font-bold underline","children":["$","h4",null,{"children":"2025-02-27"}]}],["$","div",null,{"dangerouslySetInnerHTML":{"__html":"$e"}}]]}]]}]
a:[["$","meta","0",{"charSet":"utf-8"}],["$","title","1",{"children":"What after Kaleidoscope: Error location"}],["$","meta","2",{"name":"description","content":"Jasmine discusses a simple error/warn/log method after Kaleidoscope."}],["$","link","3",{"rel":"icon","href":"/_next/static/media/pfp5.0daa0f7d.jpeg"}]]
8:null
